(()=>{var B=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var T=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var ee=T((Yi,St)=>{var{storage:ot}=B("uxp"),k=ot.localFileSystem;async function ho(){return k.getTemporaryFolder()}async function Eo(){return k.getDataFolder()}async function bo(e){return k.createSessionToken(e)}async function vo(e){return k.getFileForSaving(e)}async function _o(){return k.getFolder()}async function Io(e){return k.getEntryWithUrl(e)}async function xo(e){return k.getFileForOpening(e)}async function Mo(e,t){try{let o=await(await k.getEntryWithUrl(`file:${e}`)).getEntries(),r=[];for(let a of o)if(a.isFile){let i=a.name.slice(a.name.lastIndexOf(".")).toLowerCase();t.includes(i)&&r.push(a.name)}return r}catch(n){throw console.error(n),new Error(`\u83B7\u53D6\u6587\u4EF6\u5939\u5185\u56FE\u7247\u65F6\u51FA\u9519:${e}`)}}async function Ao(e,t){try{let o=await(await k.getEntryWithUrl(`file:${e}`)).getEntries(),r=[];for(let a of o){let i=a.name.slice(a.name.lastIndexOf(".")).toLowerCase();if(a.isFile&&t.includes(i))return!0}return!1}catch{return!1}}async function Co(e){let t;try{t=await k.getEntryWithUrl(e)}catch{try{await k.createEntryWithUrl(e,{type:"folder"})}catch(o){throw console.log(o),new Error(`\u521B\u5EFA\u76EE\u5F55\u5931\u8D25${e}`)}}try{if(t=await k.getEntryWithUrl(e),t.isFolder)return t;throw new Error(`\u76EE\u5F55\u4E0D\u6B63\u786E${e}`)}catch{throw new Error(`\u76EE\u5F55\u4E0D\u6B63\u786E${e}`)}}async function To(e){try{return!!(await k.getEntryWithUrl(e)).isFile}catch{return!1}}function Lo(e,...t){let n=e.includes("/")?"/":"\\",o=e;(o.endsWith("/")||o.endsWith("\\"))&&(o=o.slice(0,-1));for(let r of t)(r.startsWith("/")||r.startsWith("\\"))&&(r=r.slice(1)),o+=`${n}${r}`;return o}async function So(e){return e.read({format:ot.formats.binary})}async function Po(e,t){return e.write(t,{format:ot.formats.binary})}async function Bo(e){let t=await k.getEntryWithUrl(e),n=await t.read(),o=JSON.parse(n);return[t,o]}async function Do(e,t){let n=await k.createEntryWithUrl(e,{overwrite:!0});return Lt(n,t),n}async function Lt(e,t){await e.write(JSON.stringify(t,null,2))}St.exports={getTemporaryFolder:ho,getDataFolder:Eo,createSessionToken:bo,getFileForSaving:vo,getFileForOpening:xo,getFolder:_o,getEntryWithUrl:Io,getImageFileNamesFromFolder:Mo,getFolderWithCreate:Co,fileExists:To,joinPath:Lo,hasImageFile:Ao,readArrayBuffer:So,writeArrayBuffer:Po,writeJsonFile:Lt,readJsonFile:Bo,createJsonFile:Do}});var O=T(_=>{"use strict";_.TEMP_CHANNEL_NAME="JinnSelectionChannel";_.INPUTIMAGE="INPUTIMAGE";_.INPUTIMAGEMASK="INPUTIMAGEMASK";_.INPUTMASK="INPUTMASK";_.SEED="SEED";_.PROMPTTEXT="PROMPTTEXT";_.TEXTFIELD="TEXTFIELD";_.SLIDER="SLIDER";_.FIELDENUM="FIELDENUM";_.TEXT="TEXT";_.SETAILAYERCLOSE="close";_.SETAILAYERDEL="del";_.SETAILAYEROMIT="omit";_.DEFAULT_COMFYUI_URL="http://127.0.0.1:8188";_.OUTPUT_ZOOM="OUTPUT_ZOOM";_.OUTPUT_NOZOOM="OUTPUT_NOZOOM";_.PROMPTMODE_COMMON="COMMON";_.PROMPTMODE_BATCH="BATCH";_.PROMPTMODE_LIVE="LIVE";_.MINETYPES={".jpg":"image/jpeg",".jpeg":"image/jpeg",".png":"image/png",".bmp":"image/bmp",".gif":"image/gif",".webp":"image/webp"};_.VALID_IMAGE_EXTENSIONS=[".jpg",".jpeg",".png",".gif",".bmp",".webp"];_.BATCH_TASK_FILE_NAME="task.json";_.BATCH_OUTPUT_FILE_NAME="output.json";_.LIVE_ACTIVE_PS_TOOLS=["Pencil","Brush Tool","Color Replacement Tool","Mixer Brush","Eraser","Background Eraser","Magic Eraser","Dodge Tool","Burn Tool","Sponge Tool"]});var K=T((Zi,kt)=>{"use strict";var Ji=O(),h=null;function Bt(){let e=new Date().toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"}),t=Math.round(new Date().getMilliseconds());return`${e}.${t}`}function ko(e,t,n,o){let r=h.querySelector(`[data-node-id="${t}"]`);if(r){r.value=o,r.max=n;return}r=rt("sp-progressbar"),r.style.margin="5 0px",r.setAttribute("data-node-id",t),r.value=o,r.max=n,window.config.showDetailLog,h.appendChild(r),h.scrollTop=h.scrollHeight}function rt(e,t,n=!1){let o=null;return window.config.showDetailLog||h.children.length===0?o=document.createElement(e):h.children.length>0&&(h.children[h.children.length-1].style.display="none",o=document.createElement(e)),o.addEventListener("click",jo),o.setAttribute("size","s"),o.style.width="100%",o}function at(e){let t=rt("div");if(window.config.showDetailLog){let n=Bt();t.textContent=`${n} ${e}`}else t.textContent=e;h.appendChild(t),h.childNodes.length>30&&h.removeChild(h.firstChild),h.scrollTop=h.scrollHeight}function Pt(e){let t=rt("div");if(window.config.showDetailLog){let n=Bt();t.textContent=`${n} ${e}`}else t.textContent=e;t.style.color="#ff5555",h.appendChild(t),h.childNodes.length>30&&h.removeChild(h.firstChild),h.scrollTop=h.scrollHeight}var Oo=(...e)=>{at(e.join(" ")),window.config.showDetailLog&&console.log(...e)},Uo=(...e)=>{at(e.join(" ")),window.config.showDetailLog&&console.log(...e)},$o=(...e)=>{e&&e[0]instanceof Error?Pt(e[0].message):Pt(e.join(" ")),window.config.showDetailLog&&console.error(...e)},No=(e,t,n,o)=>{ko(e,t,n,o)};async function Fo(){document.getElementById("logArea").innerHTML=""}async function qo(){let e=document.getElementById("logArea");try{let t=Array.from(e.childNodes).map(n=>n.textContent).join(`\r
`);navigator.clipboard.write({"text/plain":t})}catch(t){at(`Copy failed: ${t.message}`)}}function Dt(e){window.config.showDetailLog=e,window.saveConfig(),window.config.showDetailLog?(h.className="logArea-normal",document.getElementById("logtoolbar").style.display="flex",Array.from(h.children).forEach(t=>{t.style.display="block"}),h.scrollTop=h.scrollHeight):(document.getElementById("logtoolbar").style.display="none",h.className="logArea-single",Array.from(h.children).forEach(t=>{t.style.display="none"}),h.children.length>0&&(h.children[h.children.length-1].style.display="block"))}function jo(){Dt(!window.config.showDetailLog)}function Ro(){Dt(!1)}var Ho;function Wo(){h=document.getElementById("logArea"),Ho=document.getElementById("logtoolbar"),document.getElementById("btnCopyLog").addEventListener("click",qo),document.addEventListener("wfChangeLogSimpleEvent",Ro)}kt.exports={clearLog:Fo,initPanel:Wo,log:Oo,warn:Uo,error:$o,progress:No}});var se=T((ts,qt)=>{"use strict";var D=B("photoshop"),{storage:Qi}=B("uxp"),es=B("photoshop").imaging,be=K(),fe=O(),Be=ee();async function zo(e,t){let o=await(await Be.getTemporaryFolder()).createFile(t,{overwrite:!0}),r=new Uint8Array(e);return await o.write(r),o}async function Ut(e,t,n){e&&await D.core.executeAsModal(async o=>{e.layers.forEach(async r=>{r.name===t&&!it(r,n)&&r.delete()})})}async function Ko(e){e&&await D.core.executeAsModal(async t=>{e.layers.forEach(async n=>{n.delete()})})}function it(e,t){return e&&t&&e._id===t._id&&e._docId===t._docId}async function st(e){await V({_obj:"select",_target:[{_ref:"document",_id:e}]})}function Vo(e,t,n,o){let r=Nt(e),a=r.width,i=r.height,s=Ft(t);if(n>=a||o>=i)return-1;if(window.config.outputZoom===fe.OUTPUT_ZOOM){if(s.width===a||s.height===i)return[-1,-1];let c=s.width/s.height,u=a/i;return c>u?100*i/s.height:100*a/s.width}else return n===s.width||o===s.height?[-1,-1]:100*n/s.width}async function Go(e,t,n,o,r){await st(e.id);let a=await $t(e.id);a&&(Ot(e,fe.TEMP_CHANNEL_NAME)&&(await V({_obj:"select",_target:[{_name:fe.TEMP_CHANNEL_NAME,_ref:"channel"}]}),await V({_obj:"delete",_target:[{_enum:"ordinal",_ref:"channel",_value:"targetEnum"}]})),await V({_obj:"duplicate",_target:[{_property:"selection",_ref:"channel"}],name:fe.TEMP_CHANNEL_NAME}),await V({_obj:"set",_target:[{_property:"selection",_ref:"channel"}],to:{_enum:"ordinal",_value:"none"}}));let i=e.activeLayers[0],c={_obj:"placeEvent",null:{_path:await Be.createSessionToken(t),_kind:"local"},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}};await V([c,{_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:n}}]);let l=e.activeLayers[0];if(it(i,l))throw new Error("\u521B\u5EFA\u65B0\u56FE\u5C42\u5931\u8D25");let d=Vo(e,l,parseInt(o),parseInt(r));if(d>0&&await V({_obj:"transform",_target:[{_ref:"layer",_enum:"ordinal",_value:"targetEnum"}],freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSCanvas"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}},width:{_unit:"percentUnit",_value:d},height:{_unit:"percentUnit",_value:d},linked:!0}),a&&Ot(e,"JinnSelectionChannel")){let p=[{_obj:"select",_target:[{_name:fe.TEMP_CHANNEL_NAME,_ref:"channel"}]},{_obj:"set",_target:[{_property:"selection",_ref:"channel"}],to:{_enum:"ordinal",_ref:"channel",_value:"targetEnum"}},{_obj:"delete",_target:[{_enum:"ordinal",_ref:"channel",_value:"targetEnum"}]}];await V(p)}return l}async function Yo(e,t){let o=await(await Be.getTemporaryFolder()).createFile(t,{overwrite:!0});be.warn(o.nativePath);let r={compression:6,interlaced:!1,embedColorProfile:!0};if(await e.saveAs.png(o,{compression:6}),Be.readArrayBuffer(o).byteLength<=0)throw new Error("arrayBuffer\u4E3A\u7A7A");return o}async function Xo(e,t){if(window.config.setAILayer===fe.SETAILAYERCLOSE)try{let n=je(e);if(!n)throw new Error(`\u6CA1\u6709\u627E\u5230\u6307\u5B9A\u7684\u6587\u6863,docid=${e}`);await D.core.executeAsModal(async o=>{n.layers.forEach(async r=>{r.name===t&&(r.visible=!1)})})}catch(n){be.error(n)}else if(window.config.setAILayer===fe.SETAILAYERDEL)try{let n=je(e);if(!n)throw new Error(`\u6CA1\u6709\u627E\u5230\u6307\u5B9A\u7684\u6587\u6863,docid=${e}`);be.log(`\u5220\u9664\u6240\u6709"${t}"\u56FE\u5C42`),await Ut(n,t,null)}catch(n){be.error(n)}}function je(e){if(e===-1)return D.app.activeDocument;for(let t of D.app.documents)if(t.id===e)return t}async function Jo(e,t,n){let o=je(e);if(!o)throw new Error(`\u6CA1\u6709\u627E\u5230\u6307\u5B9A\u7684\u6587\u6863,docid=${e}`);return await D.core.executeAsModal(async r=>{try{return await Yo(o,t)}catch(a){throw be.error(a),new Error("\u5904\u7406PS\u56FE\u50CF\u65F6\u51FA\u9519")}})}async function $t(){try{let e=await D.action.batchPlay([{_obj:"get",_target:[{_property:"selection"},{_ref:"document",_enum:"ordinal",_value:"targetEnum"}]}],{});return e[0].selection&&e[0].selection.bottom?!0:null}catch(e){return console.error(e),null}}async function Zo(e,t){let n=e.selection,o=await e.createLayer({name:"AIMask",opacity:100,mode:"normal"}),r={_obj:"fill",using:{_enum:"fillContents",_value:"white"},opacity:{_unit:"percentUnit",_value:100},mode:{_enum:"blendMode",_value:"normal"}},a={_obj:"inverse"},i={_obj:"fill",using:{_enum:"fillContents",_value:"black"},opacity:{_unit:"percentUnit",_value:100},mode:{_enum:"blendMode",_value:"normal"}},c=await(await Be.getTemporaryFolder()).createFile(t,{overwrite:!0});return await V([r,a,i]),await e.saveAs.jpg(c,{quality:12}),await o.delete(),await V({_obj:"inverse"}),c}async function Qo(e,t){let n=je(e);if(await st(n.id),!await $t())throw new Error("\u6CA1\u6709\u627E\u5230\u6709\u6548\u9009\u533A\uFF01");if(!n)throw new Error(`\u6CA1\u6709\u627E\u5230\u6307\u5B9A\u7684\u6587\u6863,docid=${e}`);return await D.core.executeAsModal(async o=>{try{return await Zo(n,t)}catch(r){throw be.error(r),new Error("\u83B7\u53D6\u9009\u533A\u65F6\u51FA\u9519")}})}function er(e){if(Array.isArray(e),e.length,e.length>0&&e[0]&&e[0]._obj==="error")throw new Error(`\u6267\u884C\u51FA\u9519: ${e[0].message||"\u672A\u77E5\u9519\u8BEF"}`)}function Ot(e,t){let n=e.channels,o=n.length;for(let r=0;r<o;r++)try{let a=n[r];if(a&&a.name===t)return!0}catch{continue}return!1}async function V(e,t){if(Array.isArray(e)||(e=[e]),!e||e.length===0)throw new Error("\u672A\u63D0\u4F9B\u4EFB\u4F55\u547D\u4EE4");let n=await D.core.executeAsModal(async o=>{let r,a;try{return r=await D.action.batchPlay(e,{synchronousExecution:!0,modalBehavior:"execute"}),er(r),r}catch(i){throw console.error(i),r&&console.log(JSON.stringify(r,null,2)),console.log(JSON.stringify(e,null,2)),new Error("\u6267\u884C\u52A8\u4F5C\u51FA\u9519")}finally{}})}async function tr(){}async function nr(e="AI\u6587\u6863",t=512,n=512){let o=await D.core.executeAsModal(async r=>await D.app.documents.add({name:e,width:t,height:n,resolution:72,fill:"black"}));if(!o)throw new Error("\u521B\u5EFA\u65B0\u6587\u6863\u5931\u8D25");return o}function or(){let e=[],t=D.app.documents;return t&&t.length>0&&t.forEach(n=>{e.push({id:n.id,name:n.name})}),e}function Nt(e){let t=e.width,n=e.height;return{width:t,height:n}}function rr(){return D.app.documents.length>0}function Ft(e){let t=e.bounds,n=t.left,o=t.top,r=t.right,a=t.bottom,i=r-n,s=a-o,c=(r+n)/2,u=(a+o)/2;return{left:n,top:o,right:r,bottom:a,width:i,height:s,centerX:c,centerY:u}}function ar(e){D.action.addNotificationListener(["historyStateChanged"],e)}function ir(e){D.action.removeNotificationListener(["historyStateChanged"],e)}qt.exports={getDocuments:or,createDocument:nr,getDocumentSize:Nt,activateDocument:st,hasDocument:rr,createSelectionMask:Qo,preparePSImage:Xo,createPSImage:Jo,addLayerImage:Go,addChannel:tr,deleteAllLayers:Ko,deleteLayerByName:Ut,saveTempFile:zo,executeCommand:V,layerEqual:it,getLayerBounds:Ft,addNotificationListenerForHistory:ar,removeNotificationListenerForHistory:ir}});var ve=T((ns,Wt)=>{"use strict";async function sr(e,t){try{let n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`\u8BBF\u95EECOMFYUI\u51FA\u9519 ${e}  ${n.status} ${n.statusText}`);let o=await n.json();if("comfy_error"in o)throw new Error(`serverlog=${o.comfy_error}`);return o}catch(n){throw n.message&&n.message==="Network request failed"?new Error("\u7F51\u7EDC\u9519\u8BEF\uFF0C\u65E0\u6CD5\u8FDE\u63A5\u5230COMFYUI"):n}}async function cr(e,t){try{let n=e;if(t){let a=new URLSearchParams(t).toString();n=`${e}${e.includes("?")?"&":"?"}${a}`}let o=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}});if(!o.ok)throw new Error(`\u8BBF\u95EECOMFYUI\u51FA\u9519 ${n}  ${o.status} ${o.statusText}`);let r=await o.json();if("comfy_error"in r)throw new Error(`serverlog=${r.comfy_error}`);return r}catch(n){throw n.message&&n.message==="Network request failed"?new Error("\u7F51\u7EDC\u9519\u8BEF\uFF0C\u65E0\u6CD5\u8FDE\u63A5\u5230COMFYUI"):n}}function lr(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e==="x"?t:t&3|8;return n.toString(16)})}function ur(e){return new Promise(t=>setTimeout(t,e))}async function dr(e){try{let t=await fetch(e);if(!t.ok)throw new Error(`\u8BBF\u95EECOMFYUI\u51FA\u9519 ${e}  ${t.status} ${t.statusText}`);let n=t.headers.get("Content-Type");if(n&&n.includes("application/json")){let i=await t.json();throw new Error(`serverlog=${i.comfy_error}`)}let o=await t.arrayBuffer();if(o.byteLength<=0)throw new Error("arrayBuffer\u4E3A\u7A7A");let r=t.headers.get("X-Image-Width"),a=t.headers.get("X-Image-Height");return{arrayBuffer:o,width:r,height:a}}catch(t){throw t.message&&t.message==="Network request failed"?new Error("\u7F51\u7EDC\u9519\u8BEF\uFF0C\u65E0\u6CD5\u8FDE\u63A5\u5230COMFYUI"):t}}function Rt(e,t="userSettings"){wx.setStorage({key:t,data:e,success(n){},fail(n){console.error("\u672C\u5730\u6570\u636E\u4FDD\u5B58\u5931\u8D25",n)}})}function fr(e="userSettings"){try{return wx.getStorageSync(e)}catch(t){console.error("\u52A0\u8F7D\u672C\u5730\u6570\u636E\u5931\u8D25",t)}}function mr(e,t="userSettings"){let n=wx.getStorageSync(t);(n==null||n==="")&&(n=[]),n.length>=10&&n.shift(),n.push(e),Rt(n,t)}function pr(e){return e==null||e.trim()===""}function gr(e,t){return Math.floor(Math.random()*(t-e+1))+e}var Ht=e=>{let t=e.getFullYear(),n=e.getMonth()+1,o=e.getDate(),r=e.getHours(),a=e.getMinutes(),i=e.getSeconds();return`${[t,n,o].map(jt).join("/")} ${[r,a,i].map(jt).join(":")}`},jt=e=>(e=e.toString(),e[1]?e:`0${e}`),wr=()=>{let e=getCurrentPages();return e[e.length-1].route},yr=()=>Ht(new Date);function hr(e){try{let t=e.lastIndexOf(".");if(t===-1)return[e,""];let n=e.substring(0,t),o=e.substring(t).toLowerCase();return[n,o]}catch(t){throw console.error("\u63D0\u53D6\u6587\u4EF6\u540D\u548C\u6269\u5C55\u540D\u5931\u8D25:",t),t}}function Er(){let e=new Date().toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"}),t=Math.round(new Date().getMilliseconds()/100);return`${e}`}Wt.exports={post:sr,get:cr,generateUUID:lr,downloadImage:dr,randInt:gr,getLocal:fr,setLocal:Rt,appendLocal:mr,formatTime:Ht,now:yr,getCurrPageRoute:wr,isEmpty:pr,sleep:ur,extractFileNameAndExtension:hr,getCurrentTime:Er}});var Y=T((rs,Kt)=>{"use strict";var os=se(),M=ve(),ce=K(),te=O();async function br(e){return await M.get(`${window.config.comfyuiURL}/models/checkpoints`)}async function vr(e){return await M.get(`${e}/system_stats`)}async function _r(e){try{let t=await M.get(`${e}/jinn_test`);return!0}catch{return!1}}async function Ir(){return await M.get(`${window.config.comfyuiURL}/jinn_get_wf_api_run`)}async function xr(e){return await M.get(`${window.config.comfyuiURL}/jinn_get_wf_params/${e}`)}async function Mr(e){return await M.get(`${window.config.comfyuiURL}/jinn_get_wf_api/${e}`)}async function Ar(){return(await M.get(`${window.config.comfyuiURL}/jinn_get_workflows`)).items}async function Cr(){return await M.get(`${window.config.comfyuiURL}/jinn_get_workflows_recover`)}async function Tr(e){let t=await M.post(`${window.config.comfyuiURL}/jinn_workflows_recover`,{wfname:e})}async function Lr(e){let t=await M.post(`${window.config.comfyuiURL}/jinn_save_wf_new_run`,e)}async function Sr(e){let t=await M.post(`${window.config.comfyuiURL}/jinn_save_wf_edit`,e)}async function Pr(e){let t=await M.post(`${window.config.comfyuiURL}/jinn_save_wf_del`,e)}async function Br(){let e={},t=await M.post(`${window.config.comfyuiURL}/jinn_interrupt`,e)}async function Dr(e){let t={preview:e},n=await M.post(`${window.config.comfyuiURL}/jinn_set_output_preview`,t)}var Re=class extends Error{constructor(t,n){super(t),this.name=this.constructor.name,this.needinfo=n}};async function kr(e){let t=await M.post(`${window.config.comfyuiURL}/jinn_registry_user`,{user_id:e})}async function Or(e,t,n,o,r,a,i,s=null){s!==!1&&ce.log("\u6B63\u5728\u8BF7\u6C42COFMYUI.");let c=M.generateUUID(),u={client_id:c,wfname:e,params:t,debug:o},l=await M.post(`${window.config.comfyuiURL}/jinn_prompt_byid`,u);if(l.verify===!1)throw new Re(l.message,l.needinfo);l.verify_message&&(ce.error(l.verify_message),alert(l.verify_message));let d=l.prompt_id;return s!==!1&&ce.log("\u6B63\u5728\u751F\u6210\u56FE\u7247."),await Nr(c,d,n,i,s),s!==!1&&ce.log("\u6B63\u5728\u4E0B\u8F7D\u56FE\u7247."),Ur(d,t.output.nodeid,r,a,s)}async function Ur(e,t,n,o,r){let a={prompt_id:e,nodeid:t},i=await M.post(`${window.config.comfyuiURL}/jinn_prompt_result_byid`,a),s=[],c=".jpg";for(let u of i){u.docwidth=o.width,u.docheight=o.height,u.zoom=window.config.outputZoom,c=u.filename.toLowerCase().endsWith(".png")?".png":".jpg";let l=new URLSearchParams(u),d=`${window.config.comfyuiURL}/jinn_view?${l.toString()}`;r!==!1&&ce.warn(d);let p=await M.downloadImage(d);s.push(p)}return[s,c]}async function $r(e){return(await M.get(`${window.config.comfyuiURL}/jinn_get_queue/${e}`)).queue_index}async function Nr(e,t,n,o,r){return new Promise((a,i)=>{let s=!1,c=y=>{try{clearTimeout(E),g.close()}catch{}i(new Error(y))},u=window.config.comfyuiURL.replace(/^https?:\/\//,""),d=`${window.config.comfyuiURL.toLowerCase().startsWith("http")?"ws":"wss"}://${u}/ws?clientId=${e}`,p=0,g=new WebSocket(d);g.onerror=function(y){c("WebSocket\u51FA\u9519")},g.onclose=function(y){y.wasClean||c("WebSocket\u610F\u5916\u5173\u95ED: "+y.reason)};let E=setTimeout(()=>{c("\u8D85\u65F6,\u8BF7\u67E5\u770BCOFMYUI\u662F\u5426\u5931\u53BB\u54CD\u5E94")},12e4);g.onmessage=async function(y){let x=y.data;if(typeof x=="string"){let f=JSON.parse(x);switch(f.type){case"executing":if(f.data&&f.data.node&&f.data.node in n){let z=n[f.data.node];z&&z._meta&&z._meta.title&&r!==!1&&ce.warn(`\u6B63\u5728\u6267\u884C${z._meta.title}(${f.data.node})`)}break;case"executed":break;case"execution_error":c("\u7B49\u5F85\u65F6\u51FA\u9519,\u8BF7\u67E5\u770BCOMFYUI\u65E5\u5FD7.");break;case"execution_interrupted":c("\u7528\u6237\u4E2D\u6B62\u751F\u56FE.");break;case"execution_success":s=!0;break;case"status":if(s===!0){clearTimeout(E),g.close(),a(!0);break}if(f.data.status.exec_info.queue_remaining==0){c("\u7531\u4E8E\u79CD\u5B50\u6570\u56FA\u5B9A\u7B49\u7CFB\u7EDF\u7F13\u5B58\u539F\u56E0\uFF0C\u5DE5\u4F5C\u6D41\u672A\u88AB\u6267\u884C.");break}let m=await $r(t);if(m<0){c(`${t}\u4E0D\u5728\u961F\u5217\u4E2D`);break}else m>0&&ce.log(`\u5F53\u524D\u6392\u961F\u7B2C${m+1}\u4F4D`);break;case"progress":let{value:b,max:S,node:C}=f.data,Q=n[C]._meta?n[C]._meta.title:n[C].class_type;S>1&&r!==!1&&ce.progress(Q,C,S,b);break;default:}}}})}async function Fr(e,t,n="psupload"){let o=new FormData;o.append("image",e,t),o.append("subfolder",n),o.append("filename",t);let r=await fetch(`${window.config.comfyuiURL}/jinn_upload_image_live`,{method:"POST",body:o});if(r.ok){let a=await r.json();return{path:`${a.subfolder}/${a.name}`,filename:a.name,subfolder:a.subfolder}}else throw new Error(`\u4E0A\u4F20\u56FE\u7247\u5931\u8D25  ${t},${r.status},${r.statusText}`)}async function qr(e,t,n=!1){let o="psupload",r=new FormData;r.append("image",e,t),r.append("subfolder",o),r.append("filename",t),n||(r.append("minsize",window.config.pszoomMinsize),r.append("maxsize",window.config.pszoomMaxsize));let a=await fetch(`${window.config.comfyuiURL}/jinn_upload_image`,{method:"POST",body:r});if(a.ok){let i=await a.json();return{path:`${i.subfolder}/${i.name}`,filename:i.name,subfolder:i.subfolder}}else throw new Error(`\u4E0A\u4F20\u56FE\u7247\u5931\u8D25  ${t},${a.status},${a.statusText}`)}async function jr(e,t,n,o="psupload"){let r=new FormData;r.append("image",e,t),r.append("maskfilename",t),r.append("maskfolder",o),r.append("imagefilename",n.filename),r.append("imagefolder",n.subfolder),r.append("minsize",window.config.pszoomMinsize),r.append("maxsize",window.config.pszoomMaxsize);let a=await fetch(`${window.config.comfyuiURL}/jinn_upload_mask`,{method:"POST",body:r});if(a.ok){let i=await a.json();return`${i.subfolder}/${i.name}`}else throw new Error(`\u4E0A\u4F20\u56FE\u7247\u5931\u8D25  ${t},${a.status},${a.statusText}`)}async function Rr(e){let t={text:e,appid:window.config.transBaiduAppID,appkey:window.config.transBaiduAppKey,from_lang:"zh",to_lang:"en"};return(await M.post(`${window.config.comfyuiURL}/jinn_translate`,t)).result}async function Hr(e){let t={text:e,appid:window.config.transBaiduAppID,appkey:window.config.transBaiduAppKey,from_lang:"en",to_lang:"zh"};return(await M.post(`${window.config.comfyuiURL}/jinn_translate`,t)).result}async function Wr(e,t){let n=await zt(e,t);try{return n[0]}catch{return[]}}async function zt(e,t){return await M.get(`${window.config.comfyuiURL}/jinn_get_wf_nodefield_info/${e}/${t}`)}var zr=new Map;async function Kr(e,t){let n=`${e},${t}`;try{let o=await zt(e,t),r=o[0],a=o.length>1?o[1]:{},i;if(t.toLowerCase()==="seed"?i=te.SEED:t.toLowerCase()==="image"||a.hasOwnProperty("image_upload")&&a.image_upload===!0||r==="IMAGE"?i=te.INPUTIMAGE:Array.isArray(r)?i=te.FIELDENUM:r==="INT"?a.hasOwnProperty("min")&&a.hasOwnProperty("max")&&t.toLowerCase()==="steps"?(a={min:1,max:20,step:1},i=te.SLIDER):i=te.TEXTFIELD:r==="FLOAT"?a.hasOwnProperty("min")&&a.hasOwnProperty("max")&&a.hasOwnProperty("step")&&(i=te.SLIDER):r==="STRING"&&a.hasOwnProperty("multiline")&&a.multiline===!0&&(i=te.PROMPTTEXT),i)return zr.set(n,i),[i,a]}catch(o){console.error("Error guessing field kind:",o)}return[null,null]}Kt.exports={VerifyError:Re,registry_user:kr,prompt:Or,uploadImage:qr,uploadMask:jr,load_checkpoints:br,get_wf_params:xr,get_workflows:Ar,test_comfyui:vr,test_comfyui_jinn:_r,get_wf_api:Mr,save_wf_new_run:Lr,save_wf_edit:Sr,save_wf_del:Pr,get_wf_api_run:Ir,get_workflows_recover:Cr,workflows_recover:Tr,interrupt:Br,setOutputPreview:Dr,translateToZH:Hr,translateToEN:Rr,get_wf_nodefield_enum:Wr,guessFieldKind:Kr,uploadImageLive:Fr}});var ze=T((as,Xt)=>{"use strict";var _e=Y(),le=se(),P=K(),{app:He}=B("photoshop"),De=O(),Vr=document.getElementById("wfButtonContainer"),Gr=document.getElementById("btnPrompt"),Yr=document.getElementById("logContainer"),Vt=document.getElementById("btnSettings"),Gt=document.getElementById("btnInterrupt"),Xr=document.getElementById("wfParamContainer"),Jr=document.getElementById("wfPreviewImage"),ct=document.getElementById("lSimpleLog"),Zr=document.getElementById("wfMainToolbar");function lt(e){Array.from(Vr.children).forEach(t=>{t.disabled=e}),Zr.querySelectorAll("*").forEach(t=>{t.disabled=e}),Gr.disabled=e,Vt.disabled=e,Vt.style.display=e?"none":"flex",Gt.disabled=!e,Gt.style.display=e?"flex":"none",Xr.querySelectorAll("*").forEach(t=>{t.hasAttribute("data-keep-disabled")||(t.disabled=e)}),ct.textContent="",e?ct.style.display=window.config.promptMode===De.PROMPTMODE_BATCH?"block":"none":ct.style.display="none"}function Qr(){ut=!1,window.showSingle(Yr),P.clearLog(),lt(!0)}function We(){ut=!1,lt(!1)}async function Yt(e,t,n){P.warn("\u6B63\u5728\u8BFB\u53D6PS\u56FE\u50CF");let o=n===0?"psimage.png":`psimage${n}.png`;await le.preparePSImage(t.docid,e);let r=await le.createPSImage(t.docid,o,e),a=await _e.uploadImage(r,o);return P.warn(a.path),t.value=a.path,a}async function ea(e,t,n){P.warn("\u6B63\u5728\u8BFB\u53D6PS\u9009\u533A");let o=t===0?"psmask.jpg":`psmask${t}.jpg`,r=t===0?"psmask.png":`psmask${t}.png`,a=await le.createSelectionMask(e.docid,o),i=await _e.uploadMask(a,r,n);return P.warn(i),e.value=i,i}async function ta(e,t){P.warn("\u6B63\u5728\u8BFB\u53D6PS\u9009\u533A\u4F5C\u4E3A\u56FE\u50CF");let n=t===0?"psimagemask.jpg":`psimagemask${t}.jpg`,o=await le.createSelectionMask(e.docid,n),r=await _e.uploadImage(o,n);return P.warn(r.path),e.value=r.path,r}function na(e){let t=new Image;t.src=e,Jr.src=t.src}async function oa(e,t,n){if(Qr(),t.inputtype===De.TEXT){try{He.activeDocument||await le.createDocument()}catch(o){P.error(o),We();return}await le.preparePSImage(He.activeDocument.id,e)}else try{if(!He.activeDocument){P.error("\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A\u6587\u6863\uFF01"),We();return}let o=t.params.filter(r=>r.kind===De.INPUTIMAGEMASK);for(let r=0;r<o.length;r++){let a=o[r],i=await Yt(e,a,r+1);await ea(a,r,i)}o=t.params.filter(r=>r.kind===De.INPUTIMAGE);for(let r=0;r<o.length;r++){let a=o[r];await Yt(e,a,r)}o=t.params.filter(r=>r.kind===De.INPUTMASK);for(let r=0;r<o.length;r++){let a=o[r];await ta(a,r)}}catch(o){P.error(o),We();return}try{let[o,r]=await _e.prompt(e,t,n,window.config.showDetailLog,window.config.outputZoom,{width:100,height:100},na);P.log("\u6B63\u5728\u5B58\u50A8AI\u56FE\u50CF\u6587\u4EF6");let a=[];for(let i=0;i<o.length;i++){let{arrayBuffer:s,width:c,height:u}=o[i],l=await le.saveTempFile(s,i===0?`cfimage${r}`:`cfimage${i+1}${r}`);P.warn(l.nativePath,`${c}*${u}`),a.push([l,c,u])}P.log("\u6B63\u5728\u6DFB\u52A0\u5230\u56FE\u5C42");for(let[i,s,c]of a)await le.addLayerImage(He.activeDocument,i,e,s,c);P.log("\u751F\u56FE\u6210\u529F")}catch(o){P.error(o),o instanceof _e.VerifyError&&document.dispatchEvent(new CustomEvent("verifyUserEvent",{detail:{error:o}}))}finally{We()}}var ut=!1;async function ra(){try{ut=!0,await _e.interrupt(),P.error("\u5C1D\u8BD5\u4E2D\u6B62\u751F\u56FE...")}catch(e){P.error(e)}}Xt.exports={prompt:oa,interruptPrompt:ra,DisabledUI:lt}});var en=T((us,Qt)=>{"use strict";var Jt=B("photoshop"),{storage:is}=B("uxp"),ss=B("photoshop").imaging,dt=K(),cs=O(),Zt=ee(),me=se();async function aa(e,t){try{await me.deleteLayerByName(e,t,null)}catch(n){dt.error(n)}}async function ia(e,t,n){return await Jt.core.executeAsModal(async o=>{try{let a=await(await Zt.getTemporaryFolder()).createFile(t,{overwrite:!0});return n&&dt.warn(a.nativePath),await e.saveAs.jpg(a,{quality:6}),a}catch(r){throw dt.error(r),new Error("\u5904\u7406PS\u56FE\u50CF\u65F6\u51FA\u9519")}})}function sa(e,t,n,o){let r=me.getDocumentSize(e),a=r.width,i=r.height,s=me.getLayerBounds(t),c=s.width>=s.height?n*100/s.width:o*100/s.height,u,l;return u=a*3/4,l=i/2,[c,u-s.centerX,l-s.centerY]}var{ElementPlacement:ls}=Jt.constants;async function ca(e,t,n,o,r){let a=e.activeLayers,i=a.length>0?a[0]:null,c={_obj:"placeEvent",null:{_path:await Zt.createSessionToken(t),_kind:"local"},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}},u={_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:n}};await me.executeCommand([c,u],e.id);let l=e.activeLayers[0];await me.deleteLayerByName(e,n,l);let[d,p,g]=sa(e,l,o,r);if(d>0){let E={_obj:"transform",_target:[{_ref:"layer",_enum:"ordinal",_value:"targetEnum"}],freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSCanvas"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:p},vertical:{_unit:"pixelsUnit",_value:g}},width:{_unit:"percentUnit",_value:d},height:{_unit:"percentUnit",_value:d}};await me.executeCommand(E,e.id)}try{if(i)try{let E={_obj:"select",_target:[{_ref:"layer",_id:i.id}],makeVisible:!1};await me.executeCommand(E,e.id)}catch{}}catch{}return l}Qt.exports={preparePSImageLive:aa,createPSImageLive:ia,addLayerImageLive:ca}});var cn=T((ds,sn)=>{"use strict";var ke=Y(),la=ve(),ft=se(),tn=en(),N=K(),{app:nn}=B("photoshop"),Ie=O(),ua=ze(),on=document.getElementById("btnInterrupt"),da=document.getElementById("wfButtonContainer"),fa=document.getElementById("btnPrompt"),ma=document.getElementById("logContainer"),rn=document.getElementById("btnSettings"),mt=document.getElementById("lSimpleLog");function pa(){pe=!1,window.showSingle(ma),N.clearLog(),console.clear();let e=!0;Array.from(da.children).forEach(t=>{t.disabled=e}),fa.disabled=e,rn.disabled=e,rn.style.display=e?"none":"flex",on.disabled=!e,on.style.display=e?"flex":"none",mt.textContent="",e?mt.style.display=window.config.promptMode===Ie.PROMPTMODE_BATCH?"block":"none":mt.style.display="none"}function an(){pe=!1,ua.DisabledUI(!1)}var pt=class{constructor(t,n,o){this.wfname=t,this.params=n,this.apidata=o;let r=n.params.filter(i=>i.kind===Ie.INPUTIMAGE);if(r.length!==1)throw new Error('\u6709\u4E14\u53EA\u80FD\u6709\u4E00\u4E2A"\u83B7\u53D6\u56FE\u7247"\u6761\u4EF6');this.param=r[0];let a=String(Math.round(new Date().getMilliseconds()));if(this.filename=`pslive${a}.jpg`,!nn.activeDocument)throw new Error("\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A\u6587\u6863\uFF01");this.doc=nn.activeDocument,this.docid=this.doc.id,this.outputWidth=-1,this.outputHeight=-1,this.firstLivePrompt=!0,this.docLastChangedTime=0,this.liveRunning=!1,this.sensitivity=window.config.livePromptSensitivity*1e3,this.inactivityTimer=null,ft.addNotificationListenerForHistory(this.linstener),this.promptLiveOne()}linstener=async(t,n)=>{if(n.documentID===this.docid&&!this.liveRunning){if(!Ie.LIVE_ACTIVE_PS_TOOLS.includes(n.name))return;clearTimeout(this.inactivityTimer),this.sensitivity===0?this.promptLiveOne():this.inactivityTimer=setTimeout(()=>{this.promptLiveOne()},this.sensitivity)}};promptLiveOne=async()=>{try{if(this.liveRunning=!0,pe)throw pe=!1,new Error("\u7528\u6237\u4E2D\u6B62\u751F\u56FE");N.log("\u5F00\u59CB\u751F\u56FE"),this.firstLivePrompt&&N.log("\u6B63\u5728\u8BFB\u53D6PS\u56FE\u50CF");let t=await tn.createPSImageLive(this.doc,this.filename,this.firstLivePrompt),n=await ke.uploadImageLive(t,this.filename);this.firstLivePrompt&&N.warn(n.path),this.param.value=n.path;let o=this.outputWidth===-1?Ie.OUTPUT_ZOOM:Ie.OUTPUT_NOZOOM,[r,a]=await ke.prompt(this.wfname,this.params,this.apidata,window.config.showDetailLog,o,{width:100,height:100},null,this.firstLivePrompt),{arrayBuffer:i,width:s,height:c}=r[0];this.outputWidth===-1&&(this.outputWidth=s,this.outputHeight=c),this.firstLivePrompt&&N.log("\u6B63\u5728\u5B58\u50A8AI\u56FE\u50CF\u6587\u4EF6");let u=await ft.saveTempFile(i,"cfimage.jpg");this.firstLivePrompt&&N.warn(u.nativePath,`${s}*${c}`),this.firstLivePrompt&&N.log("\u6B63\u5728\u6DFB\u52A0\u5230\u56FE\u5C42");let l=await tn.addLayerImageLive(this.doc,u,this.wfname,this.outputWidth,this.outputHeight);if(this.firstLivePrompt=!1,N.log(`${la.getCurrentTime()}\u751F\u56FE\u6210\u529F`),pe)throw pe=!1,new Error("\u7528\u6237\u4E2D\u6B62\u751F\u56FE")}catch(t){N.error(t),this.stopLive(),t instanceof ke.VerifyError&&document.dispatchEvent(new CustomEvent("verifyUserEvent",{detail:{error:t}}))}finally{this.liveRunning=!1}};stopLive=async()=>{try{ft.removeNotificationListenerForHistory(this.linstener)}catch(t){console.error(t)}an(),G=null};paramChanged=async(t,n,o,r)=>{let a=this.params.params.find(i=>i.nodeid===n&&i.field===o);if(a){if(a.value=r,t===Ie.PROMPTTEXT){let i=r;window.config.transEnable&&r&&(i=await ke.translateToEN(r)),a.valueen=i}this.liveRunning||this.promptLiveOne()}}},G;async function ga(e,t,n){try{pa(),G=new pt(e,t,n)}catch(o){N.error(o),G&&G.stopLive(),an()}}var pe=!1;async function wa(){try{if(G&&!G.liveRunning){G.stopLive(),N.error("\u7528\u6237\u4E2D\u6B62\u751F\u56FE");return}pe=!0,await ke.interrupt(),N.error("\u5C1D\u8BD5\u4E2D\u6B62\u751F\u56FE...")}catch(e){N.error(e)}}function ya(){try{let e=document.getElementById("wfBatchPromptHelpDialog");if(e){e.showModal();return}e=document.createElement("dialog"),e.id="wfBatchPromptHelpDialog",e.style.cssText="width: 800px;height: 500px;display: flex;flex-direction: column;";let t=document.createElement("div");t.style.cssText="max-width: 100%;max-height: 100%;overflow: auto;margin: 5px;gap: 5px;display: flex;flex-direction: column;";let n=document.createElement("sp-body");n.innerHTML=`\u5B9E\u65F6\u7ED8\u753B\uFF1A<br>
        \u53EA\u9488\u5BF9\u5F53\u524D\u6587\u6863\u64CD\u4F5C<br>
        \u5FC5\u987B\u6709\u4E00\u4E2A"\u83B7\u53D6\u56FE\u7247"\u6761\u4EF6<br>
        \u5728\u5F53\u524D\u6587\u6863\u7684\u5DE6\u534A\u533A\u57DF\u6D82\u9E26\u7ED8\u5236\u8349\u56FE\uFF0C\u5728\u5F53\u524D\u6587\u6863\u7684\u53F3\u534A\u533A\u57DF\u663E\u793A\u751F\u6210\u7684\u56FE\u7247<br>
        \u6BCF\u6B21\u53EA\u751F\u6210\u4E00\u5F20\u56FE\u7247(\u4E0D\u652F\u6301\u591A\u6279\u6B21)<br>
        \u751F\u56FE\u65F6\u4E0D\u8981\u53D8\u66F4\u5F53\u524D\u6587\u4EF6\uFF0C\u4E0D\u8981\u4FEE\u6539\u753B\u5E03\u5C3A\u5BF8<br>
        \u751F\u56FE\u7075\u654F\u5EA6:\u5047\u5982\u503C\u4E3A2,\u5219\u5F53\u505C\u6B62\u7ED8\u753B2\u79D2\u540E,\u5F00\u59CB\u7ED8\u5236\u4E00\u5F20AI\u56FE\u7247<br>
        \u53EA\u9488\u5BF9\u753B\u7B14\u5DE5\u5177\uFF08B\uFF09\uFF0C\u6A61\u76AE\u64E6\u5DE5\u5177\uFF08E\uFF09\u7B49\u5C11\u6570\u51E0\u79CD\u5DE5\u5177\u5B9E\u65F6\u751F\u56FE<br>
        \u5982\u679C\u4FEE\u6539\u753B\u5E03\u5185\u5BB9\u540E\u672A\u751F\u56FE\uFF0C\u53EF\u4EE5\u7528\u753B\u7B14\u5DE5\u5177\u968F\u610F\u753B\u4E00\u7B14<br>


        `,t.appendChild(n),e.appendChild(t),document.body.appendChild(e),e.showModal()}catch(e){N.error(e)}}function ha(e){try{let t=e.currentTarget.value;window.config.livePromptSensitivity=t,window.saveConfig(),G&&(G.sensitivity=parseInt(t*1e3))}catch(t){console.error(t)}}function Ea(e){try{if(G){let t=e.currentTarget.value,n=e.currentTarget.getAttribute("data-kind"),o=e.currentTarget.getAttribute("data-nodeid"),r=e.currentTarget.getAttribute("data-field");G.paramChanged(n,o,r,t)}}catch(t){console.error(t)}}sn.exports={interruptPrompt:wa,promptLive:ga,showHelp:ya,sensitivityChanged:ha,paramChanged:Ea}});var dn=T((gs,un)=>{"use strict";var xe=B("photoshop"),{storage:fs}=B("uxp"),ms=B("photoshop").imaging,ln=K(),ps=O(),ba=ee(),X=se();function va(e){switch(e){case 1:return[1024,512];case 2:return[1536,512];case 3:return[1024,1024]}}function _a(e,t,n,o){let r=X.getDocumentSize(e),a=r.width,i=r.height,s=X.getLayerBounds(t),c=s.width>=s.height?512*100/s.width:512*100/s.height,u,l;switch(n){case 1:u=256+512*o,l=256;break;case 2:u=256+512*o,l=256;break;case 3:let d=Math.floor(o/2),p=o%2;u=256+512*d,l=256+512*p;break}return[c,u-s.centerX,l-s.centerY]}async function Ia(e,t){try{await xe.core.executeAsModal(async n=>{e.layers.forEach(async o=>{o.name!=="\u80CC\u666F"&&o.delete()})})}catch(n){ln.error(n)}}async function xa(e,t,n,o,r){await X.activateDocument(e.id);let a=e.activeLayers[0],s={_obj:"placeEvent",null:{_path:await ba.createSessionToken(t),_kind:"local"},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}},c={_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:n}};await X.executeCommand([s,c]);let u=e.activeLayers[0];if(X.layerEqual(a,u))throw new Error("\u521B\u5EFA\u65B0\u56FE\u5C42\u5931\u8D25");let[l,d,p]=_a(e,u,o,r);if(l>0){let g={_obj:"transform",_target:[{_ref:"layer",_enum:"ordinal",_value:"targetEnum"}],freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSCanvas"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:d},vertical:{_unit:"pixelsUnit",_value:p}},width:{_unit:"percentUnit",_value:l},height:{_unit:"percentUnit",_value:l}};await X.executeCommand(g)}}async function Ma(e){try{ln.log("\u6B63\u5728\u6E05\u9664\u5386\u53F2\u8BB0\u5F55"),await X.activateDocument(e.id);let t={_obj:"clearEvent",_target:[{_property:"historyStates",_ref:"property"},{_enum:"ordinal",_ref:"document",_value:"targetEnum"}]};await X.executeCommand(t)}catch(t){console.error(t)}}async function Aa(e){let[t,n]=va(e);if(xe.app.activeDocument){let a=X.getDocumentSize(xe.app.activeDocument);if(t===a.width&&n===a.height)return xe.app.activeDocument}let o=await xe.core.executeAsModal(async a=>await xe.app.documents.add({name:"\u6279\u91CF\u751F\u56FE",width:t,height:n,resolution:72,fill:"black"}));if(!o)throw new Error("\u521B\u5EFA\u65B0\u6587\u6863\u5931\u8D25");let r={_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:"\u80CC\u666F"}};return await X.executeCommand(r),o}un.exports={createDocumentForBatch:Aa,preparePSImageBatch:Ia,addLayerImageBatch:xa,clearHistory:Ma}});var wn=T((xs,gn)=>{"use strict";var Ke=Y(),fn=ve(),Ca=se(),Oe=dn(),pn=ze(),A=ee(),H=K(),{app:ws}=B("photoshop"),W=O(),Ta=document.getElementById("lSimpleLog"),ys=document.getElementById("wfButtonContainer"),hs=document.getElementById("btnPrompt"),La=document.getElementById("logContainer"),Es=document.getElementById("btnSettings"),bs=document.getElementById("btnInterrupt"),vs=document.getElementById("wfParamContainer"),_s=document.getElementById("wfPreviewImage"),Is=document.getElementById("wfMainToolbar");function Sa(){Ue=!1,window.showSingle(La),H.clearLog(),console.clear(),pn.DisabledUI(!0)}function Pa(){Ue=!1,pn.DisabledUI(!1)}var gt=class{constructor(){}creatDoc=async()=>{this.outputDoc=await Oe.createDocumentForBatch(this.batchImageParams.length)};promptBatch=async(t,n,o,r)=>{Sa();try{this.batchImageParams=r;let a=A.joinPath(n.output.folderbatch,W.BATCH_TASK_FILE_NAME),[i,s]=await A.readJsonFile(a),c=A.joinPath(n.output.folderbatch,W.BATCH_OUTPUT_FILE_NAME),[u,l]=await A.readJsonFile(c),d=await A.getEntryWithUrl(`file:${n.output.folderbatch}`),p=r.find(y=>y.batchnamed===!0);p||(p=r[0]);let g=s[p.valuefolder],E=0;for(let y=l.output.length;y<g.length;y++){if(Ue)throw Ue=!1,new Error("\u7528\u6237\u4E2D\u6B62\u751F\u56FE");window.config.batchPromptPreview&&!this.outputDoc&&await this.creatDoc(),Ta.textContent=`${y+1}/${g.length}`;let x=g[y];H.log(`${y+1}/${g.length}`);let f=[];for(let m=0;m<r.length;m++){let b=r[m].valuefolder,S=s[b][y];if(S===void 0){H.error(`\u6587\u4EF6\u5939\u4E2D\u56FE\u7247\u6570\u91CF\u4E0D\u8DB3(${W.VALID_IMAGE_EXTENSIONS.join(" ")}):${b}`);return}let C=await A.getEntryWithUrl(A.joinPath(b,S));f.push(C)}await this.promptBatchOne(t,n,o,r,f,y,x,d,u,l),E>=2?document.dispatchEvent(new CustomEvent("wfChangeLogSimpleEvent",{detail:{}})):E+=1}}catch(a){H.error(a),a instanceof Ke.VerifyError&&document.dispatchEvent(new CustomEvent("verifyUserEvent",{detail:{error:a}}))}finally{Pa()}};promptBatchOne=async(t,n,o,r,a,i,s,c,u,l)=>{this.outputDoc&&await Oe.preparePSImageBatch(this.outputDoc,t);for(let f=0;f<r.length;f++){let m=a[f],b=await Ke.uploadImage(m,m.name,!0);H.warn(b.path),r[f].value=b.path,this.outputDoc&&await Oe.addLayerImageBatch(this.outputDoc,m,t,r.length,f)}let[d,p]=fn.extractFileNameAndExtension(s),[g,E]=await Ke.prompt(t,n,o,window.config.showDetailLog,W.OUTPUT_NOZOOM,{width:100,height:100},null);H.log("\u6B63\u5728\u5B58\u50A8\u6587\u4EF6");let y=[],x=[];for(let f=0;f<g.length;f++){let{arrayBuffer:m,width:b,height:S}=g[f],C=await Ca.saveTempFile(m,f===0?`cfimage${E}`:`cfimage${f+1}${E}`);H.warn(C.nativePath,`${b}*${S}`),y.push(C);let Q=f===0?`${d}${E}`:`${d}${f+1}${E}`,z=await c.createFile(Q,{overwrite:!0});await A.writeArrayBuffer(z,m),x.push(Q)}if(l.output.push(x),H.log("\u6B63\u5728\u6DFB\u52A0\u5230\u56FE\u5C42"),this.outputDoc)for(let f of y)await Oe.addLayerImageBatch(this.outputDoc,f,t,r.length,r.length);window.config.batchPromptPause>0&&(H.log(`\u7761\u7720${window.config.batchPromptPause}\u79D2`),await fn.sleep(window.config.batchPromptPause*1e3)),await A.writeJsonFile(u,l),this.outputDoc&&await Oe.clearHistory(this.outputDoc),H.log("\u751F\u56FE\u6210\u529F")}};async function Ba(e){let t=A.joinPath(e,W.BATCH_TASK_FILE_NAME);if(!await A.fileExists(t))return!1;let n=A.joinPath(e,W.BATCH_OUTPUT_FILE_NAME);if(!await A.fileExists(n))return!1;let[o,r]=await A.readJsonFile(n);return r.output.length>0}async function Da(e,t,n,o){let r=A.joinPath(t.output.folderbatch,W.BATCH_TASK_FILE_NAME),a={};for(let s=0;s<o.length;s++){let c=o[s].valuefolder,u=await A.getImageFileNamesFromFolder(c,W.VALID_IMAGE_EXTENSIONS);if(u.length===0)throw new Error(`\u6587\u4EF6\u5939\u4E2D\u6CA1\u6709\u6709\u6548\u7684\u56FE\u7247(${W.VALID_IMAGE_EXTENSIONS.join(" ")}):${c}`);a[c]=u}await A.createJsonFile(r,a);let i=A.joinPath(t.output.folderbatch,W.BATCH_OUTPUT_FILE_NAME);await A.createJsonFile(i,{output:[]})}async function ka(e,t,n,o){let r=A.joinPath(t.output.folderbatch,W.BATCH_TASK_FILE_NAME),[a,i]=await A.readJsonFile(r),s=A.joinPath(t.output.folderbatch,W.BATCH_OUTPUT_FILE_NAME),[c,u]=await A.readJsonFile(s);for(let l=0;l<o.length;l++){let d=o[l].valuefolder;if(!i.hasOwnProperty(d))throw new Error(`\u7B2C${l+1}\u4E2A\u6587\u4EF6\u5939\uFF0C${d},\u8BE5\u76EE\u5F55\u5728\u4EFB\u52A1\u6587\u4EF6\u4E2D\u4E0D\u5B58\u5728\uFF0C\u8BF7\u4FEE\u6539\u5DE5\u4F5C\u6D41\u6216\u91CD\u65B0\u9009\u62E9\u7A7A\u7684\u8F93\u51FA\u6587\u4EF6\u5939`);if(l===0&&i[d].length<=u.output.length)throw new Error(`\u8F93\u5165\u76EE\u5F55${d}\u4E2D\u6709${i[d].length}\u5F20\u56FE\u7247,\u5DF2\u751F\u6210${u.output.length}\u5F20\u7ED3\u679C\u56FE\u7247.\u5F53\u524D\u4EFB\u52A1\u5DF2\u7ECF\u5B8C\u7ED3.`)}}function Oa(){try{let e=document.getElementById("wfBatchPromptHelpDialog");if(e){e.showModal();return}e=document.createElement("dialog"),e.id="wfBatchPromptHelpDialog",e.style.cssText="width: 800px;height: 500px;display: flex;flex-direction: column;";let t=document.createElement("div");t.style.cssText="max-width: 100%;max-height: 100%;overflow: auto;margin: 5px;gap: 5px;display: flex;flex-direction: column;";let n=document.createElement("sp-body");n.innerHTML=`\u6279\u91CF\u751F\u56FE\uFF1A<br>
        \u53EF\u4EE5\u6307\u5B9A\u4E00\u81F3\u4E09\u4E2A\u8F93\u5165\u76EE\u5F55<br>
        \u53EF\u4EE5\u4E2D\u65AD\u540E\u7EE7\u7EED\u6267\u884C\u672A\u5B8C\u6210\u7684\u4EFB\u52A1<br>
        \u652F\u6301\u7684\u56FE\u7247\u7C7B\u578B\u5305\u62EC${W.VALID_IMAGE_EXTENSIONS.join(" ")}<br>
        \u751F\u6210\u7684\u56FE\u7247\u5C06\u4EE5\u7B2C\u4E00\u4E2A\u8F93\u5165\u6587\u4EF6\u5939\u4E2D\u7684\u56FE\u7247\u540D\u79F0\u6765\u547D\u540D<br>
        \u5F00\u59CB\u6279\u91CF\u751F\u56FE\u540E\uFF0C\u4E0D\u8981\u968F\u610F\u53D8\u66F4\u8F93\u5165\u6587\u4EF6\u5939\u53CA\u5176\u4E2D\u7684\u56FE\u7247\uFF0C\u4EE5\u514D\u53D1\u751F\u672A\u77E5\u9519\u8BEF<br>
        \u5F00\u59CB\u6279\u91CF\u751F\u56FE\u540E\uFF0C\u4E0D\u8981\u4FEE\u6539\u6216\u5220\u9664\u8F93\u51FA\u76EE\u5F55\u4E2D\u7684JSON\u6587\u4EF6\uFF0C\u4EE5\u514D\u53D1\u751F\u672A\u77E5\u9519\u8BEF<br>
        \u6279\u5904\u7406\u65F6\uFF0C\u4E0D\u4F1A\u7EA6\u675F\u56FE\u7247\u6587\u4EF6\u7684\u5927\u5C0F\uFF0C\u8BF7\u5728\u5DE5\u4F5C\u6D41\u4E2D\u8FDB\u884C\u9650\u5B9A\uFF0C\u4EE5\u514D\u7206\u663E\u5B58<br>
        `,t.appendChild(n),e.appendChild(t),document.body.appendChild(e),e.showModal()}catch(e){H.error(e)}}var mn;function Ua(e,t,n,o){mn=new gt,mn.promptBatch(e,t,n,o)}var Ue=!1;async function $a(){try{Ue=!0,await Ke.interrupt(),H.error("\u5C1D\u8BD5\u4E2D\u6B62\u751F\u56FE...")}catch(e){H.error(e)}}gn.exports={promptBatch:Ua,hasBatchTask:Ba,createBatchTask:Da,checkBatchTask:ka,showHelp:Oa,interruptPrompt:$a}});var _n=T((Ms,vn)=>{"use strict";var yt=ee(),ht=Y(),wt=O(),hn=se(),Na=K(),F=document.getElementById("wfParamContainer");function yn(e){e.innerHTML="";let t=hn.getDocuments();for(let n=0;n<t.length;n++){let o=document.createElement("sp-menu-item");o.textContent=t[n].name,o.setAttribute("value",t[n].id),n===0&&o.setAttribute("selected",!0),e.appendChild(o)}}function Me(e,t){let n=document.createElement("sp-action-button");return n.style.justifyContent="flex-end",n.setAttribute("quiet",!0),n.textContent=e,n.setAttribute("size","s"),n.addEventListener("click",t),n}function Fa(e){let t=e.currentTarget.value;try{hn.activateDocument(t)}catch(n){console.error(n)}}function ne(e){let t=document.createElement("sp-label");return t.textContent=`${e}:`,t.style.marginRight="5px",t.style.width="25%",t}function qa(e,t){let n=e.value,o=ue();F.appendChild(o);let r=ne(e.title);o.appendChild(r);let a=0,i=100,s=1;e.extra&&([a,i,s]=e.extra.split(","));let c=document.createElement("sp-slider");c.setAttribute("min",a),c.setAttribute("max",i),c.setAttribute("step",s),c.setAttribute("variant","filled"),c.setAttribute("gradient","true"),t&&c.addEventListener("change",t),c.style.padding="0px",c.style.flexGrow="1",c.value=n,o.appendChild(c);let u=document.createElement("sp-label");return u.style.justifyContent="flex-end",Number.isInteger(c.value)?u.textContent=`${c.value}`:u.textContent=`${c.value.toFixed(2)}`,u.style.padding="0px",c.addEventListener("change",l=>{Number.isInteger(c.value)?u.textContent=`${c.value}`:u.textContent=`${c.value.toFixed(2)}`}),o.appendChild(u),c}function ue(){let e=document.createElement("div");return e.style.justifyContent="space-between",e.style.display="flex",e.style.width="100%",e}function ja(e){let t=e.value,n=ne(e.title),o=ue();F.appendChild(o),o.appendChild(n);let r=document.createElement("sp-picker"),a=document.createElement("sp-menu");a.setAttribute("slot","options"),r.appendChild(a),yn(a),r.addEventListener("change",Fa),r.style.flexGrow="1",o.appendChild(r);let i=Me("\u{1F504}",s=>{let c=s.currentTarget.parentElement.querySelector('sp-menu[slot="options"]');yn(c)});return i.style.padding="0px",o.appendChild(i),r}function En(e){try{e.focus()}catch{}}function Ra(e){let t=e.output.folderbatch,n=ne("\u8F93\u51FA\u56FE\u50CF"),o=ue();F.appendChild(o),o.appendChild(n);let r=document.createElement("sp-textfield");r.value=t,r.setAttribute("data-output-batchfolder",!0),r.size="s",r.style.flexGrow="1",o.appendChild(r);let a=Me("",async i=>{let s=await yt.getFolder();if(s){let c=i.target.parentElement.querySelector("sp-textfield");c.value=s.nativePath,En(c)}});return a.innerHTML='<sp-icon name="ui:FolderBreadcrumb" size="s" slot="icon"></sp-icon>',a.style.padding="0px",o.appendChild(a),bn(),r}function Ha(e){let t=e.valuefolder,n=ue();F.appendChild(n);let o=ne(e.title);o.setAttribute("data-input-batch-label",!0),e.batchnamed&&(o.textContent=`${e.title}(*):`),n.appendChild(o),o.addEventListener("click",i=>{let s=i.currentTarget.parentElement.querySelector("sp-textfield");F.querySelectorAll("[data-input-batchfolder]").forEach(u=>{u.removeAttribute("data-batch-named");let l=u.getAttribute("data-title"),d=u.parentElement.querySelector("[data-input-batch-label]");d.textContent=`${l}:`});let c=s.getAttribute("data-title");s.setAttribute("data-batch-named",!0),i.currentTarget.textContent=`${c}(*):`});let r=document.createElement("sp-textfield");r.setAttribute("data-input-batchfolder",!0),r.value=t,r.style.flexGrow="1",n.appendChild(r);let a=Me("",async i=>{let s=await yt.getFolder();if(s){let c=i.target.parentElement.querySelector("sp-textfield");try{c.value=s.nativePath,En(c);let u=yt.joinPath(s.nativePath,"output"),l=F.querySelector("[data-output-batchfolder]");(!l.value||l.value==="")&&(l.value=u)}catch(u){console.log(u)}}});return a.innerHTML='<sp-icon name="ui:FolderBreadcrumb" size="s" slot="icon"></sp-icon>',a.style.padding="0px",n.appendChild(a),r}function Wa(e,t){let n=e.value,o=ne(e.title),r=document.createElement("div");r.style.flexDirection="column",r.style.display="flex",F.appendChild(r);let a=document.createElement("div");a.style.justifyContent="space-between",a.style.display="flex",a.appendChild(o);let i=document.createElement("div");i.style.justifyContent="flex-end",i.style.display="flex",a.appendChild(i);let s=Me("\u4E2D",async l=>{try{let d=l.currentTarget.parentElement.parentElement.parentElement.querySelector("sp-textarea"),p=d.value.trim();if(!p)return;let g=await ht.translateToZH(p);d.value=g}catch(d){throw console.error(d),alert(`\u7FFB\u8BD1\u65F6\u51FA\u9519${d}`),d}});i.appendChild(s),s.style.display=window.config.transEnable?"block":"none";let c=Me("EN",async l=>{try{let d=l.currentTarget.parentElement.parentElement.parentElement.querySelector("sp-textarea"),p=d.value.trim();if(!p)return;let g=await ht.translateToEN(p);d.value=g}catch(d){throw console.error(d),alert(`\u7FFB\u8BD1\u65F6\u51FA\u9519${d}`),d}});c.style.display=window.config.transEnable?"block":"none",i.appendChild(c),r.appendChild(a);let u=document.createElement("sp-textarea");return u.style.height=100,u.setAttribute("maxlength","1000"),u.value=n,r.appendChild(u),u.style.width="100%",t&&u.addEventListener("change",t),u}async function za(e,t){e.innerHTML="";let n=!1,o=await ht.get_wf_nodefield_enum(t.nodeclass,t.field);for(let r=0;r<o.length;r++){let a=document.createElement("sp-menu-item");a.textContent=o[r],o[r]===t.value&&(a.setAttribute("selected",!0),n=!0),e.appendChild(a)}!n&&o.length>0&&e.children[0].setAttribute("selected",!0)}function Ka(e,t){let n=e.value,o=ne(e.title),r=ue();F.appendChild(r),r.appendChild(o);let a=document.createElement("sp-picker"),i=document.createElement("sp-menu");return i.setAttribute("slot","options"),a.appendChild(i),za(i,e),a.style.flexGrow="1",t&&a.addEventListener("change",t),r.appendChild(a),a}function Va(e,t){let n=ue();F.appendChild(n);let o=e.value,r=ne(e.title);n.appendChild(r);let a=document.createElement("sp-textfield");return a.value=o,a.style.flexGrow="1",a.setAttribute("maxlength","100"),t&&a.addEventListener("change",t),n.appendChild(a),a}function Ga(){switch(window.config.promptMode){case wt.PROMPTMODE_COMMON:return"\u751F\u6210";case wt.PROMPTMODE_BATCH:return"\u6279\u91CF\u751F\u6210";case wt.PROMPTMODE_LIVE:return"\u5B9E\u65F6\u7ED8\u753B"}}function bn(){let e=document.createElement("sp-divider");e.style.marginTop="5px",e.style.marginBottom="5px",e.size="s",F.appendChild(e)}function Ya(e){let t=ue();F.appendChild(t);let n=ne("\u654F\u9510\u5EA6(\u79D2)");t.appendChild(n);let o=window.config.livePromptSensitivity,r=0,a=5,i=.1,s=document.createElement("sp-slider");s.setAttribute("min",r),s.setAttribute("max",a),s.setAttribute("step",i),s.setAttribute("variant","filled"),s.setAttribute("gradient","true"),s.style.flexGrow="1",s.style.padding="0px",s.value=o,s.addEventListener("change",e),t.appendChild(s);let c=document.createElement("sp-label");return c.style.justifyContent="flex-end",Number.isInteger(s.value)?c.textContent=`${s.value}`:c.textContent=`${s.value.toFixed(2)}`,c.style.padding="0px",s.addEventListener("change",u=>{Number.isInteger(s.value)?c.textContent=`${s.value}`:c.textContent=`${s.value.toFixed(2)}`}),t.appendChild(c),s}function Xa(){let e=ue();F.appendChild(e);let t=ne("\u751F\u56FE\u6682\u505C(\u79D2):");t.setAttribute("data-keep-disabled",!0),e.appendChild(t);let n=window.config.batchPromptPause,o=0,r=60,a=1,i=document.createElement("sp-slider");i.setAttribute("data-keep-disabled",!0),i.setAttribute("min",o),i.setAttribute("max",r),i.setAttribute("step",a),i.setAttribute("variant","filled"),i.setAttribute("gradient","true"),i.style.flexGrow="1",i.style.padding="0px",i.value=n,e.appendChild(i),i.style.width="60%",i.addEventListener("change",u=>{try{Number.isInteger(i.value)?s.textContent=`${i.value}`:s.textContent=`${i.value.toFixed(2)}`;let l=u.currentTarget.value;window.config.batchPromptPause=l,window.saveConfig()}catch(l){console.error(l)}});let s=document.createElement("sp-label");s.setAttribute("data-keep-disabled",!0),s.style.justifyContent="flex-end",Number.isInteger(i.value)?s.textContent=`${i.value}`:s.textContent=`${i.value.toFixed(2)}`,s.style.padding="0px";let c=Me("",u=>{});return c.textContent=window.config.batchPromptPreview?"\u{1F50D}":"---",c.setAttribute("quiet",!0),c.setAttribute("variant","secondary"),c.setAttribute("variant","overBackground"),c.style.padding="0px",c.setAttribute("data-keep-disabled",!0),c.addEventListener("click",()=>{window.config.batchPromptPreview=!window.config.batchPromptPreview,c.textContent=window.config.batchPromptPreview?"\u{1F50D}":"---",window.saveConfig(),Na.log(window.config.batchPromptPreview?"\u5F00\u542F\u9884\u89C8":"\u5173\u95ED\u9884\u89C8")}),e.appendChild(c),i}function Ja(e){let t=document.createElement("sp-body");t.style.width="100%",t.style.textAlign="center",t.textContent=e,F.appendChild(t)}function Za(e){let t=F.querySelector(`[data-nodeid="${e.nodeid}"][data-field="${e.field}"]`);return t||null}vn.exports={createParamPromptText:Wa,createParamSlider:qa,createParamImage:ja,createParamImageBatch:Ha,createParamOutputBatch:Ra,createParamFIELDENUM:Ka,createParamDefault:Va,getPromptModeLabel:Ga,createParamDivider:bn,createParamLiveSensitivity:Ya,createParamBatchPause:Xa,createWfTitle:Ja,getUIParamsInput:Za}});var On=T((As,kn)=>{"use strict";var Qa=ee(),we=Y(),Tn=ze(),$e=cn(),Ae=wn(),Ln=K(),U=_n(),ei=ve(),w=O(),Sn=document.getElementById("btnPrompt"),Ce=document.getElementById("wfButtonContainer"),Ge=document.getElementById("wfParamContainer"),In=document.getElementById("btnEditWorkflow"),xn=document.getElementById("lSimpleLog"),ti=document.getElementById("buttonContainer"),Pn=document.getElementById("wfMainToolbar"),ni=document.getElementById("btnInterrupt");function Ne(e){ti.querySelectorAll("*").forEach(t=>{t.disabled=e}),Pn.querySelectorAll("*").forEach(t=>{t.disabled=e}),Ge.querySelectorAll("*").forEach(t=>{t.hasAttribute("data-keep-disabled")||(t.disabled=e)}),Ce.style.display!=="none"&&Array.from(Ce.children).forEach(t=>{t.disabled=e})}function Ve(){Pn.querySelectorAll("*").forEach(t=>{t.disabled=!1}),Array.from(Ce.children).forEach(t=>{t.disabled=!1})}async function oi(e){try{let t=e.currentTarget,n=t.getAttribute("wfname");if(n===q)return;Array.from(Ce.children).forEach(o=>{o.setAttribute("quiet",!0),o.setAttribute("variant","secondary")}),t.removeAttribute("quiet"),t.setAttribute("variant","overBackground"),await Bn(n)}catch(t){throw console.error(t),alert(`\u52A0\u8F7D\u5DE5\u4F5C\u6D41\u65F6\u51FA\u9519:${t}`),t}}function Et(e,t){let n=null;switch(e.kind){case w.PROMPTTEXT:n=U.createParamPromptText(e,t);break;case w.SLIDER:n=U.createParamSlider(e,t);break;case w.INPUTIMAGE:switch(window.config.promptMode){case w.PROMPTMODE_BATCH:n=U.createParamImageBatch(e);break;default:n=U.createParamImage(e)}break;case w.INPUTIMAGEMASK:n=U.createParamImage(e);break;case w.INPUTMASK:n=U.createParamImage(e);break;case w.FIELDENUM:n=U.createParamFIELDENUM(e,t);break;default:n=U.createParamDefault(e,t)}n.setAttribute("data-kind",e.kind),n.setAttribute("data-nodeid",e.nodeid),n.setAttribute("data-field",e.field),n.setAttribute("data-title",e.title),n.size="s",U.createParamDivider()}async function Mn(e){try{await Dn(e.newwfname),Ge.innerHTML="",xn.textContent="",xn.style.display="none",U.createWfTitle(q),L.params.forEach(t=>{t.visible?window.config.promptMode===w.PROMPTMODE_LIVE?Et(t,$e.paramChanged):Et(t):window.config.promptMode===w.PROMPTMODE_BATCH&&t.kind===w.INPUTIMAGE&&Et(t)}),window.config.promptMode===w.PROMPTMODE_BATCH?(U.createParamOutputBatch(L),U.createParamBatchPause()):window.config.promptMode===w.PROMPTMODE_LIVE&&U.createParamLiveSensitivity($e.sensitivityChanged),localStorage.setItem("lastWorkflow",q),Ln.clearLog(),window.showSingle(document.getElementById("logContainer")),Ne(!1)}catch(t){throw Ne(!0),Ve(),t}}async function Bn(e){if(!e)return;if(await we.test_comfyui_jinn(window.config.comfyuiURL)===!0){await Mn({newwfname:e});return}Ne(!0);let n=new CustomEvent("comfyuiConnectEvent",{detail:{data:{newwfname:e},callback:Mn}});document.dispatchEvent(n)}async function bt(){L.inputtype=w.TEXT;let e=[],t=new Set;for(let n of L.params){n.kind===w.INPUTIMAGE&&L.inputtype!==w.INPUTIMAGEMASK?L.inputtype=w.INPUTIMAGE:n.kind===w.INPUTIMAGEMASK&&(L.inputtype=w.INPUTIMAGEMASK);let o=null,r=U.getUIParamsInput(n);switch(r&&(o=r.value),n.kind){case w.SEED:o=o??ei.randInt(1,1e6),n.value=o;break;case w.PROMPTTEXT:o=o??n.value,n.value=o;let a=o;window.config.transEnable&&o&&(a=await we.translateToEN(o)),n.valueen=a;break;case w.INPUTIMAGE:if(window.config.promptMode===w.PROMPTMODE_BATCH){if(!o||o.trim()==="")throw new Error(`${n.title}:\u6CA1\u6709\u6307\u5B9A\u76EE\u5F55`);if(t.has(o))throw new Error(`"${n.title}":\u5176\u5B83\u6761\u4EF6\u5DF2\u7ECF\u6307\u5B9A\u4E86\u8BE5\u76EE\u5F55`);t.add(o),n.valuefolder=o,r&&r.hasAttribute("data-batch-named")?n.batchnamed=!0:n.batchnamed=!1,e.push(n)}else o=o??-1,n.docid=o;break;case w.INPUTIMAGEMASK:if(window.config.promptMode===w.PROMPTMODE_BATCH)throw new Error(`"${n.title}":\u6279\u91CF\u751F\u56FE\u4E0D\u652F\u6301\u56FE\u7247\u8499\u677F\u6761\u4EF6\u3002`);o=o??-1,n.docid=o;break;case w.INPUTMASK:if(window.config.promptMode===w.PROMPTMODE_BATCH)throw new Error(`"${n.title}":\u6279\u91CF\u751F\u56FE\u4E0D\u652F\u6301\u8499\u677F\u6761\u4EF6\u3002`);o=o??-1,n.docid=o;break;default:o=o??n.value,n.value=o}}if(window.config.promptMode===w.PROMPTMODE_BATCH){if(e.length===0)throw new Error("\u6CA1\u6709\u627E\u5230\u201C\u83B7\u53D6\u56FE\u7247\u201D\u6761\u4EF6");if(e.length>3)throw new Error("\u6682\u4E0D\u652F\u63013\u4E2A\u4EE5\u4E0A\u7684\u201C\u83B7\u53D6\u56FE\u7247\u201D\u6761\u4EF6");let o=Ge.querySelector("[data-output-batchfolder]").value;if(!o)throw new Error("\u6CA1\u6709\u6307\u5B9A\u8F93\u51FA\u56FE\u50CF\u7684\u76EE\u5F55");if(t.has(o))throw new Error('"\u8F93\u51FA\u56FE\u50CF":\u5176\u5B83\u6761\u4EF6\u5DF2\u7ECF\u6307\u5B9A\u4E86\u8BE5\u76EE\u5F55');return t.add(o),L.output.folderbatch=o,e}}async function ri(){try{if(!q){alert("\u8BF7\u9009\u62E9\u4E00\u4E2A\u5DE5\u4F5C\u6D41");return}if(!L){alert("\u672A\u6B63\u786E\u52A0\u8F7D\u5DE5\u4F5C\u6D41");return}if(window.config.promptMode===w.PROMPTMODE_BATCH){let e=await bt(),t;try{t=await Qa.getFolderWithCreate(L.output.folderbatch)}catch(n){throw new Error(`"\u8F93\u51FA\u56FE\u50CF":${n.message}`)}if(await Ae.hasBatchTask(L.output.folderbatch)){if(await Ae.checkBatchTask(q,L,ge,e),!await confirm('"\u8F93\u51FA\u56FE\u50CF":\u8BE5\u76EE\u5F55\u5DF2\u5B58\u5728\u6279\u91CF\u4EFB\u52A1\uFF0C\u5C06\u81EA\u52A8\u8DF3\u8FC7\u5DF2\u5904\u7406\u7684\u56FE\u7247\uFF0C\u8981\u7EE7\u7EED\u751F\u56FE\u5417\uFF1F'))return}else await Ae.createBatchTask(q,L,ge,e);Ae.promptBatch(q,L,ge,e)}else window.config.promptMode===w.PROMPTMODE_LIVE?(await bt(),$e.promptLive(q,L,ge)):(await bt(),Tn.prompt(q,L,ge))}catch(e){throw console.error(e),alert(e),e}}async function An(){try{Ln.clearLog(),window.showSingle(document.getElementById("logContainer"));let e=localStorage.getItem("lastWorkflow"),t=-1,n=await we.get_workflows();for(let o=0;o<n.length;o++)if(n[o].wfname===e){t=o;break}t<0&&n.length>0&&(t=0),Ce.innerHTML="",Ge.innerHTML="",n.forEach(o=>{let r=document.createElement("sp-action-button");r.setAttribute("wfname",o.wfname),r.setAttribute("quiet",!0),r.setAttribute("variant","secondary"),r.size="s",r.style.border="4px solid #0056b3",r.textContent=o.wfname.slice(0,window.config.wfNameLength),t>=0&&o.wfname===n[t].wfname&&(r.setAttribute("variant","overBackground"),r.removeAttribute("quiet")),r.addEventListener("click",oi),r.className="dynamic-button",Ce.appendChild(r)}),t>=0?(await Bn(n[t].wfname),n[t].selected=!0):Ve(),Sn.textContent=U.getPromptModeLabel(),document.getElementById("btnWfBatchPromptHelp").style.display=window.config.promptMode===w.PROMPTMODE_BATCH||window.config.promptMode===w.PROMPTMODE_LIVE?"flex":"none"}catch(e){throw Ne(!0),Ve(),e}}async function ai(){try{if(Ne(!0),await Dn(null),await we.test_comfyui_jinn(window.config.comfyuiURL)===!0){await An();return}let t=new CustomEvent("comfyuiConnectEvent",{detail:{data:{},callback:An}});document.dispatchEvent(t)}catch(e){throw Ve(),console.error(e),alert(`\u52A0\u8F7D\u5DE5\u4F5C\u6D41\u5217\u8868\u65F6\u51FA\u9519:${e}`),e}}async function Cn(){try{let e=document.getElementById("userInfoDialog"),n=document.getElementById("tfUserInfoPhone").value.trim();if(n.length<7||!/^\d+$/.test(n)){alert("\u8F93\u5165\u4E0D\u6B63\u786E");return}await we.registry_user(n),e.close()}catch(e){alert(e)}}function ii(){let e=document.getElementById("userInfoDialog");if(e)return;e=document.createElement("dialog"),e.id="userInfoDialog",e.style.cssText="width:300px; padding:20px; display:flex; flex-direction:column; align-items:center; text-align:center;";let t=document.createElement("sp-body");t.id="tfUserInfoMessage",t.textContent="\u8BF7\u8F93\u5165\u4F60\u7684\u624B\u673A\u53F7\u7801\uFF1A",t.style.marginBottom="15px";let n=document.createElement("sp-textfield");n.id="tfUserInfoPhone",n.setAttribute("maxlength","20"),n.setAttribute("placeholder","\u8BF7\u8F93\u5165\u624B\u673A\u53F7"),n.style.width="100%",n.style.margin="0 auto";let o=document.createElement("sp-action-button");o.id="btnUserInfoSubmit",o.textContent="\u63D0\u4EA4",o.style.marginTop="15px",e.appendChild(t),e.appendChild(n),e.appendChild(o),document.body.appendChild(e)}function si(e){try{let{error:t}=e.detail;if(t.needinfo){ii();let n=document.getElementById("userInfoDialog"),o=document.getElementById("btnUserInfoSubmit"),r=document.getElementById("tfUserInfoMessage");r.textContent=t.message,n.showModal(),o.removeEventListener("click",Cn),o.addEventListener("click",Cn,{once:!0})}else alert(t.message)}catch(t){alert(t)}}function ci(){Sn.addEventListener("click",ri),ni.addEventListener("click",async()=>{window.config.promptMode===w.PROMPTMODE_LIVE?$e.interruptPrompt():window.config.promptMode===w.PROMPTMODE_BATCH?Ae.interruptPrompt():Tn.interruptPrompt()}),document.getElementById("btnWfBatchPromptHelp").addEventListener("click",async()=>{window.config.promptMode===w.PROMPTMODE_LIVE?$e.showHelp():Ae.showHelp()}),document.getElementById("btnWfRefresh").addEventListener("click",async()=>{document.dispatchEvent(new CustomEvent("wfRefreshWorkflowEvent",{detail:{}}))}),document.addEventListener("wfRefreshWorkflowEvent",ai),document.dispatchEvent(new CustomEvent("wfRefreshWorkflowEvent",{detail:{}})),document.addEventListener("verifyUserEvent",si)}function li(){return q}var q,L,ge;async function Dn(e){q=e,q!==null?(In.style.display="flex",L=await we.get_wf_params(q),ge=await we.get_wf_api(q)):(L=null,ge=null,In.style.display="none")}kn.exports={initPanel:ci,getWfname:li}});var $n=T((Cs,Un)=>{"use strict";var oe=null,vt=null,Ye=null;function ui(){vt=document.getElementById("wfMgrNodeDialog"),oe=document.getElementById("wfMgrNodeDialogListNode"),Ye=document.getElementById("wfMgrNodeDialogOKButton"),oe.addEventListener("click",e=>{try{e.target.tagName==="SP-MENU-ITEM"&&(oe.querySelectorAll("sp-menu-item").forEach(t=>t.removeAttribute("selected")),e.target.setAttribute("selected",!0))}catch(t){throw console.error(t),alert(t),t;return}}),oe.addEventListener("dblclick",e=>{e.target.tagName==="SP-MENU-ITEM"&&Ye.dispatchEvent(new Event("click"))})}function di(e){oe.innerHTML="";for(let t in e){let n=e[t],o=n.fields,r=n.nodeclass,a=n.nodetitle;if(Object.keys(o).length===0)continue;let i=document.createElement("sp-menu-item");i.textContent=`${a}(\u7F16\u53F7${t})`,i.setAttribute("data-nodeid",t),i.setAttribute("data-nodetitle",a),i.setAttribute("data-nodeclass",r),oe.appendChild(i)}}function fi(e,t,n){di(e);let o=null;t&&(o=oe.querySelector(`sp-menu-item[data-nodeid="${t}"]`)),t&&o?o.setAttribute("selected",!0):oe.querySelectorAll("sp-menu-item").forEach(r=>{r.removeAttribute("selected")}),Ye.addEventListener("click",function r(){Ye.removeEventListener("click",r);try{let a=oe.querySelector("sp-menu-item[selected]");if(!a)return;let i=a.getAttribute("data-nodeid"),s=a.getAttribute("data-nodetitle"),c=a.getAttribute("data-nodeclass");vt.close(),n(i,s,c)}catch(a){throw console.error(a),alert(a),a;return}}),vt.showModal()}Un.exports={initShow:ui,show:fi}});var qn=T((Ts,Fn)=>{"use strict";var Nn=Y(),Te,_t,It;function mi(){_t=document.getElementById("wfMgrRecoverDialog"),Te=document.getElementById("wfMgrRecoverList"),It=document.getElementById("wfMgrRecoverDialogOKButton"),Te.addEventListener("click",e=>{try{e.target.tagName==="SP-MENU-ITEM"&&(Te.querySelectorAll("sp-menu-item").forEach(t=>t.removeAttribute("selected")),e.target.setAttribute("selected",!0))}catch(t){throw console.error(t),alert(t),t;return}})}function pi(e){Te.innerHTML="";for(let t of e){let n=document.createElement("sp-menu-item");n.textContent=`${t}`,n.setAttribute("data-wfname",t),Te.appendChild(n)}}async function gi(e){let t=await Nn.get_workflows_recover();pi(t),It.addEventListener("click",async function n(){It.removeEventListener("click",n);try{let o=Te.querySelector("sp-menu-item[selected]");if(!o)return;let r=o.getAttribute("data-wfname");await Nn.workflows_recover(r),_t.close(),e(r)}catch(o){throw console.error(o),alert(o),o;return}}),_t.showModal()}Fn.exports={initShow:mi,show:gi}});var Rn=T((Ls,jn)=>{"use strict";var de=null,re=null,xt=null,Xe=null;function wi(){xt=document.getElementById("wfMgrNodeFieldDialog"),de=document.getElementById("wfMgrNodeFieldDialogListNode"),re=document.getElementById("wfMgrNodeFieldDialogListField"),Xe=document.getElementById("wfMgrNodeFieldDialogOKButton"),de.addEventListener("click",e=>{try{if(e.target.tagName==="SP-MENU-ITEM"){de.querySelectorAll("sp-menu-item").forEach(n=>n.removeAttribute("selected")),e.target.setAttribute("selected",!0);let t=e.target.getAttribute("data-nodeid");Mt(t)}}catch(t){throw console.error(t),alert(t),t;return}}),re.addEventListener("click",e=>{e.target.tagName==="SP-MENU-ITEM"&&(re.querySelectorAll("sp-menu-item").forEach(t=>t.removeAttribute("selected")),e.target.setAttribute("selected",!0))}),re.addEventListener("dblclick",e=>{e.target.tagName==="SP-MENU-ITEM"&&Xe.dispatchEvent(new Event("click"))})}function Mt(e=null,t=null){re.innerHTML="";let n=Je[e],o=n?n.fields:{},r=!1;for(let a in o){let i=document.createElement("sp-menu-item");i.textContent=a,i.setAttribute("data-field",a),i.setAttribute("data-value",o[a]),a===t&&i.setAttribute("selected",!0),re.appendChild(i)}!r&&re.children.length===1&&re.children[0].setAttribute("selected",!0)}function yi(){de.innerHTML="";for(let e in Je){let t=Je[e],n=t.fields,o=t.nodeclass,r=t.nodetitle;if(Object.keys(n).length===0)continue;let a=document.createElement("sp-menu-item");a.textContent=`${r}(\u7F16\u53F7${e})`,a.setAttribute("data-nodeid",e),a.setAttribute("data-nodetitle",r),a.setAttribute("data-nodeclass",o),de.appendChild(a)}}var Je=null;function hi(e,t,n,o){Je=e,yi();let r=null;t&&(r=de.querySelector(`sp-menu-item[data-nodeid="${t}"]`)),t&&r?(r.setAttribute("selected",!0),Mt(t,n)):(de.querySelectorAll("sp-menu-item").forEach(a=>{a.removeAttribute("selected")}),Mt()),Xe.addEventListener("click",async function a(){try{let i=de.querySelector("sp-menu-item[selected]"),s=re.querySelector("sp-menu-item[selected]");if(!i||!s)return;let c=i.getAttribute("data-nodeid"),u=i.getAttribute("data-nodetitle"),l=i.getAttribute("data-nodeclass"),d=s.getAttribute("data-field"),p=s.getAttribute("data-value");Xe.removeEventListener("click",a),xt.close(),await o(c,u,l,d,p)}catch(i){throw console.error(i),alert(i),i;return}}),xt.showModal()}jn.exports={initShow:wi,show:hi}});var Wn=T((Ps,Hn)=>{"use strict";var Ss=O();function Ei(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function bi(e){let t={};for(let n in e){if(!e.hasOwnProperty(n))continue;let o=e[n],r=o.class_type,a=o._meta?o._meta.title:o.class_type;t[n]={nodeclass:r,nodetitle:a,fields:{}};let i=t[n].fields;for(let s in o.inputs){if(!o.inputs.hasOwnProperty(s))continue;let c=o.inputs[s];Array.isArray(c)||(i[s]=c)}}return t}function vi(e){return!e||typeof e!="object"?!1:Object.keys(e).every(n=>/^\d+$/.test(n))}Hn.exports={isWfAPI:vi,parsenodes:bi,generateUUID:Ei}});var no=T((ks,to)=>{"use strict";var he=Y(),Bs=ve(),Ds=ee(),Kn=$n(),Vn=qn(),Gn=Rn(),et=Wn(),j=O();function _i(){let e=null;for(let t in $){let o=$[t].nodeclass;if(o==="SaveImage"){e=t;break}else o==="PreviewImage"&&(e=t)}if(e){let t=$[e],n=t.nodetitle,o=t.nodeclass;I.setAttribute("data-nodeid",e),I.setAttribute("data-nodetitle",n),I.setAttribute("data-nodeclass",o),I.textContent=`${n}(${e})`}else I.removeAttribute("data-nodeid"),I.removeAttribute("data-nodetitle"),I.removeAttribute("data-nodeclass"),I.textContent=""}function Ii(){let e=null,t=null;for(let n in $){let o=$[n];for(let r in o.fields){let a=o.fields[r];if(r==="image"){e=n,t=r;break}}}if(e){let n=$[e],o=n.nodetitle,r=n.nodeclass,a=n.fields[t];Ze(e,o,r,t,"\u83B7\u53D6\u56FE\u7247",a,j.INPUTIMAGE,"",!1)}else Ze(null,null,null,"","\u83B7\u53D6\u56FE\u7247","",j.INPUTIMAGE,"",!1)}function xi(){Ze(null,null,null,"","","",null,"",!0)}function Mi(e){try{let t=I.getAttribute("data-nodeid");Kn.show($,t,(n,o,r)=>{I.setAttribute("data-nodeid",n),I.setAttribute("data-nodetitle",o),I.setAttribute("data-nodeclass",r),I.textContent=`${o}(\u7F16\u53F7${n})`})}catch(t){throw console.error(t),alert(t),t;return}}function Ai(e){try{let t=e.currentTarget.getAttribute("data-divid"),n=document.getElementById(t),o=n.querySelector(".wfMgrNode"),r=o.getAttribute("data-nodeid"),a=o.getAttribute("data-field");Gn.show($,r,a,async(i,s,c,u,l)=>{o.setAttribute("data-nodeid",i),o.setAttribute("data-nodetitle",s),o.setAttribute("data-nodeclass",c),o.textContent=`\u8282\u70B9=${s}(${i}),   \u5B57\u6BB5=${u}`,o.setAttribute("data-field",u);let d=n.querySelector(".wfMgrTitle");d.value.trim()||(d.value=u);let g=n.querySelector(".wfMgrValue");g.value||(g.value=String(l));let y=n.querySelector(".wfMgrKind");if(!y.value){let[x,f]=await he.guessFieldKind(c,u),m=n.querySelector(".wfMgrExtra");x&&(y.querySelectorAll("sp-menu-item").forEach(b=>{b.value===x?b.setAttribute("selected",!0):b.removeAttribute("selected")}),x===j.SLIDER&&(m.value=`${f.min},${f.max},${f.step}`))}})}catch(t){throw console.error(t),alert(t),t;return}}function Ze(e,t,n,o,r,a,i,s,c,u){let l=document.createElement("div");l.id=`wfMgrDiv-${et.generateUUID()}`,l.innerHTML=Xn,Le.appendChild(l);let d=l.querySelector(".wfMgrNode");d.setAttribute("data-nodeid",e),d.setAttribute("data-field",o),d.setAttribute("data-nodetitle",t),d.setAttribute("data-nodeclass",n),d.setAttribute("data-divid",l.id),d.addEventListener("click",Ai),e&&(d.textContent=`\u8282\u70B9=${t}(${e}),   \u5B57\u6BB5=${o}`),l.querySelector(".wfMgrTitle").value=r;let p=l.querySelector(".wfMgrValue");p.value=String(a),p.setAttribute("data-valuefolder",u);let g=l.querySelector(".wfMgrKind");g.setAttribute("data-divid",l.id),g.querySelectorAll("sp-menu-item").forEach(x=>{x.value===i&&x.setAttribute("selected",!0)}),g.addEventListener("change",x=>{let f=x.currentTarget.value,m=x.currentTarget.getAttribute("data-divid"),b=document.getElementById(m),S=b.querySelector(".wfMgrVisible"),C=b.querySelector(".wfMgrExtra"),Q=b.querySelector(".wfMgrValue");switch(C.style.display="block",Q.style.display="block",C.parentElement.querySelector("[data-label-extra]").style.display="block",Q.parentElement.querySelector("[data-label-value]").style.display="block",f){case j.SLIDER:let z=C.value;z||(o==="denoise"?z="0,1,0.01":o==="steps"?z="1,40,1":z="0,100,1",C.value=z);break;case j.SEED:S.checked=!1;break;case j.INPUTIMAGE:case j.INPUTIMAGEMASK:case j.INPUTMASK:S.checked=!1,C.style.display="none",C.parentElement.querySelector("[data-label-extra]").style.display="none",Q.style.display="none",Q.parentElement.querySelector("[data-label-value]").style.display="none";break;case j.FIELDENUM:C.style.display="none",C.parentElement.querySelector("[data-label-extra]").style.display="none";break;default:break}});let E=l.querySelector(".wfMgrExtra");E.value=s,l.querySelector(".wfMgrVisible").checked=c;let y=l.querySelector(".wfMgrDel");switch(y.addEventListener("click",Ci),y.setAttribute("data-divid",l.id),i){case j.INPUTIMAGE:case j.INPUTIMAGEMASK:case j.INPUTMASK:E.style.display="none",E.parentElement.querySelector("[data-label-extra]").style.display="none",p.style.display="none",p.parentElement.querySelector("[data-label-value]").style.display="none";break;case j.FIELDENUM:E.style.display="none",E.parentElement.querySelector("[data-label-extra]").style.display="none";break;default:break}}function Ci(e){let t=e.currentTarget.getAttribute("data-divid"),n=document.getElementById(t);Le.removeChild(n)}async function Yn(){try{let e=await he.get_wf_api_run();return e.result?(J=e,!0):!1}catch(e){throw console.error(e),alert(`\u8BFB\u53D6\u5DE5\u4F5C\u6D41API\u65F6\u51FA\u9519:${e}`),e;return}}async function Ti(){if(await Yn())try{$=et.parsenodes(J.apidata),ie.disabled=!1,Ee.disabled=!1,Ee.value="\u65B0\u589E\u5DE5\u4F5C\u6D41",document.getElementById("tfwfMgrPath").value=J.lasttime,Le.innerHTML="",_i(),Ii()}catch(e){throw console.error(e),alert(e),e;return}}async function Li(){if(await Yn())try{$=et.parsenodes(J.apidata),document.getElementById("tfwfMgrPath").value=J.lasttime}catch(e){throw console.error(e),alert(e),e;return}}function Fe(){try{let e=document.getElementById("wfPromptContainer"),t=document.getElementById("wfManageContainer");t.style.display="none",e.style.display="flex",Pe&&document.dispatchEvent(new CustomEvent("wfRefreshWorkflowEvent",{detail:{}}))}catch(e){throw console.error(e),alert(e),e}}async function zn(e){try{let t=I.getAttribute("data-nodeid");await Vn.show(n=>{localStorage.setItem("lastWorkflow",n),Pe=!0,Fe()})}catch(t){throw console.error(t),alert(t),t;return}}var Qe=!1,Pe=!1,Ee,ie,Le,Se,At,I,ye,Xn,R,J,$;async function Jn(){Qe=!1,Pe=!1,R=null,J=null,$=null,await window.loadHtml("wfManageContainer","html/wfmanage.html"),Ee=document.getElementById("tfwfMgrName"),ie=document.getElementById("btnWfManageSave"),Le=document.getElementById("wfManageContainerInner"),Se=document.getElementById("btnWfManageDel"),At=document.getElementById("btnWfManageRecover"),I=document.getElementById("tfwfMgrOutput"),ye=document.getElementById("wfManageLog"),Xn=await(await fetch("html/wfparamtempelate.html")).text(),document.getElementById("btnWfManageHelp").addEventListener("click",t=>{document.getElementById("wfManageHelpDialog").showModal()}),document.getElementById("btnWfManageReturn").addEventListener("click",async t=>{(!Qe||await window.confirm("\u5DE5\u4F5C\u6D41\u5C1A\u672A\u4FDD\u5B58\uFF0C\u786E\u5B9A\u8981\u8FD4\u56DE\u5417\uFF1F"))&&Fe()}),Se.addEventListener("click",Si),document.getElementById("tfwfMgrAddParam").addEventListener("click",xi),I.addEventListener("click",Mi),At.addEventListener("click",zn),Gn.initShow(),Kn.initShow()}async function Si(){try{if(!R||!await confirm("\u786E\u5B9A\u8981\u5220\u9664\u5DE5\u4F5C\u6D41\u5417\uFF1F"))return;Pe=!0,await he.save_wf_del({wfname:R}),Fe()}catch(e){throw console.error(e),alert(e),e}finally{Se.disabled=!1}}function Zn(){let e=I.getAttribute("data-nodeid"),t=I.getAttribute("data-nodetitle"),n=I.getAttribute("data-nodeclass"),o=I.getAttribute("data-folderbatch");if(!e){ae("\u8BF7\u5148\u8BBE\u7F6E\u7ED3\u679C\u56FE\u7247\u8282\u70B9");return}if(!(e in $)){ae("\u7ED3\u679C\u56FE\u7247\u8282\u70B9\u4E0D\u6B63\u786E");return}let r=[],a=new Set;for(let s=0;s<Le.children.length;s++){let c=Le.children[s],u=c.querySelector(".wfMgrTitle").value.trim(),l=c.querySelector(".wfMgrNode"),d=l.getAttribute("data-nodetitle"),p=l.getAttribute("data-nodeclass"),g=l.getAttribute("data-nodeid"),E=l.getAttribute("data-field"),y=c.querySelector(".wfMgrValue").value,x=c.querySelector(".wfMgrValue").getAttribute("data-valuefolder"),f=c.querySelector(".wfMgrKind").value,m=c.querySelector(".wfMgrExtra").value,b=c.querySelector(".wfMgrVisible").checked;if(!f){ae(`\u7B2C${s+1}\u4E2A\u6761\u4EF6\uFF0C\u6761\u4EF6\u7C7B\u578B\u4E0D\u80FD\u4E3A\u7A7A`);return}if(!g||!E){ae(`\u7B2C${s+1}\u4E2A\u6761\u4EF6\uFF0C\u8282\u70B9\u53CA\u5B57\u6BB5\u4E0D\u80FD\u4E3A\u7A7A`);return}if(!(g in $&&E in $[g].fields)){ae(`\u7B2C${s+1}\u4E2A\u6761\u4EF6\uFF0C\u8282\u70B9\u6216\u5B57\u6BB5\u4E0D\u6B63\u786E`);return}let S={title:u,kind:f,nodeid:g,nodetitle:d,nodeclass:p,field:E,value:y,extra:m,visible:b,valuefolder:x};r.push(S);let C=`${S.nodeid}-${S.field}`;if(a.has(C)){ae(`\u627E\u5230\u91CD\u590D: \u8282\u70B9=${S.nodeid}, \u5B57\u6BB5=${S.field}`);return}a.add(C)}return{params:r,output:{nodeid:e,nodetitle:t,nodeclass:n,folderbatch:o}}}function Qn(e){ye.textContent=e,ye.style.color="lightgreen",setTimeout(()=>{ye.textContent=""},800)}function ae(e){ye.textContent=e,ye.style.color="orange",setTimeout(()=>{ye.textContent=""},2e3)}async function Pi(){if(!J){ae("\u8BF7\u5148\u63D0\u53D6\u5DE5\u4F5C\u6D41API,\u5982\u679C\u63D0\u53D6\u4E0D\u5230\uFF0C\u8BF7\u5728COMFYUI\u4E2D\u6267\u884C\u4E00\u6B21\u540E\u518D\u8BD5\uFF01");return}let e=Ee.value.trim();if(!e){ae("\u5DE5\u4F5C\u6D41\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A");return}let t=Zn();t&&(await he.save_wf_new_run({apidata:J.apidata,wfname:e,params:t}),Qe=!1,Pe=!0,R=e,localStorage.setItem("lastWorkflow",R),Qn("\u5DE5\u4F5C\u6D41\u4FDD\u5B58\u6210\u529F"),Fe())}async function eo(){let e=Ee.value.trim();if(!e){ae("\u5DE5\u4F5C\u6D41\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A");return}let t=Zn();t&&(await he.save_wf_edit({wfname:R,wfnamenew:e,params:t,apidata:J?J.apidata:null}),Qe=!1,Pe=!0,R!==e&&localStorage.setItem("lastWorkflow",e),R=e,Qn("\u5DE5\u4F5C\u6D41\u4FDD\u5B58\u6210\u529F"),Fe())}async function Bi(){await Jn(),Vn.initShow(),document.getElementById("btnWfManageOpenFile").addEventListener("click",Ti),ie.disabled=!0,Ee.disabled=!0,Se.style.display="none",At.style.display="block",ie.addEventListener("click",async e=>{try{ie.disabled=!0,R?await eo():await Pi()}catch(t){throw console.error(t),alert(t),t}finally{ie.disabled=!1}}),document.getElementById("btnWfManageOpenFile").dispatchEvent(new Event("click"))}async function Di(e){try{await Jn(),document.getElementById("btnWfManageOpenFile").addEventListener("click",Li),Se.disabled=!0,ie.disabled=!0,ie.addEventListener("click",async o=>{try{await eo()}catch(r){throw console.error(r),alert(r),r}}),R=e,document.getElementById("tfwfMgrPath").value=`${R}.json`;let t=await he.get_wf_api(R);$=et.parsenodes(t);let n=await he.get_wf_params(R);Ee.value=R,I.setAttribute("data-nodeid",n.output.nodeid),I.setAttribute("data-nodetitle",n.output.nodetitle),I.setAttribute("data-nodeclass",n.output.nodeclass),I.setAttribute("data-folderbatch",n.output.folderbatch),I.textContent=`${n.output.nodetitle}(${n.output.nodeid})`,n.kind||(n.kind=j.PROMPTMODE_COMMON);for(let o of n.params)Ze(o.nodeid,o.nodetitle,o.nodeclass,o.field,o.title,o.value,o.kind,o.extra,o.visible,o.valuefolder)}catch(t){throw console.error(t),alert(t),t}finally{ie.disabled=!1,Se.disabled=!1}}function ki(){window.loadCSS("../css/wfmgr.css")}to.exports={initPanel:ki,showNew:Bi,showEdit:Di}});var io=T((Os,ao)=>{"use strict";var Oi=Y(),oo=ee(),nt=O(),v={comfyuiURL:"http://127.0.0.1:8188",setAILayer:nt.SETAILAYERCLOSE,wfDisplayType:"button",wfNameLength:12,pszoomMinsize:"512",pszoomMaxsize:"1024",outputZoom:nt.OUTPUT_ZOOM,showDetailLog:!1,outputPreview:!1,transEnable:!1,transBaiduAppID:"",transBaiduAppKey:"",promptMode:nt.PROMPTMODE_COMMON,livePromptSensitivity:2,batchPromptPause:2,batchPromptPreview:!0};window.config=v;var ro="pluginConfig.json";async function Ui(){try{let n=await(await(await oo.getDataFolder()).getEntry(ro)).read(),o=JSON.parse(n);Object.assign(v,o)}catch{console.log("\u4F7F\u7528\u9ED8\u8BA4\u53C2\u6570")}}async function Z(){try{await(await(await oo.getDataFolder()).createEntry(ro,{overwrite:!0})).write(JSON.stringify(v,null,2))}catch(e){console.error("Error saving config:",e)}}window.saveConfig=Z;function tt(e,t){e.forEach(n=>{n.getAttribute("data-value")===t?n.removeAttribute("quiet"):n.setAttribute("quiet","")})}async function $i(){let e=document.getElementById("btnSetDisplayTypePicker"),t=document.getElementById("btnSetDisplayTypeButton"),n=document.getElementById("btnSetAILayerClose"),o=document.getElementById("btnSetAILayerDel"),r=document.getElementById("btnSetAILayerOmit");document.getElementById("btnSetComfyuiURL").addEventListener("click",f=>{let m=S=>{window.showSingle(document.getElementById("settingsContainer"))},b=new CustomEvent("comfyuiConnectEvent",{detail:{data:{},callback:m}});document.dispatchEvent(b)});let a=[n,o,r];a.forEach(f=>{f.addEventListener("click",m=>{let b=m.currentTarget.getAttribute("data-value");b!==v.setAILayer&&(v.setAILayer=b,Z(),tt([n,o,r],v.setAILayer),v.setAILayer===nt.SETAILAYERDEL&&alert("\u542F\u7528\u8BE5\u53C2\u6570\u65F6\uFF0CAI\u751F\u56FE\u540E\u4F1A\u5220\u9664\u5176\u5B83\u7531AI\u751F\u6210\u7684\u56FE\u5C42\uFF0C\u8BF7\u8C28\u614E\u64CD\u4F5C\uFF01"))})}),tt(a,v.setAILayer);let i=document.getElementById("spSetMaxSize"),s=document.getElementById("spSetMinSize");i.querySelectorAll("sp-menu-item").forEach(f=>{f.value===v.pszoomMaxsize&&f.setAttribute("selected",!0)}),s.querySelectorAll("sp-menu-item").forEach(f=>{f.value===v.pszoomMinsize&&f.setAttribute("selected",!0)}),i.addEventListener("change",f=>{let m=f.currentTarget.value;v.pszoomMaxsize=m,Z()}),s.addEventListener("change",f=>{let m=f.currentTarget.value;v.pszoomMinsize=m,Z()});let c=document.getElementById("spSetOutputZoom");c.querySelectorAll("sp-menu-item").forEach(f=>{f.value===v.outputZoom&&f.setAttribute("selected",!0)}),c.addEventListener("change",f=>{let m=f.currentTarget.value;v.outputZoom=m,Z()});let u=document.getElementById("cbSetOutputPriview");u.checked=v.outputPreview,u.addEventListener("change",async f=>{try{let m=document.getElementById("cbSetOutputPriview").checked;await Oi.setOutputPreview(m),v.outputPreview=m,Z()}catch(m){throw console.error(m),alert(m),m}});let l=document.getElementById("cbSetTransEnable");l.checked=v.transEnable,l.addEventListener("change",async f=>{try{let m=document.getElementById("cbSetTransEnable").checked;v.transEnable=m,Z()}catch(m){throw console.error(m),alert(m),m}});let d=document.getElementById("cbSetTransBaiduAppID");d.value=v.transBaiduAppID,d.addEventListener("change",async f=>{try{let m=document.getElementById("cbSetTransBaiduAppID").value;v.transBaiduAppID=m,Z()}catch(m){throw console.error(m),alert(m),m}});let p=document.getElementById("cbSetTransBaiduAppKey");p.value=v.transBaiduAppKey,p.addEventListener("change",async f=>{try{let m=document.getElementById("cbSetTransBaiduAppKey").value;v.transBaiduAppKey=m,Z()}catch(m){throw console.error(m),alert(m),m}}),document.getElementById("btnSetTransBaiduHelp").addEventListener("click",f=>{document.getElementById("cbSetTransHelpBaiduDialog").showModal()});let g=document.getElementById("btnSetPromptCommon"),E=document.getElementById("btnSetPromptBatch"),y=document.getElementById("btnSetPromptLive"),x=[g,E,y];x.forEach(f=>{f.addEventListener("click",m=>{let b=m.currentTarget.getAttribute("data-value");b!==v.promptMode&&(v.promptMode=b,Z(),tt(x,v.promptMode),document.dispatchEvent(new CustomEvent("wfRefreshWorkflowEvent",{detail:{}})))})}),tt(x,v.promptMode)}ao.exports={loadConfig:Ui,initPanel:$i}});var fo=T((Us,uo)=>{"use strict";var so=Y(),Ni=O();function qe(e,t=!0){let n=document.getElementById("divTestInfo");n.innerHTML=`${e}`,t?n.style.color="#ff5555":n.style.color="lightgreen"}async function Fi(e,t){let n=document.getElementById("btnConnect"),o=document.getElementById("tfComfyuiURL"),r=o.value.trim();try{r=r.match(/^https?:\/\//)?r:`http://${r}`,r=r.replace(/\/+$/,""),new URL(r)}catch(i){qe(`URL\u4E0D\u5408\u6CD5:${r}`),console.log(i);return}qe(`\u5C1D\u8BD5\u8FDE\u63A5\u5230:${r}`),n.disabled=!0;try{await so.test_comfyui(r)}catch(i){qe("\u8FDE\u63A5COMFYUI\u5931\u8D25<br>\u8BF7\u590D\u5236\u4E0A\u9762\u7684\u5730\u5740\u5230\u6D4F\u89C8\u5668\uFF0C\u4EE5\u68C0\u67E5COMFYUI\u662F\u5426\u542F\u52A8"),console.log(i),n.disabled=!1;return}if(await so.test_comfyui_jinn(r)!==!0){qe("COMFYUI\u5DF2\u8FDE\u63A5,\u4F46\u662F\u6CA1\u6709\u5B89\u88C5comfyui_jinn\u63D2\u4EF6<br>\u8BF7\u5C06\u5B89\u88C5\u5305\u4E2D\u7684comfyui_jinn_ps\u76EE\u5F55\u590D\u5236\u5230COMFYUI\u4E0B\u7684custom_nodes\u76EE\u5F55\uFF0C\u91CD\u542FCOMFYUI\u670D\u52A1\u518D\u8BD5"),n.disabled=!1;return}window.config.comfyuiURL=r,window.saveConfig(),o.value=window.config.comfyuiURL,qe("\u8FDE\u63A5COMFYUI\u6210\u529F!",!1),n.disabled=!1;try{await e(t)}catch(i){throw console.error(i),alert(i),i}}var co=null,lo=null;function qi(e,t){let n=document.getElementById("connContainer");window.showSingle(n);let o=document.getElementById("divTestInfo");o.innerHTML="";let r=document.getElementById("tfComfyuiURL");r.value=config.comfyuiURL,co=e,lo=t}document.addEventListener("comfyuiConnectEvent",e=>{let{data:t,callback:n}=e.detail;qi(n,t)});async function ji(){document.getElementById("connContainer").innerHTML.trim()===""&&await window.loadHtml("connContainer","html/connect.html");let t=document.getElementById("btnResetComfyuiURL"),n=document.getElementById("btnConnect");t.addEventListener("click",()=>{tfComfyuiURL.value=Ni.DEFAULT_COMFYUI_URL}),n.addEventListener("click",async o=>{await Fi(co,lo)})}uo.exports={initPanel:ji}});var yo=T(()=>{var $s=B("uxp"),{entrypoints:Ri}=B("uxp"),{app:Ns}=B("photoshop"),mo=On(),Tt=no(),Hi=K(),po=io(),Wi=fo();typeof window.alert!="function"&&(window.alert=async function(e=""){let t=document.getElementById("alertDialog");t||(t=document.createElement("dialog"),t.innerHTML=`
      <sp-body>${e}</sp-body>
      <div style="width:100%;display: flex; justify-content:center;">
        <sp-action-button id="alertDialogOK" >\u786E\u5B9A</sp-action-button>
      </div>
      `,document.body.appendChild(t),t.querySelector("#alertDialogOK").addEventListener("click",()=>{t.close(),resolve(!0)})),t.querySelector("sp-body").textContent=e,t.style.width="350px",t.id="alertDialog",t.showModal()});Ri.setup({panels:{"jinn_ps_ai.panel_main":{show(e){},create(){},hide(){},destroy(){},menuItems:[],invokeMenu(e){}}}});typeof window.confirm!="function"&&(window.confirm=async function(e="\u786E\u5B9A\u8981\u7EE7\u7EED\u5417\uFF1F"){let t=document.getElementById("confirmDialog");return t||(t=document.createElement("dialog"),t.innerHTML=`
          <sp-body  style="width=100%;">${e}</sp-body>
          <div style="width:100%;display: flex; justify-content:center;">
            <sp-action-button id="confirmDialogCancel">\u53D6\u6D88</sp-action-button>
            <sp-action-button id="confirmDialogOK" >\u786E\u5B9A</sp-action-button>
          </div>
      `,t.id="confirmDialog",t.style.width="350px",document.body.appendChild(t)),t.querySelector("sp-body").textContent=e,new Promise(n=>{t.querySelector("#confirmDialogOK").addEventListener("click",()=>{t.close(),n(!0)}),t.querySelector("#confirmDialogCancel").addEventListener("click",()=>{t.close(),n(!1)}),t.showModal()})});window.loadHtml=async function(t,n){try{let r=await(await fetch(n)).text();document.getElementById(t).innerHTML=r}catch(o){throw console.log(`\u52A0\u8F7D${n}\u5931\u8D25`,o),o}};window.loadCSS=function(t){var n=document.createElement("link");n.rel="stylesheet",n.type="text/css",n.href=t,document.head.appendChild(n)};window.showSingle=function(e){Array.from(Ki.children).forEach(t=>{t===e?t.style.display="flex":t.style.display="none"})};async function zi(){Ct.children.length===0&&(await window.loadHtml("settingsContainer","html/settings.html"),await po.initPanel()),Ct.style.display!=="none"?window.showSingle(Vi):window.showSingle(Ct)}var Ki=document.getElementById("singleContainer"),Vi=document.getElementById("logContainer"),Ct=document.getElementById("settingsContainer"),go=document.getElementById("wfPromptContainer"),wo=document.getElementById("wfManageContainer");document.getElementById("btnSettings").addEventListener("click",zi);document.getElementById("btnAddWorkflow").addEventListener("click",e=>{try{wo.style.display="flex",go.style.display="none",Tt.showNew()}catch(t){throw console.error(t),alert(t),t}});document.getElementById("btnEditWorkflow").addEventListener("click",e=>{try{let t=mo.getWfname();if(!t)return;wo.style.display="flex",go.style.display="none",Tt.showEdit(t)}catch(t){throw console.error(t),alert(t),t}});document.addEventListener("DOMContentLoaded",async()=>{try{await po.loadConfig(),await window.loadHtml("logContainer","html/logger.html"),Hi.initPanel(),Wi.initPanel(),mo.initPanel(),Tt.initPanel()}catch(e){throw console.log(e),e}})});yo();})();
