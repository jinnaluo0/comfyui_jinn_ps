(()=>{var B=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var A=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var ee=A((ps,Dt)=>{var{storage:nt}=B("uxp"),U=nt.localFileSystem;async function Io(){return U.getTemporaryFolder()}async function xo(){return U.getDataFolder()}async function Co(e){return U.createSessionToken(e)}async function Mo(e){return U.getFileForSaving(e)}async function So(){return U.getFolder()}async function Ao(e){return U.getEntryWithUrl(e)}async function To(e){return U.getFileForOpening(e)}async function Po(e,t){try{let o=await(await U.getEntryWithUrl(`file:${e}`)).getEntries(),r=[];for(let a of o)if(a.isFile){let i=a.name.slice(a.name.lastIndexOf(".")).toLowerCase();t.includes(i)&&r.push(a.name)}return r}catch(n){throw console.error(n),new Error(`\u83B7\u53D6\u6587\u4EF6\u5939\u5185\u56FE\u7247\u65F6\u51FA\u9519:${e}`)}}async function Lo(e,t){try{let o=await(await U.getEntryWithUrl(`file:${e}`)).getEntries(),r=[];for(let a of o){let i=a.name.slice(a.name.lastIndexOf(".")).toLowerCase();if(a.isFile&&t.includes(i))return!0}return!1}catch{return!1}}async function Do(e){let t;try{t=await U.getEntryWithUrl(e)}catch{try{await U.createEntryWithUrl(e,{type:"folder"})}catch(o){throw console.log(o),new Error(`\u521B\u5EFA\u76EE\u5F55\u5931\u8D25${e}`)}}try{if(t=await U.getEntryWithUrl(e),t.isFolder)return t;throw new Error(`\u76EE\u5F55\u4E0D\u6B63\u786E${e}`)}catch{throw new Error(`\u76EE\u5F55\u4E0D\u6B63\u786E${e}`)}}async function Bo(e){try{return!!(await U.getEntryWithUrl(e)).isFile}catch{return!1}}function ko(e,...t){let n=e.includes("/")?"/":"\\",o=e;(o.endsWith("/")||o.endsWith("\\"))&&(o=o.slice(0,-1));for(let r of t)(r.startsWith("/")||r.startsWith("\\"))&&(r=r.slice(1)),o+=`${n}${r}`;return o}async function Oo(e){return e.read({format:nt.formats.binary})}async function $o(e,t){return e.write(t,{format:nt.formats.binary})}async function Uo(e){let t=await U.getEntryWithUrl(e),n=await t.read(),o=JSON.parse(n);return[t,o]}async function No(e,t){let n=await U.createEntryWithUrl(e,{overwrite:!0});return Lt(n,t),n}async function Lt(e,t){await e.write(JSON.stringify(t,null,2))}Dt.exports={getTemporaryFolder:Io,getDataFolder:xo,createSessionToken:Co,getFileForSaving:Mo,getFileForOpening:To,getFolder:So,getEntryWithUrl:Ao,getImageFileNamesFromFolder:Po,getFolderWithCreate:Do,fileExists:Bo,joinPath:ko,hasImageFile:Lo,readArrayBuffer:Oo,writeArrayBuffer:$o,writeJsonFile:Lt,readJsonFile:Uo,createJsonFile:No}});var $=A(I=>{"use strict";I.TEMP_CHANNEL_NAME="JinnSelectionChannel";I.INPUTIMAGE="INPUTIMAGE";I.INPUTIMAGEMASK="INPUTIMAGEMASK";I.INPUTMASK="INPUTMASK";I.INPUTREGION="INPUTREGION";I.INPUTREGIONMASK="INPUTREGIONMASK";I.SEED="SEED";I.PROMPTTEXT="PROMPTTEXT";I.TEXTFIELD="TEXTFIELD";I.SLIDER="SLIDER";I.FIELDENUM="FIELDENUM";I.TEXT="TEXT";I.SETAILAYERCLOSE="close";I.SETAILAYERDEL="del";I.SETAILAYEROMIT="omit";I.DEFAULT_COMFYUI_URL="http://127.0.0.1:8188";I.OUTPUT_ZOOM="OUTPUT_ZOOM";I.OUTPUT_NOZOOM="OUTPUT_NOZOOM";I.PROMPTMODE_COMMON="COMMON";I.PROMPTMODE_BATCH="BATCH";I.PROMPTMODE_LIVE="LIVE";I.MINETYPES={".jpg":"image/jpeg",".jpeg":"image/jpeg",".png":"image/png",".bmp":"image/bmp",".gif":"image/gif",".webp":"image/webp"};I.VALID_IMAGE_EXTENSIONS=[".jpg",".jpeg",".png",".gif",".bmp",".webp"];I.BATCH_TASK_FILE_NAME="task.json";I.BATCH_OUTPUT_FILE_NAME="output.json";I.LIVE_ACTIVE_PS_TOOLS=["Pencil","Brush Tool","Color Replacement Tool","Mixer Brush","Eraser","Background Eraser","Magic Eraser","Dodge Tool","Burn Tool","Sponge Tool"]});var V=A((hs,$t)=>{"use strict";var ws=$(),v=null;function kt(){let e=new Date().toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"}),t=Math.round(new Date().getMilliseconds());return`${e}.${t}`}function qo(e,t,n,o){let r=v.querySelector(`[data-node-id="${t}"]`);if(r){r.value=o,r.max=n;return}r=ot("sp-progressbar"),r.style.margin="5 0px",r.setAttribute("data-node-id",t),r.value=o,r.max=n,window.config.showDetailLog,v.appendChild(r),v.scrollTop=v.scrollHeight}function ot(e,t,n=!1){let o=null;return window.config.showDetailLog||v.children.length===0?o=document.createElement(e):v.children.length>0&&(v.children[v.children.length-1].style.display="none",o=document.createElement(e)),o.addEventListener("click",Ko),o.setAttribute("size","s"),o.style.width="100%",o}function rt(e){let t=ot("div");if(window.config.showDetailLog){let n=kt();t.textContent=`${n} ${e}`}else t.textContent=e;v.appendChild(t),v.childNodes.length>30&&v.removeChild(v.firstChild),v.scrollTop=v.scrollHeight}function Bt(e){let t=ot("div");if(window.config.showDetailLog){let n=kt();t.textContent=`${n} ${e}`}else t.textContent=e;t.style.color="#ff5555",v.appendChild(t),v.childNodes.length>30&&v.removeChild(v.firstChild),v.scrollTop=v.scrollHeight}var Fo=(...e)=>{rt(e.join(" ")),window.config.showDetailLog&&console.log(...e)},Ro=(...e)=>{rt(e.join(" ")),window.config.showDetailLog&&console.log(...e)},jo=(...e)=>{e&&e[0]instanceof Error?Bt(e[0].message):Bt(e.join(" ")),window.config.showDetailLog&&console.error(...e)},Ho=(e,t,n,o)=>{qo(e,t,n,o)};async function Wo(){document.getElementById("logArea").innerHTML=""}async function zo(){let e=document.getElementById("logArea");try{let t=Array.from(e.childNodes).map(n=>n.textContent).join(`\r
`);navigator.clipboard.write({"text/plain":t})}catch(t){rt(`Copy failed: ${t.message}`)}}function Ot(e){window.config.showDetailLog=e,window.saveConfig(),window.config.showDetailLog?(v.className="logArea-normal",document.getElementById("logtoolbar").style.display="flex",Array.from(v.children).forEach(t=>{t.style.display="block"}),v.scrollTop=v.scrollHeight):(document.getElementById("logtoolbar").style.display="none",v.className="logArea-single",Array.from(v.children).forEach(t=>{t.style.display="none"}),v.children.length>0&&(v.children[v.children.length-1].style.display="block"))}function Ko(){Ot(!window.config.showDetailLog)}function Vo(){Ot(!1)}var Go;function Yo(){v=document.getElementById("logArea"),Go=document.getElementById("logtoolbar"),document.getElementById("btnCopyLog").addEventListener("click",zo),document.addEventListener("wfChangeLogSimpleEvent",Vo)}$t.exports={clearLog:Wo,initPanel:Yo,log:Fo,warn:Ro,error:jo,progress:Ho}});var te=A((_s,qt)=>{"use strict";var H=B("photoshop"),{storage:ys}=B("uxp"),Es=B("photoshop").imaging,vs=V(),bs=$(),Xo=ee();async function Jo(e,t){let o=await(await Xo.getTemporaryFolder()).createFile(t,{overwrite:!0}),r=new Uint8Array(e);return await o.write(r),o}async function Zo(e,t,n){e&&await H.core.executeAsModal(async o=>{e.layers.forEach(async r=>{r.name===t&&!Ut(r,n)&&r.delete()})})}async function Qo(e){e&&await H.core.executeAsModal(async t=>{e.layers.forEach(async n=>{n.delete()})})}function Ut(e,t){return e&&t&&e._id===t._id&&e._docId===t._docId}async function er(e){await Nt({_obj:"select",_target:[{_ref:"document",_id:e}]})}function tr(e){if(e===-1)return H.app.activeDocument;for(let t of H.app.documents)if(t.id===e)return t}async function nr(){try{let e=await H.action.batchPlay([{_obj:"get",_target:[{_property:"selection"},{_ref:"document",_enum:"ordinal",_value:"targetEnum"}]}],{});return e[0].selection&&e[0].selection.bottom?!0:null}catch(e){return console.error(e),null}}function or(e){if(Array.isArray(e),e.length,e.length>0&&e[0]&&e[0]._obj==="error")throw new Error(`\u6267\u884C\u51FA\u9519: ${e[0].message||"\u672A\u77E5\u9519\u8BEF"}`)}async function Nt(e,t){if(Array.isArray(e)||(e=[e]),!e||e.length===0)throw new Error("\u672A\u63D0\u4F9B\u4EFB\u4F55\u547D\u4EE4");let n=await H.core.executeAsModal(async o=>{let r,a;try{return r=await H.action.batchPlay(e,{synchronousExecution:!0,modalBehavior:"execute"}),or(r),r}catch(i){throw console.error(i),r&&console.log(JSON.stringify(r,null,2)),console.log(JSON.stringify(e,null,2)),new Error("\u6267\u884C\u52A8\u4F5C\u51FA\u9519")}finally{}})}async function rr(e="AI\u56FE\u7247",t=512,n=512){let o=await H.core.executeAsModal(async r=>await H.app.documents.add({name:e,width:t,height:n,resolution:72,fill:"black"}));if(!o)throw new Error("\u521B\u5EFA\u65B0\u56FE\u7247\u5931\u8D25");return o}function ar(){let e=[],t=H.app.documents;return t&&t.length>0&&t.forEach(n=>{e.push({id:n.id,name:n.name})}),e}function ir(e){let t=e.width,n=e.height;return{width:t,height:n}}function sr(){return H.app.documents.length>0}function cr(e){let t=e.bounds,n=t.left,o=t.top,r=t.right,a=t.bottom,i=r-n,s=a-o,c=(r+n)/2,l=(a+o)/2;return{left:n,top:o,right:r,bottom:a,width:i,height:s,centerX:c,centerY:l}}function lr(e){H.action.addNotificationListener(["historyStateChanged"],e)}function ur(e){H.action.removeNotificationListener(["historyStateChanged"],e)}qt.exports={getDocuments:ar,createDocument:rr,getDocumentSize:ir,activateDocument:er,hasDocument:sr,hasSelection:nr,getDocumentByID:tr,deleteAllLayers:Qo,deleteLayerByName:Zo,saveTempFile:Jo,executeCommand:Nt,layerEqual:Ut,getLayerBounds:cr,addNotificationListenerForHistory:lr,removeNotificationListenerForHistory:ur}});var De=A((Is,Ht)=>{"use strict";async function dr(e,t){try{let n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`\u8BBF\u95EECOMFYUI\u51FA\u9519 ${e}  ${n.status} ${n.statusText}`);let o=await n.json();if("comfy_error"in o)throw new Error(`serverlog=${o.comfy_error}`);return o}catch(n){throw n.message&&n.message==="Network request failed"?new Error("\u7F51\u7EDC\u9519\u8BEF\uFF0C\u65E0\u6CD5\u8FDE\u63A5\u5230COMFYUI"):n}}async function fr(e,t){try{let n=e;if(t){let a=new URLSearchParams(t).toString();n=`${e}${e.includes("?")?"&":"?"}${a}`}let o=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}});if(!o.ok)throw new Error(`\u8BBF\u95EECOMFYUI\u51FA\u9519 ${n}  ${o.status} ${o.statusText}`);let r=await o.json();if("comfy_error"in r)throw new Error(`serverlog=${r.comfy_error}`);return r}catch(n){throw n.message&&n.message==="Network request failed"?new Error("\u7F51\u7EDC\u9519\u8BEF\uFF0C\u65E0\u6CD5\u8FDE\u63A5\u5230COMFYUI"):n}}function mr(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e==="x"?t:t&3|8;return n.toString(16)})}function pr(e){return new Promise(t=>setTimeout(t,e))}async function gr(e){try{let t=await fetch(e);if(!t.ok)throw new Error(`\u8BBF\u95EECOMFYUI\u51FA\u9519 ${e}  ${t.status} ${t.statusText}`);let n=t.headers.get("Content-Type");if(n&&n.includes("application/json")){let i=await t.json();throw new Error(`serverlog=${i.comfy_error}`)}let o=await t.arrayBuffer();if(o.byteLength<=0)throw new Error("arrayBuffer\u4E3A\u7A7A");let r=t.headers.get("X-Image-Width"),a=t.headers.get("X-Image-Height");return{arrayBuffer:o,width:r,height:a}}catch(t){throw t.message&&t.message==="Network request failed"?new Error("\u7F51\u7EDC\u9519\u8BEF\uFF0C\u65E0\u6CD5\u8FDE\u63A5\u5230COMFYUI"):t}}function Rt(e,t="userSettings"){wx.setStorage({key:t,data:e,success(n){},fail(n){console.error("\u672C\u5730\u6570\u636E\u4FDD\u5B58\u5931\u8D25",n)}})}function wr(e="userSettings"){try{return wx.getStorageSync(e)}catch(t){console.error("\u52A0\u8F7D\u672C\u5730\u6570\u636E\u5931\u8D25",t)}}function hr(e,t="userSettings"){let n=wx.getStorageSync(t);(n==null||n==="")&&(n=[]),n.length>=10&&n.shift(),n.push(e),Rt(n,t)}function yr(e){return e==null||e.trim()===""}function Er(e,t){return Math.floor(Math.random()*(t-e+1))+e}var jt=e=>{let t=e.getFullYear(),n=e.getMonth()+1,o=e.getDate(),r=e.getHours(),a=e.getMinutes(),i=e.getSeconds();return`${[t,n,o].map(Ft).join("/")} ${[r,a,i].map(Ft).join(":")}`},Ft=e=>(e=e.toString(),e[1]?e:`0${e}`),vr=()=>{let e=getCurrentPages();return e[e.length-1].route},br=()=>jt(new Date);function _r(e){try{let t=e.lastIndexOf(".");if(t===-1)return[e,""];let n=e.substring(0,t),o=e.substring(t).toLowerCase();return[n,o]}catch(t){throw console.error("\u63D0\u53D6\u6587\u4EF6\u540D\u548C\u6269\u5C55\u540D\u5931\u8D25:",t),t}}function Ir(){let e=new Date().toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"}),t=Math.round(new Date().getMilliseconds()/100);return`${e}`}Ht.exports={post:dr,get:fr,generateUUID:mr,downloadImage:gr,randInt:Er,getLocal:wr,setLocal:Rt,appendLocal:hr,formatTime:jt,now:br,getCurrPageRoute:vr,isEmpty:yr,sleep:pr,extractFileNameAndExtension:_r,getCurrentTime:Ir}});var X=A((Cs,zt)=>{"use strict";var xs=te(),M=De(),le=V(),ne=$();async function xr(e){return await M.get(`${window.config.comfyuiURL}/models/checkpoints`)}async function Cr(e){return await M.get(`${e}/system_stats`)}async function Mr(e){try{return[!0,(await M.get(`${e}/jinn_test`)).role]}catch{return[!1,""]}}async function Sr(){return await M.get(`${window.config.comfyuiURL}/jinn_get_wf_api_run`)}async function Ar(e){return await M.get(`${window.config.comfyuiURL}/jinn_get_wf_params/${e}`)}async function Tr(e){return await M.get(`${window.config.comfyuiURL}/jinn_get_wf_api/${e}`)}async function Pr(){return(await M.get(`${window.config.comfyuiURL}/jinn_get_workflows`)).items}async function Lr(){return await M.get(`${window.config.comfyuiURL}/jinn_get_workflows_recover`)}async function Dr(e){let t=await M.post(`${window.config.comfyuiURL}/jinn_workflows_recover`,{wfname:e})}async function Br(e){let t=await M.post(`${window.config.comfyuiURL}/jinn_save_wf_new_run`,e)}async function kr(e){let t=await M.post(`${window.config.comfyuiURL}/jinn_save_wf_edit`,e)}async function Or(e){let t=await M.post(`${window.config.comfyuiURL}/jinn_save_wf_del`,e)}async function $r(){let e={},t=await M.post(`${window.config.comfyuiURL}/jinn_interrupt`,e)}async function Ur(e){let t={preview:e},n=await M.post(`${window.config.comfyuiURL}/jinn_set_output_preview`,t)}var He=class extends Error{constructor(t,n){super(t),this.name=this.constructor.name,this.needinfo=n}};async function Nr(e){let t=await M.post(`${window.config.comfyuiURL}/jinn_registry_user`,{user_id:e})}async function qr(e,t,n,o,r,a,i,s=null){s!==!1&&le.log("\u6B63\u5728\u8BF7\u6C42COFMYUI.");let c=M.generateUUID(),l={client_id:c,wfname:e,params:t,debug:o},u=await M.post(`${window.config.comfyuiURL}/jinn_prompt_byid`,l);if(u.verify===!1)throw new He(u.message,u.needinfo);u.verify_message&&(le.error(u.verify_message),alert(u.verify_message));let d=u.prompt_id;return s!==!1&&le.log("\u6B63\u5728\u751F\u6210\u56FE\u7247."),await jr(c,d,n,i,s),s!==!1&&le.log("\u6B63\u5728\u4E0B\u8F7D\u56FE\u7247."),Fr(d,t.output.nodeid,r,a,s)}async function Fr(e,t,n,o,r){let a={prompt_id:e,nodeid:t},i=await M.post(`${window.config.comfyuiURL}/jinn_prompt_result_byid`,a),s=[],c=".jpg";for(let l of i){l.docwidth=o.width,l.docheight=o.height,l.zoom=window.config.outputZoom,c=l.filename.toLowerCase().endsWith(".png")?".png":".jpg";let u=new URLSearchParams(l),d=`${window.config.comfyuiURL}/jinn_view?${u.toString()}`;r!==!1&&le.warn(d);let p=await M.downloadImage(d);s.push(p)}return[s,c]}async function Rr(e){return(await M.get(`${window.config.comfyuiURL}/jinn_get_queue/${e}`)).queue_index}async function jr(e,t,n,o,r){return new Promise((a,i)=>{let s=!1,c=w=>{try{g.close()}catch{}i(new Error(w))},l=window.config.comfyuiURL.replace(/^https?:\/\//,""),d=`${window.config.comfyuiURL.toLowerCase().startsWith("http")?"ws":"wss"}://${l}/ws?clientId=${e}`,p=0,g=new WebSocket(d);g.onerror=function(w){c("WebSocket\u51FA\u9519")},g.onclose=function(w){w.wasClean||c("WebSocket\u610F\u5916\u5173\u95ED: "+w.reason)},g.onmessage=async function(w){let E=w.data;if(typeof E=="string"){let y=JSON.parse(E);switch(y.type){case"executing":if(y.data&&y.data.node&&y.data.node in n){let K=n[y.data.node];K&&K._meta&&K._meta.title&&r!==!1&&le.warn(`\u6B63\u5728\u6267\u884C${K._meta.title}(${y.data.node})`)}break;case"executed":break;case"execution_error":c("\u7B49\u5F85\u65F6\u51FA\u9519,\u8BF7\u67E5\u770BCOMFYUI\u65E5\u5FD7.");break;case"execution_interrupted":c("\u7528\u6237\u4E2D\u6B62\u751F\u56FE.");break;case"execution_success":s=!0;break;case"status":if(s===!0){g.close(),a(!0);break}if(y.data.status.exec_info.queue_remaining==0){c("\u7531\u4E8E\u79CD\u5B50\u6570\u56FA\u5B9A\u7B49\u7CFB\u7EDF\u7F13\u5B58\u539F\u56E0\uFF0C\u5DE5\u4F5C\u6D41\u672A\u88AB\u6267\u884C.");break}let f=await Rr(t);if(f<0){c(`${t}\u4E0D\u5728\u961F\u5217\u4E2D`);break}else f>0&&le.log(`\u5F53\u524D\u6392\u961F\u7B2C${f+1}\u4F4D`);break;case"progress":let{value:m,max:_,node:L}=y.data,D=n[L]._meta?n[L]._meta.title:n[L].class_type;_>1&&r!==!1&&le.progress(D,L,_,m);break;default:}}}})}async function Hr(e,t,n="psupload"){let o=new FormData;o.append("image",e,t),o.append("subfolder",n),o.append("filename",t);let r=await fetch(`${window.config.comfyuiURL}/jinn_upload_image_live`,{method:"POST",body:o});if(r.ok){let a=await r.json();return{path:`${a.subfolder}/${a.name}`,filename:a.name,subfolder:a.subfolder}}else throw new Error(`\u4E0A\u4F20\u56FE\u7247\u5931\u8D25  ${t},${r.status},${r.statusText}`)}async function Wr(e,t,n){let o="psupload",r=new FormData;r.append("image",e,t),r.append("subfolder",o),r.append("filename",t),r.append("minsize",window.config.pszoomMinsize),r.append("maxsize",window.config.pszoomMaxsize),n&&r.append("bounds",`${n.left},${n.top},${n.right},${n.bottom}`);let a=await fetch(`${window.config.comfyuiURL}/jinn_upload_image`,{method:"POST",body:r});if(a.ok){let i=await a.json();return{path:`${i.subfolder}/${i.name}`,filename:i.name,subfolder:i.subfolder}}else throw new Error(`\u4E0A\u4F20\u56FE\u7247\u5931\u8D25  ${t},${a.status},${a.statusText}`)}async function zr(e,t){let n="psupload",o=new FormData;o.append("image",e,t),o.append("subfolder",n),o.append("filename",t);let r=await fetch(`${window.config.comfyuiURL}/jinn_upload_image`,{method:"POST",body:o});if(r.ok){let a=await r.json();return{path:`${a.subfolder}/${a.name}`,filename:a.name,subfolder:a.subfolder}}else throw new Error(`\u4E0A\u4F20\u56FE\u7247\u5931\u8D25  ${t},${r.status},${r.statusText}`)}async function Kr(e,t,n,o){let r="psupload",a=new FormData;a.append("image",e,t),a.append("maskfilename",t),a.append("maskfolder",r),a.append("imagefilename",n.filename),a.append("imagefolder",n.subfolder),a.append("minsize",window.config.pszoomMinsize),a.append("maxsize",window.config.pszoomMaxsize),o&&a.append("bounds",`${o.left},${o.top},${o.right},${o.bottom}`);let i=await fetch(`${window.config.comfyuiURL}/jinn_upload_mask`,{method:"POST",body:a});if(i.ok){let s=await i.json();return`${s.subfolder}/${s.name}`}else throw new Error(`\u4E0A\u4F20\u56FE\u7247\u5931\u8D25  ${t},${i.status},${i.statusText}`)}async function Vr(e){let t={text:e,appid:window.config.transBaiduAppID,appkey:window.config.transBaiduAppKey,from_lang:"zh",to_lang:"en"};return(await M.post(`${window.config.comfyuiURL}/jinn_translate`,t)).result}async function Gr(e){let t={text:e,appid:window.config.transBaiduAppID,appkey:window.config.transBaiduAppKey,from_lang:"en",to_lang:"zh"};return(await M.post(`${window.config.comfyuiURL}/jinn_translate`,t)).result}async function Yr(e,t){let n=await Wt(e,t);try{return n[0]}catch{return[]}}async function Wt(e,t){return await M.get(`${window.config.comfyuiURL}/jinn_get_wf_nodefield_info/${e}/${t}`)}var Xr=new Map;async function Jr(e,t){let n=`${e},${t}`;try{let o=await Wt(e,t),r=o[0],a=o.length>1?o[1]:{},i;if(t.toLowerCase()==="seed"?i=ne.SEED:t.toLowerCase()==="image"||a.hasOwnProperty("image_upload")&&a.image_upload===!0||r==="IMAGE"?i=ne.INPUTIMAGE:Array.isArray(r)?i=ne.FIELDENUM:r==="INT"?a.hasOwnProperty("min")&&a.hasOwnProperty("max")&&t.toLowerCase()==="steps"?(a={min:1,max:20,step:1},i=ne.SLIDER):i=ne.TEXTFIELD:r==="FLOAT"?a.hasOwnProperty("min")&&a.hasOwnProperty("max")&&a.hasOwnProperty("step")&&(i=ne.SLIDER):r==="STRING"&&a.hasOwnProperty("multiline")&&a.multiline===!0&&(i=ne.PROMPTTEXT),i)return Xr.set(n,i),[i,a]}catch(o){console.error("Error guessing field kind:",o)}return[null,null]}zt.exports={VerifyError:He,registry_user:Nr,prompt:qr,uploadImage:Wr,uploadImageBatch:zr,uploadMask:Kr,load_checkpoints:xr,get_wf_params:Ar,get_workflows:Pr,test_comfyui:Cr,test_comfyui_jinn:Mr,get_wf_api:Tr,save_wf_new_run:Br,save_wf_edit:kr,save_wf_del:Or,get_wf_api_run:Sr,get_workflows_recover:Lr,workflows_recover:Dr,interrupt:$r,setOutputPreview:Ur,translateToZH:Gr,translateToEN:Vr,get_wf_nodefield_enum:Yr,guessFieldKind:Jr,uploadImageLive:Hr}});var Xt=A((As,Yt)=>{"use strict";var ke=B("photoshop"),{storage:Ms}=B("uxp"),Ss=B("photoshop").imaging,be=V(),me=$(),Be=ee(),b=te();async function Zr(e,t){if(window.config.setAILayer===me.SETAILAYERCLOSE)try{let n=b.getDocumentByID(e);if(!n)throw new Error(`\u6CA1\u6709\u627E\u5230\u6307\u5B9A\u7684\u56FE\u7247,docid=${e}`);await ke.core.executeAsModal(async o=>{n.layers.forEach(async r=>{r.name===t&&(r.visible=!1)})})}catch(n){be.error(n)}else if(window.config.setAILayer===me.SETAILAYERDEL)try{let n=b.getDocumentByID(e);if(!n)throw new Error(`\u6CA1\u6709\u627E\u5230\u6307\u5B9A\u7684\u56FE\u7247,docid=${e}`);be.log(`\u5220\u9664\u6240\u6709"${t}"\u56FE\u5C42`),await b.deleteLayerByName(n,t,null)}catch(n){be.error(n)}}async function Qr(e,t){let o=await(await Be.getTemporaryFolder()).createFile(t,{overwrite:!0});be.warn(o.nativePath);let r={compression:6,interlaced:!1,embedColorProfile:!0};if(await e.saveAs.png(o,{compression:6}),Be.readArrayBuffer(o).byteLength<=0)throw new Error("arrayBuffer\u4E3A\u7A7A");return o}async function ea(e,t,n){let o=b.getDocumentByID(e);if(!o)throw new Error(`\u6CA1\u6709\u627E\u5230\u6307\u5B9A\u7684\u56FE\u7247,docid=${e}`);return await ke.core.executeAsModal(async r=>{try{return await Qr(o,t)}catch(a){throw be.error(a),new Error("\u5904\u7406PS\u56FE\u50CF\u65F6\u51FA\u9519")}})}function Kt(e,t){let n=e.channels,o=n.length;for(let r=0;r<o;r++)try{let a=n[r];if(a&&a.name===t)return!0}catch{continue}return!1}async function Vt(e){Kt(e,me.TEMP_CHANNEL_NAME)&&await b.executeCommand([{_obj:"select",_target:[{_name:me.TEMP_CHANNEL_NAME,_ref:"channel"}]},{_obj:"delete",_target:[{_enum:"ordinal",_ref:"channel",_value:"targetEnum"}]}]),await b.executeCommand([{_obj:"duplicate",_target:[{_property:"selection",_ref:"channel"}],name:me.TEMP_CHANNEL_NAME},{_obj:"set",_target:[{_property:"selection",_ref:"channel"}],to:{_enum:"ordinal",_value:"none"}}])}async function Gt(e){if(Kt(e,"JinnSelectionChannel")){let t=[{_obj:"select",_target:[{_name:me.TEMP_CHANNEL_NAME,_ref:"channel"}]},{_obj:"set",_target:[{_property:"selection",_ref:"channel"}],to:{_enum:"ordinal",_ref:"channel",_value:"targetEnum"}},{_obj:"delete",_target:[{_enum:"ordinal",_ref:"channel",_value:"targetEnum"}]}];await b.executeCommand(t)}}function ta(e,t,n,o){let r=b.getDocumentSize(e),a=r.width,i=r.height,s=b.getLayerBounds(t);if(n>=a||o>=i)return-1;if(window.config.outputZoom===me.OUTPUT_ZOOM){if(s.width===a||s.height===i)return[-1,-1];let c=s.width/s.height,l=a/i;return c>l?100*i/s.height:100*a/s.width}else return n===s.width||o===s.height?[-1,-1]:100*n/s.width}async function na(e,t,n,o,r){await b.activateDocument(e.id);let a=await b.hasSelection(e.id);a&&await Vt(e);let i=e.activeLayers[0],c={_obj:"placeEvent",null:{_path:await Be.createSessionToken(t),_kind:"local"},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}},l={_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:n}};await b.executeCommand([c,l]);let u=e.activeLayers[0];if(b.layerEqual(i,u))throw new Error("\u521B\u5EFA\u65B0\u56FE\u5C42\u5931\u8D25");let d=ta(e,u,parseInt(o),parseInt(r));if(d>0){let p={_obj:"transform",_target:[{_ref:"layer",_enum:"ordinal",_value:"targetEnum"}],freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSCanvas"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}},width:{_unit:"percentUnit",_value:d},height:{_unit:"percentUnit",_value:d},linked:!0};await b.executeCommand(p)}return a&&await Gt(e),u}function oa(e,t,n,o,r){let a=b.getLayerBounds(t);return[100*(r.right-r.left)/a.width,r.centerX-a.centerX,r.centerY-a.centerY]}async function ra(e,t,n,o,r,a){await b.activateDocument(e.id);let i=await b.hasSelection(e.id);i&&await Vt(e);let s=e.activeLayers[0],l={_obj:"placeEvent",null:{_path:await Be.createSessionToken(t),_kind:"local"},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}},u={_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:n}};await b.executeCommand([l,u]);let d=e.activeLayers[0];if(b.layerEqual(s,d))throw new Error("\u521B\u5EFA\u65B0\u56FE\u5C42\u5931\u8D25");let[p,g,w]=oa(e,d,parseInt(o),parseInt(r),a);if(p>0){let E={_obj:"transform",_target:[{_ref:"layer",_enum:"ordinal",_value:"targetEnum"}],freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSCanvas"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:g},vertical:{_unit:"pixelsUnit",_value:w}},width:{_unit:"percentUnit",_value:p},height:{_unit:"percentUnit",_value:p}};await b.executeCommand(E)}return i&&await Gt(e),d}async function aa(e,t){let n=e.selection,o=await e.createLayer({name:"AIMask",opacity:100,mode:"normal"}),r={_obj:"fill",using:{_enum:"fillContents",_value:"white"},opacity:{_unit:"percentUnit",_value:100},mode:{_enum:"blendMode",_value:"normal"}},a={_obj:"inverse"},i={_obj:"fill",using:{_enum:"fillContents",_value:"black"},opacity:{_unit:"percentUnit",_value:100},mode:{_enum:"blendMode",_value:"normal"}},c=await(await Be.getTemporaryFolder()).createFile(t,{overwrite:!0});return await b.executeCommand([r,a,i]),await e.saveAs.jpg(c,{quality:12}),await o.delete(),await b.executeCommand({_obj:"inverse"}),c}async function ia(e,t){let n=b.getDocumentByID(e);if(await b.activateDocument(n.id),!await b.hasSelection())throw new Error("\u6CA1\u6709\u627E\u5230\u6709\u6548\u9009\u533A\uFF01");if(!n)throw new Error(`\u6CA1\u6709\u627E\u5230\u6307\u5B9A\u7684\u56FE\u7247,docid=${e}`);return await ke.core.executeAsModal(async o=>{try{return await aa(n,t)}catch(r){throw be.error(r),new Error("\u83B7\u53D6\u9009\u533A\u65F6\u51FA\u9519")}})}async function sa(e){try{let t=b.getDocumentByID(e);await b.activateDocument(t.id);let n=await ke.action.batchPlay([{_obj:"get",_target:[{_property:"selection"},{_ref:"document",_enum:"ordinal",_value:"targetEnum"}]}],{});if(n[0].selection&&n[0].selection.bottom){let o={left:n[0].selection.left._value,top:n[0].selection.top._value,right:n[0].selection.right._value,bottom:n[0].selection.bottom._value},r=o.right-o.left,a=o.bottom-o.top;return r=Math.floor(r/8)*8,a=Math.floor(a/8)*8,o.right=o.left+r,o.bottom=o.top+a,o.centerX=(o.right+o.left)/2,o.centerY=(o.bottom+o.top)/2,o}else return null}catch(t){return console.error(t),null}}async function ca(e){try{let t=b.getDocumentByID(e);await b.activateDocument(t.id);let n=await ke.action.batchPlay([{_obj:"get",_target:[{_property:"selection"},{_ref:"document",_enum:"ordinal",_value:"targetEnum"}]}],{});if(!(n[0].selection&&n[0].selection.bottom))return null;let o=b.getDocumentSize(t),r=o.width,a=o.height,i={left:n[0].selection.left._value,top:n[0].selection.top._value,right:n[0].selection.right._value,bottom:n[0].selection.bottom._value},s=i.right-i.left,c=i.bottom-i.top,l=.08,u=Math.max(0,i.left-s*l),d=Math.max(0,i.top-c*l),p=Math.min(r,i.right+s*l),g=Math.min(a,i.bottom+c*l),w=p-u,E=g-d;w-=w%8,E-=E%8,p=u+w,g=d+E;let y={left:Math.round(u),top:Math.round(d),right:Math.round(p),bottom:Math.round(g)};return y.centerX=(y.right+y.left)/2,y.centerY=(y.bottom+y.top)/2,y}catch(t){return console.error(t),null}}Yt.exports={addLayerImage:na,addLayerImageRegion:ra,createPSImage:ea,preparePSImage:Zr,createSelectionMask:ia,getSelectionBounds:sa,getSelectionSmartBounds:ca}});var We=A((Ts,tn)=>{"use strict";var oe=X(),Jt=te(),G=Xt(),T=V(),{app:Oe}=B("photoshop"),_e=$(),la=document.getElementById("wfButtonContainer"),ua=document.getElementById("btnPrompt"),da=document.getElementById("logContainer"),Zt=document.getElementById("btnSettings"),Qt=document.getElementById("btnInterrupt"),fa=document.getElementById("wfParamContainer"),ma=document.getElementById("wfPreviewImage"),at=document.getElementById("lSimpleLog"),pa=document.getElementById("wfMainToolbar");function st(e){Array.from(la.children).forEach(t=>{t.disabled=e}),pa.querySelectorAll("*").forEach(t=>{t.disabled=e}),ua.disabled=e,Zt.disabled=e,Zt.style.display=e?"none":"flex",Qt.disabled=!e,Qt.style.display=e?"flex":"none",fa.querySelectorAll("*").forEach(t=>{t.hasAttribute("data-keep-disabled")||(t.disabled=e)}),at.textContent="",e?at.style.display=window.config.promptMode===_e.PROMPTMODE_BATCH?"block":"none":at.style.display="none"}function ga(){ct=!1,window.showSingle(da),T.clearLog(),st(!0)}function it(){ct=!1,st(!1)}async function en(e,t,n){T.warn("\u6B63\u5728\u8BFB\u53D6PS\u56FE\u50CF");let o=n===0?"psimage.png":`psimage${n}.png`,r=await G.createPSImage(t.docid,o,e),a=await oe.uploadImage(r,o);return T.warn(a.path),t.value=a.path,a}async function wa(e,t,n){T.warn("\u6B63\u5728\u8BFB\u53D6PS\u9009\u533A");let o=t===0?"psmask.jpg":`psmask${t}.jpg`,r=t===0?"psmask.png":`psmask${t}.png`,a=await G.createSelectionMask(e.docid,o),i=await oe.uploadMask(a,r,n);return T.warn(i),e.value=i,i}async function ha(e,t){T.warn("\u6B63\u5728\u8BFB\u53D6PS\u9009\u533A\u4F5C\u4E3A\u8499\u677F");let n=t===0?"psimagemask.jpg":`psimagemask${t}.jpg`,o=await G.createSelectionMask(e.docid,n),r=await oe.uploadImage(o,n);return T.warn(r.path),e.value=r.path,r}async function ya(e,t,n){T.warn("\u6B63\u5728\u8BFB\u53D6PS\u9009\u533A\u4F5C\u4E3A\u56FE\u50CF");let o=n===0?"psregion.png":`psregion${n}.png`,r=await G.getSelectionBounds(t.docid);if(!r)throw new Error("\u6CA1\u6709\u627E\u5230\u9009\u533A");let a=await G.createPSImage(t.docid,o,e),i=await oe.uploadImage(a,o,r);return T.warn(i.path),t.value=i.path,r}async function Ea(e,t,n){T.warn("\u6B63\u5728\u8BFB\u53D6PS\u9009\u533A\u4F5C\u4E3A\u56FE\u50CF\u53CA\u8499\u677F");let o=n===0?"psareaimg.png":`psareaimg${n}.png`,r=await G.getSelectionSmartBounds(t.docid);if(!r)throw new Error("\u6CA1\u6709\u627E\u5230\u9009\u533A");let a=await G.createPSImage(t.docid,o,e),i=await oe.uploadImage(a,o,r);T.warn(i.path);let s=n===0?"psareamask.jpg":`psareamask${n}.jpg`,c=n===0?"psareamask.png":`psareamask${n}.png`,l=await G.createSelectionMask(t.docid,s),u=await oe.uploadMask(l,c,i,r);return T.warn(u),t.value=u,r}function va(e){let t=new Image;t.src=e,ma.src=t.src}async function ba(e,t,n){ga();let o=null;try{if(t.needimage){if(!Oe.activeDocument){T.error("\u8BF7\u5148\u6253\u5F00\u4E00\u5F20\u56FE\u7247\uFF01"),it();return}}else Oe.activeDocument||await Jt.createDocument();await G.preparePSImage(Oe.activeDocument.id,e);let r=t.params.filter(a=>a.kind===_e.INPUTIMAGEMASK);for(let a=0;a<r.length;a++){let i=r[a],s=await en(e,i,a+1);await wa(i,a,s)}r=t.params.filter(a=>a.kind===_e.INPUTIMAGE);for(let a=0;a<r.length;a++){let i=r[a];await en(e,i,a)}r=t.params.filter(a=>a.kind===_e.INPUTMASK);for(let a=0;a<r.length;a++){let i=r[a];await ha(i,a)}r=t.params.filter(a=>a.kind===_e.INPUTREGION);for(let a=0;a<r.length;a++){let i=r[a];o=await ya(e,i,a)}r=t.params.filter(a=>a.kind===_e.INPUTREGIONMASK);for(let a=0;a<r.length;a++){let i=r[a];o=await Ea(e,i,a)}}catch(r){T.error(r),it();return}try{let[r,a]=await oe.prompt(e,t,n,window.config.showDetailLog,window.config.outputZoom,{width:100,height:100},va);T.log("\u6B63\u5728\u5B58\u50A8AI\u56FE\u50CF\u6587\u4EF6");let i=[];for(let s=0;s<r.length;s++){let{arrayBuffer:c,width:l,height:u}=r[s],d=await Jt.saveTempFile(c,s===0?`cfimage${a}`:`cfimage${s+1}${a}`);T.warn(d.nativePath,`${l}*${u}`),i.push([d,l,u])}if(T.log("\u6B63\u5728\u6DFB\u52A0\u5230\u56FE\u5C42"),o)for(let[s,c,l]of i)await G.addLayerImageRegion(Oe.activeDocument,s,e,c,l,o);else for(let[s,c,l]of i)await G.addLayerImage(Oe.activeDocument,s,e,c,l);T.log("\u751F\u56FE\u6210\u529F")}catch(r){T.error(r),r instanceof oe.VerifyError&&document.dispatchEvent(new CustomEvent("verifyUserEvent",{detail:{error:r}}))}finally{it()}}var ct=!1;async function _a(){try{ct=!0,await oe.interrupt(),T.error("\u5C1D\u8BD5\u4E2D\u6B62\u751F\u56FE...")}catch(e){T.error(e)}}tn.exports={prompt:ba,interruptPrompt:_a,DisabledUI:st}});var an=A((ks,rn)=>{"use strict";var nn=B("photoshop"),{storage:Ps}=B("uxp"),Ls=B("photoshop").imaging,lt=V(),Ds=$(),on=ee(),pe=te();async function Ia(e,t){try{await pe.deleteLayerByName(e,t,null)}catch(n){lt.error(n)}}async function xa(e,t,n){return await nn.core.executeAsModal(async o=>{try{let a=await(await on.getTemporaryFolder()).createFile(t,{overwrite:!0});return n&&lt.warn(a.nativePath),await e.saveAs.jpg(a,{quality:6}),a}catch(r){throw lt.error(r),new Error("\u5904\u7406PS\u56FE\u50CF\u65F6\u51FA\u9519")}})}function Ca(e,t,n,o){let r=pe.getDocumentSize(e),a=r.width,i=r.height,s=pe.getLayerBounds(t),c=s.width>=s.height?n*100/s.width:o*100/s.height,l,u;return l=a*3/4,u=i/2,[c,l-s.centerX,u-s.centerY]}var{ElementPlacement:Bs}=nn.constants;async function Ma(e,t,n,o,r){let a=e.activeLayers,i=a.length>0?a[0]:null,c={_obj:"placeEvent",null:{_path:await on.createSessionToken(t),_kind:"local"},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}},l={_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:n}};await pe.executeCommand([c,l],e.id);let u=e.activeLayers[0];await pe.deleteLayerByName(e,n,u);let[d,p,g]=Ca(e,u,o,r);if(d>0){let w={_obj:"transform",_target:[{_ref:"layer",_enum:"ordinal",_value:"targetEnum"}],freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSCanvas"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:p},vertical:{_unit:"pixelsUnit",_value:g}},width:{_unit:"percentUnit",_value:d},height:{_unit:"percentUnit",_value:d}};await pe.executeCommand(w,e.id)}try{if(i)try{let w={_obj:"select",_target:[{_ref:"layer",_id:i.id}],makeVisible:!1};await pe.executeCommand(w,e.id)}catch{}}catch{}return u}rn.exports={preparePSImageLive:Ia,createPSImageLive:xa,addLayerImageLive:Ma}});var mn=A((Os,fn)=>{"use strict";var $e=X(),Sa=De(),ut=te(),sn=an(),q=V(),{app:cn}=B("photoshop"),Ie=$(),Aa=We(),ln=document.getElementById("btnInterrupt"),Ta=document.getElementById("wfButtonContainer"),Pa=document.getElementById("btnPrompt"),La=document.getElementById("logContainer"),un=document.getElementById("btnSettings"),dt=document.getElementById("lSimpleLog");function Da(){ge=!1,window.showSingle(La),q.clearLog(),console.clear();let e=!0;Array.from(Ta.children).forEach(t=>{t.disabled=e}),Pa.disabled=e,un.disabled=e,un.style.display=e?"none":"flex",ln.disabled=!e,ln.style.display=e?"flex":"none",dt.textContent="",e?dt.style.display=window.config.promptMode===Ie.PROMPTMODE_BATCH?"block":"none":dt.style.display="none"}function dn(){ge=!1,Aa.DisabledUI(!1)}var ft=class{constructor(t,n,o){this.wfname=t,this.params=n,this.apidata=o;let r=n.params.filter(i=>i.kind===Ie.INPUTIMAGE);if(r.length!==1)throw new Error('\u6709\u4E14\u53EA\u80FD\u6709\u4E00\u4E2A"\u83B7\u53D6\u56FE\u7247"\u6761\u4EF6');this.param=r[0];let a=String(Math.round(new Date().getMilliseconds()));if(this.filename=`pslive${a}.jpg`,!cn.activeDocument)throw new Error("\u8BF7\u5148\u6253\u5F00\u4E00\u5F20\u56FE\u7247\uFF01");this.doc=cn.activeDocument,this.docid=this.doc.id,this.outputWidth=-1,this.outputHeight=-1,this.firstLivePrompt=!0,this.docLastChangedTime=0,this.liveRunning=!1,this.sensitivity=window.config.livePromptSensitivity*1e3,this.inactivityTimer=null,ut.addNotificationListenerForHistory(this.linstener),this.promptLiveOne()}linstener=async(t,n)=>{if(n.documentID===this.docid&&!this.liveRunning){if(!Ie.LIVE_ACTIVE_PS_TOOLS.includes(n.name))return;clearTimeout(this.inactivityTimer),this.sensitivity===0?this.promptLiveOne():this.inactivityTimer=setTimeout(()=>{this.promptLiveOne()},this.sensitivity)}};promptLiveOne=async()=>{try{if(this.liveRunning=!0,ge)throw ge=!1,new Error("\u7528\u6237\u4E2D\u6B62\u751F\u56FE");q.log("\u5F00\u59CB\u751F\u56FE"),this.firstLivePrompt&&q.log("\u6B63\u5728\u8BFB\u53D6PS\u56FE\u50CF");let t=await sn.createPSImageLive(this.doc,this.filename,this.firstLivePrompt),n=await $e.uploadImageLive(t,this.filename);this.firstLivePrompt&&q.warn(n.path),this.param.value=n.path;let o=this.outputWidth===-1?Ie.OUTPUT_ZOOM:Ie.OUTPUT_NOZOOM,[r,a]=await $e.prompt(this.wfname,this.params,this.apidata,window.config.showDetailLog,o,{width:100,height:100},null,this.firstLivePrompt),{arrayBuffer:i,width:s,height:c}=r[0];this.outputWidth===-1&&(this.outputWidth=s,this.outputHeight=c),this.firstLivePrompt&&q.log("\u6B63\u5728\u5B58\u50A8AI\u56FE\u50CF\u6587\u4EF6");let l=await ut.saveTempFile(i,"cfimage.jpg");this.firstLivePrompt&&q.warn(l.nativePath,`${s}*${c}`),this.firstLivePrompt&&q.log("\u6B63\u5728\u6DFB\u52A0\u5230\u56FE\u5C42");let u=await sn.addLayerImageLive(this.doc,l,this.wfname,this.outputWidth,this.outputHeight);if(this.firstLivePrompt=!1,q.log(`${Sa.getCurrentTime()}\u751F\u56FE\u6210\u529F`),ge)throw ge=!1,new Error("\u7528\u6237\u4E2D\u6B62\u751F\u56FE")}catch(t){q.error(t),this.stopLive(),t instanceof $e.VerifyError&&document.dispatchEvent(new CustomEvent("verifyUserEvent",{detail:{error:t}}))}finally{this.liveRunning=!1}};stopLive=async()=>{try{ut.removeNotificationListenerForHistory(this.linstener)}catch(t){console.error(t)}dn(),Y=null};paramChanged=async(t,n,o,r)=>{let a=this.params.params.find(i=>i.nodeid===n&&i.field===o);if(a){if(a.value=r,t===Ie.PROMPTTEXT){let i=r;window.config.transEnable&&r&&(i=await $e.translateToEN(r)),a.valueen=i}this.liveRunning||this.promptLiveOne()}}},Y;async function Ba(e,t,n){try{Da(),Y=new ft(e,t,n)}catch(o){q.error(o),Y&&Y.stopLive(),dn()}}var ge=!1;async function ka(){try{if(Y&&!Y.liveRunning){Y.stopLive(),q.error("\u7528\u6237\u4E2D\u6B62\u751F\u56FE");return}ge=!0,await $e.interrupt(),q.error("\u5C1D\u8BD5\u4E2D\u6B62\u751F\u56FE...")}catch(e){q.error(e)}}function Oa(){try{let e=document.getElementById("wfBatchPromptHelpDialog");if(e){e.showModal();return}e=document.createElement("dialog"),e.id="wfBatchPromptHelpDialog",e.style.cssText="width: 800px;height: 500px;display: flex;flex-direction: column;";let t=document.createElement("div");t.style.cssText="max-width: 100%;max-height: 100%;overflow: auto;margin: 5px;gap: 5px;display: flex;flex-direction: column;";let n=document.createElement("sp-body");n.innerHTML=`\u5B9E\u65F6\u7ED8\u753B\uFF1A<br>
        \u53EA\u9488\u5BF9\u5F53\u524D\u56FE\u7247\u64CD\u4F5C<br>
        \u5FC5\u987B\u6709\u4E00\u4E2A"\u83B7\u53D6\u56FE\u7247"\u6761\u4EF6<br>
        \u5728\u5F53\u524D\u56FE\u7247\u7684\u5DE6\u534A\u533A\u57DF\u6D82\u9E26\u7ED8\u5236\u8349\u56FE\uFF0C\u5728\u5F53\u524D\u56FE\u7247\u7684\u53F3\u534A\u533A\u57DF\u663E\u793A\u751F\u6210\u7684\u56FE\u7247<br>
        \u6BCF\u6B21\u53EA\u751F\u6210\u4E00\u5F20\u56FE\u7247(\u4E0D\u652F\u6301\u591A\u6279\u6B21)<br>
        \u751F\u56FE\u65F6\u4E0D\u8981\u53D8\u66F4\u5F53\u524D\u6587\u4EF6\uFF0C\u4E0D\u8981\u4FEE\u6539\u753B\u5E03\u5C3A\u5BF8<br>
        \u751F\u56FE\u7075\u654F\u5EA6:\u5047\u5982\u503C\u4E3A2,\u5219\u5F53\u505C\u6B62\u7ED8\u753B2\u79D2\u540E,\u5F00\u59CB\u7ED8\u5236\u4E00\u5F20AI\u56FE\u7247<br>
        \u53EA\u9488\u5BF9\u753B\u7B14\u5DE5\u5177\uFF08B\uFF09\uFF0C\u6A61\u76AE\u64E6\u5DE5\u5177\uFF08E\uFF09\u7B49\u5C11\u6570\u51E0\u79CD\u5DE5\u5177\u5B9E\u65F6\u751F\u56FE<br>
        \u5982\u679C\u4FEE\u6539\u753B\u5E03\u5185\u5BB9\u540E\u672A\u751F\u56FE\uFF0C\u53EF\u4EE5\u7528\u753B\u7B14\u5DE5\u5177\u968F\u610F\u753B\u4E00\u7B14<br>


        `,t.appendChild(n),e.appendChild(t),document.body.appendChild(e),e.showModal()}catch(e){q.error(e)}}function $a(e){try{let t=e.currentTarget.value;window.config.livePromptSensitivity=t,window.saveConfig(),Y&&(Y.sensitivity=parseInt(t*1e3))}catch(t){console.error(t)}}function Ua(e){try{if(Y){let t=e.currentTarget.value,n=e.currentTarget.getAttribute("data-kind"),o=e.currentTarget.getAttribute("data-nodeid"),r=e.currentTarget.getAttribute("data-field");Y.paramChanged(n,o,r,t)}}catch(t){console.error(t)}}fn.exports={interruptPrompt:ka,promptLive:Ba,showHelp:Oa,sensitivityChanged:$a,paramChanged:Ua}});var wn=A((qs,gn)=>{"use strict";var xe=B("photoshop"),{storage:$s}=B("uxp"),Us=B("photoshop").imaging,pn=V(),Ns=$(),Na=ee(),J=te();function qa(e){switch(e){case 1:return[1024,512];case 2:return[1536,512];case 3:return[1024,1024]}}function Fa(e,t,n,o){let r=J.getDocumentSize(e),a=r.width,i=r.height,s=J.getLayerBounds(t),c=s.width>=s.height?512*100/s.width:512*100/s.height,l,u;switch(n){case 1:l=256+512*o,u=256;break;case 2:l=256+512*o,u=256;break;case 3:let d=Math.floor(o/2),p=o%2;l=256+512*d,u=256+512*p;break}return[c,l-s.centerX,u-s.centerY]}async function Ra(e,t){try{await xe.core.executeAsModal(async n=>{e.layers.forEach(async o=>{o.name!=="\u80CC\u666F"&&o.delete()})})}catch(n){pn.error(n)}}async function ja(e,t,n,o,r){await J.activateDocument(e.id);let a=e.activeLayers[0],s={_obj:"placeEvent",null:{_path:await Na.createSessionToken(t),_kind:"local"},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}},c={_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:n}};await J.executeCommand([s,c]);let l=e.activeLayers[0];if(J.layerEqual(a,l))throw new Error("\u521B\u5EFA\u65B0\u56FE\u5C42\u5931\u8D25");let[u,d,p]=Fa(e,l,o,r);if(u>0){let g={_obj:"transform",_target:[{_ref:"layer",_enum:"ordinal",_value:"targetEnum"}],freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSCanvas"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:d},vertical:{_unit:"pixelsUnit",_value:p}},width:{_unit:"percentUnit",_value:u},height:{_unit:"percentUnit",_value:u}};await J.executeCommand(g)}}async function Ha(e){try{pn.log("\u6B63\u5728\u6E05\u9664\u5386\u53F2\u8BB0\u5F55"),await J.activateDocument(e.id);let t={_obj:"clearEvent",_target:[{_property:"historyStates",_ref:"property"},{_enum:"ordinal",_ref:"document",_value:"targetEnum"}]};await J.executeCommand(t)}catch(t){console.error(t)}}async function Wa(e){let[t,n]=qa(e);if(xe.app.activeDocument){let a=J.getDocumentSize(xe.app.activeDocument);if(t===a.width&&n===a.height)return xe.app.activeDocument}let o=await xe.core.executeAsModal(async a=>await xe.app.documents.add({name:"\u6279\u91CF\u751F\u56FE",width:t,height:n,resolution:72,fill:"black"}));if(!o)throw new Error("\u521B\u5EFA\u65B0\u56FE\u7247\u5931\u8D25");let r={_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:"\u80CC\u666F"}};return await J.executeCommand(r),o}gn.exports={createDocumentForBatch:Wa,preparePSImageBatch:Ra,addLayerImageBatch:ja,clearHistory:Ha}});var bn=A((Gs,vn)=>{"use strict";var ze=X(),hn=De(),za=te(),Ue=wn(),En=We(),S=ee(),W=V(),{app:Fs}=B("photoshop"),z=$(),Ka=document.getElementById("lSimpleLog"),Rs=document.getElementById("wfButtonContainer"),js=document.getElementById("btnPrompt"),Va=document.getElementById("logContainer"),Hs=document.getElementById("btnSettings"),Ws=document.getElementById("btnInterrupt"),zs=document.getElementById("wfParamContainer"),Ks=document.getElementById("wfPreviewImage"),Vs=document.getElementById("wfMainToolbar");function Ga(){Ne=!1,window.showSingle(Va),W.clearLog(),console.clear(),En.DisabledUI(!0)}function Ya(){Ne=!1,En.DisabledUI(!1)}var mt=class{constructor(){}creatDoc=async()=>{this.outputDoc=await Ue.createDocumentForBatch(this.batchImageParams.length)};promptBatch=async(t,n,o,r)=>{Ga();try{this.batchImageParams=r;let a=S.joinPath(n.output.folderbatch,z.BATCH_TASK_FILE_NAME),[i,s]=await S.readJsonFile(a),c=S.joinPath(n.output.folderbatch,z.BATCH_OUTPUT_FILE_NAME),[l,u]=await S.readJsonFile(c),d=await S.getEntryWithUrl(`file:${n.output.folderbatch}`),p=r.find(E=>E.batchnamed===!0);p||(p=r[0]);let g=s[p.valuefolder],w=0;for(let E=u.output.length;E<g.length;E++){if(Ne)throw Ne=!1,new Error("\u7528\u6237\u4E2D\u6B62\u751F\u56FE");window.config.batchPromptPreview&&!this.outputDoc&&await this.creatDoc(),Ka.textContent=`${E+1}/${g.length}`;let y=g[E];W.log(`${E+1}/${g.length}`);let f=[];for(let m=0;m<r.length;m++){let _=r[m].valuefolder,L=s[_][E];if(L===void 0){W.error(`\u6587\u4EF6\u5939\u4E2D\u56FE\u7247\u6570\u91CF\u4E0D\u8DB3(${z.VALID_IMAGE_EXTENSIONS.join(" ")}):${_}`);return}let D=await S.getEntryWithUrl(S.joinPath(_,L));f.push(D)}await this.promptBatchOne(t,n,o,r,f,E,y,d,l,u),w>=2?document.dispatchEvent(new CustomEvent("wfChangeLogSimpleEvent",{detail:{}})):w+=1}}catch(a){W.error(a),a instanceof ze.VerifyError&&document.dispatchEvent(new CustomEvent("verifyUserEvent",{detail:{error:a}}))}finally{Ya()}};promptBatchOne=async(t,n,o,r,a,i,s,c,l,u)=>{this.outputDoc&&await Ue.preparePSImageBatch(this.outputDoc,t);for(let f=0;f<r.length;f++){let m=a[f],_=await ze.uploadImageBatch(m,m.name);W.warn(_.path),r[f].value=_.path,this.outputDoc&&await Ue.addLayerImageBatch(this.outputDoc,m,t,r.length,f)}let[d,p]=hn.extractFileNameAndExtension(s),[g,w]=await ze.prompt(t,n,o,window.config.showDetailLog,z.OUTPUT_NOZOOM,{width:100,height:100},null);W.log("\u6B63\u5728\u5B58\u50A8\u6587\u4EF6");let E=[],y=[];for(let f=0;f<g.length;f++){let{arrayBuffer:m,width:_,height:L}=g[f],D=await za.saveTempFile(m,f===0?`cfimage${w}`:`cfimage${f+1}${w}`);W.warn(D.nativePath,`${_}*${L}`),E.push(D);let K=f===0?`${d}${w}`:`${d}${f+1}${w}`,fe=await c.createFile(K,{overwrite:!0});await S.writeArrayBuffer(fe,m),y.push(K)}if(u.output.push(y),W.log("\u6B63\u5728\u6DFB\u52A0\u5230\u56FE\u5C42"),this.outputDoc)for(let f of E)await Ue.addLayerImageBatch(this.outputDoc,f,t,r.length,r.length);window.config.batchPromptPause>0&&(W.log(`\u7761\u7720${window.config.batchPromptPause}\u79D2`),await hn.sleep(window.config.batchPromptPause*1e3)),await S.writeJsonFile(l,u),this.outputDoc&&await Ue.clearHistory(this.outputDoc),W.log("\u751F\u56FE\u6210\u529F")}};async function Xa(e){let t=S.joinPath(e,z.BATCH_TASK_FILE_NAME);if(!await S.fileExists(t))return!1;let n=S.joinPath(e,z.BATCH_OUTPUT_FILE_NAME);if(!await S.fileExists(n))return!1;let[o,r]=await S.readJsonFile(n);return r.output.length>0}async function Ja(e,t,n,o){let r=S.joinPath(t.output.folderbatch,z.BATCH_TASK_FILE_NAME),a={};for(let s=0;s<o.length;s++){let c=o[s].valuefolder,l=await S.getImageFileNamesFromFolder(c,z.VALID_IMAGE_EXTENSIONS);if(l.length===0)throw new Error(`\u6587\u4EF6\u5939\u4E2D\u6CA1\u6709\u6709\u6548\u7684\u56FE\u7247(${z.VALID_IMAGE_EXTENSIONS.join(" ")}):${c}`);a[c]=l}await S.createJsonFile(r,a);let i=S.joinPath(t.output.folderbatch,z.BATCH_OUTPUT_FILE_NAME);await S.createJsonFile(i,{output:[]})}async function Za(e,t,n,o){let r=S.joinPath(t.output.folderbatch,z.BATCH_TASK_FILE_NAME),[a,i]=await S.readJsonFile(r),s=S.joinPath(t.output.folderbatch,z.BATCH_OUTPUT_FILE_NAME),[c,l]=await S.readJsonFile(s);for(let u=0;u<o.length;u++){let d=o[u].valuefolder;if(!i.hasOwnProperty(d))throw new Error(`\u7B2C${u+1}\u4E2A\u6587\u4EF6\u5939\uFF0C${d},\u8BE5\u76EE\u5F55\u5728\u4EFB\u52A1\u6587\u4EF6\u4E2D\u4E0D\u5B58\u5728\uFF0C\u8BF7\u4FEE\u6539\u5DE5\u4F5C\u6D41\u6216\u91CD\u65B0\u9009\u62E9\u7A7A\u7684\u8F93\u51FA\u6587\u4EF6\u5939`);if(u===0&&i[d].length<=l.output.length)throw new Error(`\u8F93\u5165\u76EE\u5F55${d}\u4E2D\u6709${i[d].length}\u5F20\u56FE\u7247,\u5DF2\u751F\u6210${l.output.length}\u5F20\u7ED3\u679C\u56FE\u7247.\u5F53\u524D\u4EFB\u52A1\u5DF2\u7ECF\u5B8C\u7ED3.`)}}function Qa(){try{let e=document.getElementById("wfBatchPromptHelpDialog");if(e){e.showModal();return}e=document.createElement("dialog"),e.id="wfBatchPromptHelpDialog",e.style.cssText="width: 800px;height: 500px;display: flex;flex-direction: column;";let t=document.createElement("div");t.style.cssText="max-width: 100%;max-height: 100%;overflow: auto;margin: 5px;gap: 5px;display: flex;flex-direction: column;";let n=document.createElement("sp-body");n.innerHTML=`\u6279\u91CF\u751F\u56FE\uFF1A<br>
        \u53EF\u4EE5\u6307\u5B9A\u4E00\u81F3\u4E09\u4E2A\u8F93\u5165\u76EE\u5F55<br>
        \u53EF\u4EE5\u4E2D\u65AD\u540E\u7EE7\u7EED\u6267\u884C\u672A\u5B8C\u6210\u7684\u4EFB\u52A1<br>
        \u652F\u6301\u7684\u56FE\u7247\u7C7B\u578B\u5305\u62EC${z.VALID_IMAGE_EXTENSIONS.join(" ")}<br>
        \u751F\u6210\u7684\u56FE\u7247\u5C06\u4EE5\u7B2C\u4E00\u4E2A\u8F93\u5165\u6587\u4EF6\u5939\u4E2D\u7684\u56FE\u7247\u540D\u79F0\u6765\u547D\u540D<br>
        \u5F00\u59CB\u6279\u91CF\u751F\u56FE\u540E\uFF0C\u4E0D\u8981\u968F\u610F\u53D8\u66F4\u8F93\u5165\u6587\u4EF6\u5939\u53CA\u5176\u4E2D\u7684\u56FE\u7247\uFF0C\u4EE5\u514D\u53D1\u751F\u672A\u77E5\u9519\u8BEF<br>
        \u5F00\u59CB\u6279\u91CF\u751F\u56FE\u540E\uFF0C\u4E0D\u8981\u4FEE\u6539\u6216\u5220\u9664\u8F93\u51FA\u76EE\u5F55\u4E2D\u7684JSON\u6587\u4EF6\uFF0C\u4EE5\u514D\u53D1\u751F\u672A\u77E5\u9519\u8BEF<br>
        \u6279\u5904\u7406\u65F6\uFF0C\u4E0D\u4F1A\u7EA6\u675F\u56FE\u7247\u6587\u4EF6\u7684\u5927\u5C0F\uFF0C\u8BF7\u5728\u5DE5\u4F5C\u6D41\u4E2D\u8FDB\u884C\u9650\u5B9A\uFF0C\u4EE5\u514D\u7206\u663E\u5B58<br>
        `,t.appendChild(n),e.appendChild(t),document.body.appendChild(e),e.showModal()}catch(e){W.error(e)}}var yn;function ei(e,t,n,o){yn=new mt,yn.promptBatch(e,t,n,o)}var Ne=!1;async function ti(){try{Ne=!0,await ze.interrupt(),W.error("\u5C1D\u8BD5\u4E2D\u6B62\u751F\u56FE...")}catch(e){W.error(e)}}vn.exports={promptBatch:ei,hasBatchTask:Xa,createBatchTask:Ja,checkBatchTask:Za,showHelp:Qa,interruptPrompt:ti}});var In=A((Ys,_n)=>{"use strict";var re=null,pt=null,Ke=null;function ni(){pt=document.getElementById("wfMgrNodeDialog"),re=document.getElementById("wfMgrNodeDialogListNode"),Ke=document.getElementById("wfMgrNodeDialogOKButton"),re.addEventListener("click",e=>{try{e.target.tagName==="SP-MENU-ITEM"&&(re.querySelectorAll("sp-menu-item").forEach(t=>t.removeAttribute("selected")),e.target.setAttribute("selected",!0))}catch(t){throw console.error(t),alert(t),t;return}}),re.addEventListener("dblclick",e=>{e.target.tagName==="SP-MENU-ITEM"&&Ke.dispatchEvent(new Event("click"))})}function oi(e){re.innerHTML="";for(let t in e){let n=e[t],o=n.fields,r=n.nodeclass,a=n.nodetitle;if(Object.keys(o).length===0)continue;let i=document.createElement("sp-menu-item");i.textContent=`${a}(\u7F16\u53F7${t})`,i.setAttribute("data-nodeid",t),i.setAttribute("data-nodetitle",a),i.setAttribute("data-nodeclass",r),re.appendChild(i)}}function ri(e,t,n){oi(e);let o=null;t&&(o=re.querySelector(`sp-menu-item[data-nodeid="${t}"]`)),t&&o?o.setAttribute("selected",!0):re.querySelectorAll("sp-menu-item").forEach(r=>{r.removeAttribute("selected")}),Ke.addEventListener("click",function r(){Ke.removeEventListener("click",r);try{let a=re.querySelector("sp-menu-item[selected]");if(!a)return;let i=a.getAttribute("data-nodeid"),s=a.getAttribute("data-nodetitle"),c=a.getAttribute("data-nodeclass");pt.close(),n(i,s,c)}catch(a){throw console.error(a),alert(a),a;return}}),pt.showModal()}_n.exports={initShow:ni,show:ri}});var Mn=A((Xs,Cn)=>{"use strict";var xn=X(),Ce,gt,wt;function ai(){gt=document.getElementById("wfMgrRecoverDialog"),Ce=document.getElementById("wfMgrRecoverList"),wt=document.getElementById("wfMgrRecoverDialogOKButton"),Ce.addEventListener("click",e=>{try{e.target.tagName==="SP-MENU-ITEM"&&(Ce.querySelectorAll("sp-menu-item").forEach(t=>t.removeAttribute("selected")),e.target.setAttribute("selected",!0))}catch(t){throw console.error(t),alert(t),t;return}})}function ii(e){Ce.innerHTML="";for(let t of e){let n=document.createElement("sp-menu-item");n.textContent=`${t}`,n.setAttribute("data-wfname",t),Ce.appendChild(n)}}async function si(e){let t=await xn.get_workflows_recover();ii(t),wt.addEventListener("click",async function n(){wt.removeEventListener("click",n);try{let o=Ce.querySelector("sp-menu-item[selected]");if(!o)return;let r=o.getAttribute("data-wfname");await xn.workflows_recover(r),gt.close(),e(r)}catch(o){throw console.error(o),alert(o),o;return}}),gt.showModal()}Cn.exports={initShow:ai,show:si}});var An=A((Js,Sn)=>{"use strict";var ue=null,ae=null,ht=null,Ve=null;function ci(){ht=document.getElementById("wfMgrNodeFieldDialog"),ue=document.getElementById("wfMgrNodeFieldDialogListNode"),ae=document.getElementById("wfMgrNodeFieldDialogListField"),Ve=document.getElementById("wfMgrNodeFieldDialogOKButton"),ue.addEventListener("click",e=>{try{if(e.target.tagName==="SP-MENU-ITEM"){ue.querySelectorAll("sp-menu-item").forEach(n=>n.removeAttribute("selected")),e.target.setAttribute("selected",!0);let t=e.target.getAttribute("data-nodeid");yt(t)}}catch(t){throw console.error(t),alert(t),t;return}}),ae.addEventListener("click",e=>{e.target.tagName==="SP-MENU-ITEM"&&(ae.querySelectorAll("sp-menu-item").forEach(t=>t.removeAttribute("selected")),e.target.setAttribute("selected",!0))}),ae.addEventListener("dblclick",e=>{e.target.tagName==="SP-MENU-ITEM"&&Ve.dispatchEvent(new Event("click"))})}function yt(e=null,t=null){ae.innerHTML="";let n=Ge[e],o=n?n.fields:{},r=!1;for(let a in o){let i=document.createElement("sp-menu-item");i.textContent=a,i.setAttribute("data-field",a),i.setAttribute("data-value",o[a]),a===t&&i.setAttribute("selected",!0),ae.appendChild(i)}!r&&ae.children.length===1&&ae.children[0].setAttribute("selected",!0)}function li(){ue.innerHTML="";for(let e in Ge){let t=Ge[e],n=t.fields,o=t.nodeclass,r=t.nodetitle;if(Object.keys(n).length===0)continue;let a=document.createElement("sp-menu-item");a.textContent=`${r}(\u7F16\u53F7${e})`,a.setAttribute("data-nodeid",e),a.setAttribute("data-nodetitle",r),a.setAttribute("data-nodeclass",o),ue.appendChild(a)}}var Ge=null;function ui(e,t,n,o){Ge=e,li();let r=null;t&&(r=ue.querySelector(`sp-menu-item[data-nodeid="${t}"]`)),t&&r?(r.setAttribute("selected",!0),yt(t,n)):(ue.querySelectorAll("sp-menu-item").forEach(a=>{a.removeAttribute("selected")}),yt()),Ve.addEventListener("click",async function a(){try{let i=ue.querySelector("sp-menu-item[selected]"),s=ae.querySelector("sp-menu-item[selected]");if(!i||!s)return;let c=i.getAttribute("data-nodeid"),l=i.getAttribute("data-nodetitle"),u=i.getAttribute("data-nodeclass"),d=s.getAttribute("data-field"),p=s.getAttribute("data-value");Ve.removeEventListener("click",a),ht.close(),await o(c,l,u,d,p)}catch(i){throw console.error(i),alert(i),i;return}}),ht.showModal()}Sn.exports={initShow:ci,show:ui}});var Pn=A((Qs,Tn)=>{"use strict";var Zs=$();function di(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function fi(e){let t={};for(let n in e){if(!e.hasOwnProperty(n))continue;let o=e[n],r=o.class_type,a=o._meta?o._meta.title:o.class_type;t[n]={nodeclass:r,nodetitle:a,fields:{}};let i=t[n].fields;for(let s in o.inputs){if(!o.inputs.hasOwnProperty(s))continue;let c=o.inputs[s];Array.isArray(c)||(i[s]=c)}}return t}function mi(e){return!e||typeof e!="object"?!1:Object.keys(e).every(n=>/^\d+$/.test(n))}Tn.exports={isWfAPI:mi,parsenodes:fi,generateUUID:di}});var vt=A((ec,Rn)=>{"use strict";var he=X(),Dn=In(),Bn=Mn(),kn=An(),Je=Pn(),k=$();function pi(){let e=null;for(let t in N){let o=N[t].nodeclass;if(o==="SaveImage"){e=t;break}else o==="PreviewImage"&&(e=t)}if(e){let t=N[e],n=t.nodetitle,o=t.nodeclass;C.setAttribute("data-nodeid",e),C.setAttribute("data-nodetitle",n),C.setAttribute("data-nodeclass",o),C.textContent=`${n}(${e})`}else C.removeAttribute("data-nodeid"),C.removeAttribute("data-nodetitle"),C.removeAttribute("data-nodeclass"),C.textContent=""}function gi(){let e=null,t=null;for(let n in N){let o=N[n];for(let r in o.fields){let a=o.fields[r];if(r==="image"){e=n,t=r;break}}}if(e){let n=N[e],o=n.nodetitle,r=n.nodeclass,a=n.fields[t];Ye(e,o,r,t,"\u83B7\u53D6\u56FE\u7247",a,k.INPUTIMAGE,"",!1)}else Ye(null,null,null,"","\u83B7\u53D6\u56FE\u7247","",k.INPUTIMAGE,"",!1)}function wi(){Ye(null,null,null,"","","",null,"",!0)}function hi(e){try{let t=C.getAttribute("data-nodeid");Dn.show(N,t,(n,o,r)=>{C.setAttribute("data-nodeid",n),C.setAttribute("data-nodetitle",o),C.setAttribute("data-nodeclass",r),C.textContent=`${o}(\u7F16\u53F7${n})`})}catch(t){throw console.error(t),alert(t),t;return}}function yi(e){try{let t=e.currentTarget.getAttribute("data-divid"),n=document.getElementById(t),o=n.querySelector(".wfMgrNode"),r=o.getAttribute("data-nodeid"),a=o.getAttribute("data-field");kn.show(N,r,a,async(i,s,c,l,u)=>{o.setAttribute("data-nodeid",i),o.setAttribute("data-nodetitle",s),o.setAttribute("data-nodeclass",c),o.textContent=`\u8282\u70B9=${s}(${i}),   \u5B57\u6BB5=${l}`,o.setAttribute("data-field",l);let d=n.querySelector(".wfMgrTitle");d.value.trim()||(d.value=l);let g=n.querySelector(".wfMgrValue");g.value||(g.value=String(u));let E=n.querySelector(".wfMgrKind");if(!E.value){let[y,f]=await he.guessFieldKind(c,l),m=n.querySelector(".wfMgrExtra");y&&(E.querySelectorAll("sp-menu-item").forEach(_=>{_.value===y?_.setAttribute("selected",!0):_.removeAttribute("selected")}),y===k.SLIDER&&(m.value=`${f.min},${f.max},${f.step}`))}})}catch(t){throw console.error(t),alert(t),t;return}}function Ye(e,t,n,o,r,a,i,s,c,l){let u=document.createElement("div");u.id=`wfMgrDiv-${Je.generateUUID()}`,u.innerHTML=$n,Me.appendChild(u);let d=u.querySelector(".wfMgrNode");d.setAttribute("data-nodeid",e),d.setAttribute("data-field",o),d.setAttribute("data-nodetitle",t),d.setAttribute("data-nodeclass",n),d.setAttribute("data-divid",u.id),d.addEventListener("click",yi),e&&(d.textContent=`\u8282\u70B9=${t}(${e}),   \u5B57\u6BB5=${o}`),u.querySelector(".wfMgrTitle").value=r;let p=u.querySelector(".wfMgrValue");p.value=String(a),p.setAttribute("data-valuefolder",l);let g=u.querySelector(".wfMgrKind");g.setAttribute("data-divid",u.id),g.querySelectorAll("sp-menu-item").forEach(y=>{y.value===i&&y.setAttribute("selected",!0)}),g.addEventListener("change",y=>{let f=y.currentTarget.value,m=y.currentTarget.getAttribute("data-divid"),_=document.getElementById(m),L=_.querySelector(".wfMgrVisible"),D=_.querySelector(".wfMgrExtra"),K=_.querySelector(".wfMgrValue");switch(D.style.display="block",K.style.display="block",D.parentElement.querySelector("[data-label-extra]").style.display="block",K.parentElement.querySelector("[data-label-value]").style.display="block",f){case k.SLIDER:let fe=D.value;fe||(o==="denoise"?fe="0,1,0.01":o==="steps"?fe="1,40,1":fe="0,100,1",D.value=fe);break;case k.SEED:L.checked=!1;break;case k.INPUTIMAGE:case k.INPUTIMAGEMASK:case k.INPUTMASK:case k.INPUTREGION:L.checked=!1,D.style.display="none",D.parentElement.querySelector("[data-label-extra]").style.display="none",K.style.display="none",K.parentElement.querySelector("[data-label-value]").style.display="none";break;case k.FIELDENUM:D.style.display="none",D.parentElement.querySelector("[data-label-extra]").style.display="none";break;default:break}});let w=u.querySelector(".wfMgrExtra");w.value=s,u.querySelector(".wfMgrVisible").checked=c;let E=u.querySelector(".wfMgrDel");switch(E.addEventListener("click",Ei),E.setAttribute("data-divid",u.id),i){case k.INPUTIMAGE:case k.INPUTIMAGEMASK:case k.INPUTMASK:case k.INPUTREGION:case k.INPUTREGIONMASK:w.style.display="none",w.parentElement.querySelector("[data-label-extra]").style.display="none",p.style.display="none",p.parentElement.querySelector("[data-label-value]").style.display="none";break;case k.FIELDENUM:w.style.display="none",w.parentElement.querySelector("[data-label-extra]").style.display="none";break;default:break}}function Ei(e){let t=e.currentTarget.getAttribute("data-divid"),n=document.getElementById(t);Me.removeChild(n)}async function On(){try{let e=await he.get_wf_api_run();return e.result?(Z=e,!0):!1}catch(e){throw console.error(e),alert(`\u8BFB\u53D6\u5DE5\u4F5C\u6D41API\u65F6\u51FA\u9519:${e}`),e;return}}async function vi(){if(await On())try{N=Je.parsenodes(Z.apidata),se.disabled=!1,ye.disabled=!1,ye.value="\u65B0\u589E\u5DE5\u4F5C\u6D41",document.getElementById("tfwfMgrPath").value=Z.lasttime,Me.innerHTML="",pi(),gi()}catch(e){throw console.error(e),alert(e),e;return}}async function bi(){if(await On())try{N=Je.parsenodes(Z.apidata),document.getElementById("tfwfMgrPath").value=Z.lasttime}catch(e){throw console.error(e),alert(e),e;return}}function qe(){try{let e=document.getElementById("wfPromptContainer"),t=document.getElementById("wfManageContainer");t.style.display="none",e.style.display="flex",Ae&&document.dispatchEvent(new CustomEvent("wfRefreshWorkflowEvent",{detail:{}}))}catch(e){throw console.error(e),alert(e),e}}async function Ln(e){try{let t=C.getAttribute("data-nodeid");await Bn.show(n=>{localStorage.setItem("lastWorkflow",n),Ae=!0,qe()})}catch(t){throw console.error(t),alert(t),t;return}}var Xe=!1,Ae=!1,ye,se,Me,Se,Et,C,we,$n,F,Z,N;async function Un(){Xe=!1,Ae=!1,F=null,Z=null,N=null,await window.loadHtml("wfManageContainer","html/wfmanage.html"),ye=document.getElementById("tfwfMgrName"),se=document.getElementById("btnWfManageSave"),Me=document.getElementById("wfManageContainerInner"),Se=document.getElementById("btnWfManageDel"),Et=document.getElementById("btnWfManageRecover"),C=document.getElementById("tfwfMgrOutput"),we=document.getElementById("wfManageLog"),$n=await(await fetch("html/wfparamtempelate.html")).text(),document.getElementById("btnWfManageHelp").addEventListener("click",t=>{document.getElementById("wfManageHelpDialog").showModal()}),document.getElementById("btnWfManageReturn").addEventListener("click",async t=>{(!Xe||await window.confirm("\u5DE5\u4F5C\u6D41\u5C1A\u672A\u4FDD\u5B58\uFF0C\u786E\u5B9A\u8981\u8FD4\u56DE\u5417\uFF1F"))&&qe()}),Se.addEventListener("click",_i),document.getElementById("tfwfMgrAddParam").addEventListener("click",wi),C.addEventListener("click",hi),Et.addEventListener("click",Ln),kn.initShow(),Dn.initShow()}async function _i(){try{if(!F||!await confirm("\u786E\u5B9A\u8981\u5220\u9664\u5DE5\u4F5C\u6D41\u5417\uFF1F"))return;Ae=!0,await he.save_wf_del({wfname:F}),qe()}catch(e){throw console.error(e),alert(e),e}finally{Se.disabled=!1}}function Nn(){let e=C.getAttribute("data-nodeid"),t=C.getAttribute("data-nodetitle"),n=C.getAttribute("data-nodeclass"),o=C.getAttribute("data-folderbatch");if(!e){ie("\u8BF7\u5148\u8BBE\u7F6E\u7ED3\u679C\u56FE\u7247\u8282\u70B9");return}if(!(e in N)){ie("\u7ED3\u679C\u56FE\u7247\u8282\u70B9\u4E0D\u6B63\u786E");return}let r=[],a=new Set;for(let s=0;s<Me.children.length;s++){let c=Me.children[s],l=c.querySelector(".wfMgrTitle").value.trim(),u=c.querySelector(".wfMgrNode"),d=u.getAttribute("data-nodetitle"),p=u.getAttribute("data-nodeclass"),g=u.getAttribute("data-nodeid"),w=u.getAttribute("data-field"),E=c.querySelector(".wfMgrValue").value,y=c.querySelector(".wfMgrValue").getAttribute("data-valuefolder"),f=c.querySelector(".wfMgrKind").value,m=c.querySelector(".wfMgrExtra").value,_=c.querySelector(".wfMgrVisible").checked;if(!f){ie(`\u7B2C${s+1}\u4E2A\u6761\u4EF6\uFF0C\u6761\u4EF6\u7C7B\u578B\u4E0D\u80FD\u4E3A\u7A7A`);return}if(!g||!w){ie(`\u7B2C${s+1}\u4E2A\u6761\u4EF6\uFF0C\u8282\u70B9\u53CA\u5B57\u6BB5\u4E0D\u80FD\u4E3A\u7A7A`);return}if(!(g in N&&w in N[g].fields)){ie(`\u7B2C${s+1}\u4E2A\u6761\u4EF6\uFF0C\u8282\u70B9\u6216\u5B57\u6BB5\u4E0D\u6B63\u786E`);return}let L={title:l,kind:f,nodeid:g,nodetitle:d,nodeclass:p,field:w,value:E,extra:m,visible:_,valuefolder:y};r.push(L);let D=`${L.nodeid}-${L.field}`;if(a.has(D)){ie(`\u627E\u5230\u91CD\u590D: \u8282\u70B9=${L.nodeid}, \u5B57\u6BB5=${L.field}`);return}a.add(D)}return{params:r,output:{nodeid:e,nodetitle:t,nodeclass:n,folderbatch:o}}}function qn(e){we.textContent=e,we.style.color="lightgreen",setTimeout(()=>{we.textContent=""},800)}function ie(e){we.textContent=e,we.style.color="orange",setTimeout(()=>{we.textContent=""},2e3)}async function Ii(){if(!Z){ie("\u8BF7\u5148\u63D0\u53D6\u5DE5\u4F5C\u6D41API,\u5982\u679C\u63D0\u53D6\u4E0D\u5230\uFF0C\u8BF7\u5728COMFYUI\u4E2D\u6267\u884C\u4E00\u6B21\u540E\u518D\u8BD5\uFF01");return}let e=ye.value.trim();if(!e){ie("\u5DE5\u4F5C\u6D41\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A");return}let t=Nn();t&&(await he.save_wf_new_run({apidata:Z.apidata,wfname:e,params:t}),Xe=!1,Ae=!0,F=e,localStorage.setItem("lastWorkflow",F),qn("\u5DE5\u4F5C\u6D41\u4FDD\u5B58\u6210\u529F"),qe())}async function Fn(){let e=ye.value.trim();if(!e){ie("\u5DE5\u4F5C\u6D41\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A");return}let t=Nn();t&&(await he.save_wf_edit({wfname:F,wfnamenew:e,params:t,apidata:Z?Z.apidata:null}),Xe=!1,Ae=!0,F!==e&&localStorage.setItem("lastWorkflow",e),F=e,qn("\u5DE5\u4F5C\u6D41\u4FDD\u5B58\u6210\u529F"),qe())}async function xi(){await Un(),Bn.initShow(),document.getElementById("btnWfManageOpenFile").addEventListener("click",vi),se.disabled=!0,ye.disabled=!0,Se.style.display="none",Et.style.display="block",se.addEventListener("click",async e=>{try{se.disabled=!0,F?await Fn():await Ii()}catch(t){throw console.error(t),alert(t),t}finally{se.disabled=!1}}),document.getElementById("btnWfManageOpenFile").dispatchEvent(new Event("click"))}async function Ci(e){try{await Un(),document.getElementById("btnWfManageOpenFile").addEventListener("click",bi),Se.disabled=!0,se.disabled=!0,se.addEventListener("click",async o=>{try{await Fn()}catch(r){throw console.error(r),alert(r),r}}),F=e,document.getElementById("tfwfMgrPath").value=`${F}.json`;let t=await he.get_wf_api(F);N=Je.parsenodes(t);let n=await he.get_wf_params(F);ye.value=F,C.setAttribute("data-nodeid",n.output.nodeid),C.setAttribute("data-nodetitle",n.output.nodetitle),C.setAttribute("data-nodeclass",n.output.nodeclass),C.setAttribute("data-folderbatch",n.output.folderbatch),C.textContent=`${n.output.nodetitle}(${n.output.nodeid})`,n.kind||(n.kind=k.PROMPTMODE_COMMON);for(let o of n.params)Ye(o.nodeid,o.nodetitle,o.nodeclass,o.field,o.title,o.value,o.kind,o.extra,o.visible,o.valuefolder)}catch(t){throw console.error(t),alert(t),t}finally{se.disabled=!1,Se.disabled=!1}}function Mi(){window.loadCSS("../css/wfmgr.css")}Rn.exports={initPanel:Mi,showNew:xi,showEdit:Ci}});var Vn=A((tc,Kn)=>{"use strict";var _t=ee(),It=X(),bt=$(),Hn=te(),Si=V(),R=document.getElementById("wfParamContainer");function jn(e){e.innerHTML="";let t=Hn.getDocuments();for(let n=0;n<t.length;n++){let o=document.createElement("sp-menu-item");o.textContent=t[n].name,o.setAttribute("value",t[n].id),n===0&&o.setAttribute("selected",!0),e.appendChild(o)}}function Te(e,t){let n=document.createElement("sp-action-button");return n.style.justifyContent="flex-end",n.setAttribute("quiet",!0),n.textContent=e,n.setAttribute("size","s"),n.addEventListener("click",t),n}function Ai(e){let t=e.currentTarget.value;try{Hn.activateDocument(t)}catch(n){console.error(n)}}function ce(e){let t=document.createElement("sp-label");return t.textContent=`${e}:`,t.style.marginRight="5px",t.style.width="25%",t}function Ti(e,t){let n=e.value,o=de();R.appendChild(o);let r=ce(e.title);o.appendChild(r);let a=0,i=100,s=1;e.extra&&([a,i,s]=e.extra.split(","));let c=document.createElement("sp-slider");c.setAttribute("min",a),c.setAttribute("max",i),c.setAttribute("step",s),c.setAttribute("variant","filled"),c.setAttribute("gradient","true"),t&&c.addEventListener("change",t),c.style.padding="0px",c.style.flexGrow="1",c.value=n,o.appendChild(c);let l=document.createElement("sp-label");return l.style.justifyContent="flex-end",Number.isInteger(c.value)?l.textContent=`${c.value}`:l.textContent=`${c.value.toFixed(2)}`,l.style.padding="0px",c.addEventListener("change",u=>{Number.isInteger(c.value)?l.textContent=`${c.value}`:l.textContent=`${c.value.toFixed(2)}`}),o.appendChild(l),c}function de(){let e=document.createElement("div");return e.style.justifyContent="space-between",e.style.display="flex",e.style.width="100%",e}function Pi(e){let t=e.value,n=ce(e.title),o=de();R.appendChild(o),o.appendChild(n);let r=document.createElement("sp-picker"),a=document.createElement("sp-menu");a.setAttribute("slot","options"),r.appendChild(a),jn(a),r.addEventListener("change",Ai),r.style.flexGrow="1",o.appendChild(r);let i=Te("\u{1F504}",s=>{let c=s.currentTarget.parentElement.querySelector('sp-menu[slot="options"]');jn(c)});return i.style.padding="0px",o.appendChild(i),r}function Wn(e){try{e.focus()}catch{}}function Li(e){let t=e.output.folderbatch,n=ce("\u8F93\u51FA\u56FE\u50CF"),o=de();R.appendChild(o),o.appendChild(n);let r=document.createElement("sp-textfield");r.value=t,r.setAttribute("data-output-batchfolder",!0),r.size="s",r.style.flexGrow="1",o.appendChild(r);let a=Te("",async i=>{let s=await _t.getFolder();if(s){let c=i.target.parentElement.querySelector("sp-textfield");c.value=s.nativePath,Wn(c)}});return a.innerHTML='<sp-icon name="ui:FolderBreadcrumb" size="s" slot="icon"></sp-icon>',a.style.padding="0px",o.appendChild(a),zn(),r}function Di(e){let t=e.valuefolder,n=de();R.appendChild(n);let o=ce(e.title);o.setAttribute("data-input-batch-label",!0),e.batchnamed&&(o.textContent=`${e.title}(*):`),n.appendChild(o),o.addEventListener("click",i=>{let s=i.currentTarget.parentElement.querySelector("sp-textfield");R.querySelectorAll("[data-input-batchfolder]").forEach(l=>{l.removeAttribute("data-batch-named");let u=l.getAttribute("data-title"),d=l.parentElement.querySelector("[data-input-batch-label]");d.textContent=`${u}:`});let c=s.getAttribute("data-title");s.setAttribute("data-batch-named",!0),i.currentTarget.textContent=`${c}(*):`});let r=document.createElement("sp-textfield");r.setAttribute("data-input-batchfolder",!0),r.value=t,r.style.flexGrow="1",n.appendChild(r);let a=Te("",async i=>{let s=await _t.getFolder();if(s){let c=i.target.parentElement.querySelector("sp-textfield");try{c.value=s.nativePath,Wn(c);let l=_t.joinPath(s.nativePath,"output"),u=R.querySelector("[data-output-batchfolder]");(!u.value||u.value==="")&&(u.value=l)}catch(l){console.log(l)}}});return a.innerHTML='<sp-icon name="ui:FolderBreadcrumb" size="s" slot="icon"></sp-icon>',a.style.padding="0px",n.appendChild(a),r}function Bi(e,t){let n=e.value,o=ce(e.title),r=document.createElement("div");r.style.flexDirection="column",r.style.display="flex",R.appendChild(r);let a=document.createElement("div");a.style.justifyContent="space-between",a.style.display="flex",a.appendChild(o);let i=document.createElement("div");i.style.justifyContent="flex-end",i.style.display="flex",a.appendChild(i);let s=Te("\u4E2D",async u=>{try{let d=u.currentTarget.parentElement.parentElement.parentElement.querySelector("sp-textarea"),p=d.value.trim();if(!p)return;let g=await It.translateToZH(p);d.value=g}catch(d){throw console.error(d),alert(`\u7FFB\u8BD1\u65F6\u51FA\u9519${d}`),d}});i.appendChild(s),s.style.display=window.config.transEnable?"block":"none";let c=Te("EN",async u=>{try{let d=u.currentTarget.parentElement.parentElement.parentElement.querySelector("sp-textarea"),p=d.value.trim();if(!p)return;let g=await It.translateToEN(p);d.value=g}catch(d){throw console.error(d),alert(`\u7FFB\u8BD1\u65F6\u51FA\u9519${d}`),d}});c.style.display=window.config.transEnable?"block":"none",i.appendChild(c),r.appendChild(a);let l=document.createElement("sp-textarea");return l.style.height=100,l.setAttribute("maxlength","1000"),l.value=n,r.appendChild(l),l.style.width="100%",t&&l.addEventListener("change",t),l}async function ki(e,t){e.innerHTML="";let n=!1,o=await It.get_wf_nodefield_enum(t.nodeclass,t.field);for(let r=0;r<o.length;r++){let a=document.createElement("sp-menu-item");a.textContent=o[r],o[r]===t.value&&(a.setAttribute("selected",!0),n=!0),e.appendChild(a)}!n&&o.length>0&&e.children[0].setAttribute("selected",!0)}function Oi(e,t){let n=e.value,o=ce(e.title),r=de();R.appendChild(r),r.appendChild(o);let a=document.createElement("sp-picker"),i=document.createElement("sp-menu");return i.setAttribute("slot","options"),a.appendChild(i),ki(i,e),a.style.flexGrow="1",t&&a.addEventListener("change",t),r.appendChild(a),a}function $i(e,t){let n=de();R.appendChild(n);let o=e.value,r=ce(e.title);n.appendChild(r);let a=document.createElement("sp-textfield");return a.value=o,a.style.flexGrow="1",a.setAttribute("maxlength","100"),t&&a.addEventListener("change",t),n.appendChild(a),a}function Ui(){switch(window.config.promptMode){case bt.PROMPTMODE_COMMON:return"\u751F\u6210";case bt.PROMPTMODE_BATCH:return"\u6279\u91CF\u751F\u6210";case bt.PROMPTMODE_LIVE:return"\u5B9E\u65F6\u7ED8\u753B"}}function zn(){let e=document.createElement("sp-divider");e.style.marginTop="5px",e.style.marginBottom="5px",e.size="s",R.appendChild(e)}function Ni(e){let t=de();R.appendChild(t);let n=ce("\u654F\u9510\u5EA6(\u79D2)");t.appendChild(n);let o=window.config.livePromptSensitivity,r=0,a=5,i=.1,s=document.createElement("sp-slider");s.setAttribute("min",r),s.setAttribute("max",a),s.setAttribute("step",i),s.setAttribute("variant","filled"),s.setAttribute("gradient","true"),s.style.flexGrow="1",s.style.padding="0px",s.value=o,s.addEventListener("change",e),t.appendChild(s);let c=document.createElement("sp-label");return c.style.justifyContent="flex-end",Number.isInteger(s.value)?c.textContent=`${s.value}`:c.textContent=`${s.value.toFixed(2)}`,c.style.padding="0px",s.addEventListener("change",l=>{Number.isInteger(s.value)?c.textContent=`${s.value}`:c.textContent=`${s.value.toFixed(2)}`}),t.appendChild(c),s}function qi(){let e=de();R.appendChild(e);let t=ce("\u751F\u56FE\u6682\u505C(\u79D2):");t.setAttribute("data-keep-disabled",!0),e.appendChild(t);let n=window.config.batchPromptPause,o=0,r=60,a=1,i=document.createElement("sp-slider");i.setAttribute("data-keep-disabled",!0),i.setAttribute("min",o),i.setAttribute("max",r),i.setAttribute("step",a),i.setAttribute("variant","filled"),i.setAttribute("gradient","true"),i.style.flexGrow="1",i.style.padding="0px",i.value=n,e.appendChild(i),i.style.width="60%",i.addEventListener("change",l=>{try{Number.isInteger(i.value)?s.textContent=`${i.value}`:s.textContent=`${i.value.toFixed(2)}`;let u=l.currentTarget.value;window.config.batchPromptPause=u,window.saveConfig()}catch(u){console.error(u)}});let s=document.createElement("sp-label");s.setAttribute("data-keep-disabled",!0),s.style.justifyContent="flex-end",Number.isInteger(i.value)?s.textContent=`${i.value}`:s.textContent=`${i.value.toFixed(2)}`,s.style.padding="0px";let c=Te("",l=>{});return c.textContent=window.config.batchPromptPreview?"\u{1F50D}":"---",c.setAttribute("quiet",!0),c.setAttribute("variant","secondary"),c.setAttribute("variant","overBackground"),c.style.padding="0px",c.setAttribute("data-keep-disabled",!0),c.addEventListener("click",()=>{window.config.batchPromptPreview=!window.config.batchPromptPreview,c.textContent=window.config.batchPromptPreview?"\u{1F50D}":"---",window.saveConfig(),Si.log(window.config.batchPromptPreview?"\u5F00\u542F\u9884\u89C8":"\u5173\u95ED\u9884\u89C8")}),e.appendChild(c),i}function Fi(e){let t=document.createElement("sp-body");t.style.width="100%",t.style.textAlign="center",t.textContent=e,R.appendChild(t)}function Ri(e){let t=R.querySelector(`[data-nodeid="${e.nodeid}"][data-field="${e.field}"]`);return t||null}Kn.exports={createParamPromptText:Bi,createParamSlider:Ti,createParamImage:Pi,createParamImageBatch:Di,createParamOutputBatch:Li,createParamFIELDENUM:Oi,createParamDefault:$i,getPromptModeLabel:Ui,createParamDivider:zn,createParamLiveSensitivity:Ni,createParamBatchPause:qi,createWfTitle:Fi,getUIParamsInput:Ri}});var uo=A((nc,lo)=>{"use strict";var ji=ee(),ve=X(),to=We(),Fe=mn(),Pe=bn(),Gn=vt(),no=V(),O=Vn(),Hi=De(),h=$(),oo=document.getElementById("btnPrompt"),Le=document.getElementById("wfButtonContainer"),Qe=document.getElementById("wfParamContainer"),Yn=document.getElementById("lSimpleLog"),Wi=document.getElementById("buttonContainer"),ro=document.getElementById("wfMainToolbar"),zi=document.getElementById("btnInterrupt"),Xn=document.getElementById("wfPromptContainer"),Jn=document.getElementById("wfManageContainer"),Mt=document.getElementById("btnAddWorkflow"),St=document.getElementById("btnEditWorkflow"),At=document.getElementById("btnWfRefresh");function Re(e){Wi.querySelectorAll("*").forEach(t=>{t.disabled=e}),ro.querySelectorAll("*").forEach(t=>{t.disabled=e}),Qe.querySelectorAll("*").forEach(t=>{t.hasAttribute("data-keep-disabled")||(t.disabled=e)}),Le.style.display!=="none"&&Array.from(Le.children).forEach(t=>{t.disabled=e})}function Ze(){ro.querySelectorAll("*").forEach(t=>{t.disabled=!1}),Array.from(Le.children).forEach(t=>{t.disabled=!1})}async function Ki(e){try{let t=e.currentTarget,n=t.getAttribute("wfname");if(n===j)return;Array.from(Le.children).forEach(o=>{o.setAttribute("quiet",!0),o.setAttribute("variant","secondary")}),t.removeAttribute("quiet"),t.setAttribute("variant","overBackground"),await io(n)}catch(t){throw console.error(t),alert(`\u52A0\u8F7D\u5DE5\u4F5C\u6D41\u65F6\u51FA\u9519:${t}`),t}}function xt(e,t){let n=null;switch(e.kind){case h.PROMPTTEXT:n=O.createParamPromptText(e,t);break;case h.SLIDER:n=O.createParamSlider(e,t);break;case h.INPUTIMAGE:switch(window.config.promptMode){case h.PROMPTMODE_BATCH:n=O.createParamImageBatch(e);break;default:n=O.createParamImage(e)}break;case h.INPUTIMAGEMASK:n=O.createParamImage(e);break;case h.INPUTMASK:n=O.createParamImage(e);break;case h.INPUTREGION:n=O.createParamImage(e);break;case h.INPUTREGIONMASK:n=O.createParamImage(e);break;case h.FIELDENUM:n=O.createParamFIELDENUM(e,t);break;default:n=O.createParamDefault(e,t)}n.setAttribute("data-kind",e.kind),n.setAttribute("data-nodeid",e.nodeid),n.setAttribute("data-field",e.field),n.setAttribute("data-title",e.title),n.size="s",O.createParamDivider()}async function Zn(e){try{await co(e.newwfname),Qe.innerHTML="",Yn.textContent="",Yn.style.display="none",O.createWfTitle(j),P.params.forEach(t=>{t.visible?window.config.promptMode===h.PROMPTMODE_LIVE?xt(t,Fe.paramChanged):xt(t):window.config.promptMode===h.PROMPTMODE_BATCH&&t.kind===h.INPUTIMAGE&&xt(t)}),window.config.promptMode===h.PROMPTMODE_BATCH?(O.createParamOutputBatch(P),O.createParamBatchPause()):window.config.promptMode===h.PROMPTMODE_LIVE&&O.createParamLiveSensitivity(Fe.sensitivityChanged),localStorage.setItem("lastWorkflow",j),no.clearLog(),window.showSingle(document.getElementById("logContainer")),Re(!1)}catch(t){throw Re(!0),Ze(),t}}function ao(e){Tt=e,Tt==="ADMIN"?(Mt.style.display="flex",At.style.display="flex"):(Mt.style.display="none",At.style.display="none")}async function io(e){if(!e)return;let[t,n]=await ve.test_comfyui_jinn(window.config.comfyuiURL);if(t===!0){ao(n),await Zn({newwfname:e});return}Re(!0);let o=new CustomEvent("comfyuiConnectEvent",{detail:{data:{newwfname:e},callback:Zn}});document.dispatchEvent(o)}async function Ct(){let e=[],t=new Set;P.needimage=!1;for(let n of P.params){let o=null,r=O.getUIParamsInput(n);switch(r&&(o=r.value),n.kind){case h.SEED:o=o??Hi.randInt(1,1e6),n.value=o;break;case h.PROMPTTEXT:o=o??n.value,n.value=o;let a=o;window.config.transEnable&&o&&(a=await ve.translateToEN(o)),n.valueen=a;break;case h.INPUTIMAGE:if(P.needimage=!0,window.config.promptMode===h.PROMPTMODE_BATCH){if(!o||o.trim()==="")throw new Error(`${n.title}:\u6CA1\u6709\u6307\u5B9A\u76EE\u5F55`);if(t.has(o))throw new Error(`"${n.title}":\u5176\u5B83\u6761\u4EF6\u5DF2\u7ECF\u6307\u5B9A\u4E86\u8BE5\u76EE\u5F55`);t.add(o),n.valuefolder=o,r&&r.hasAttribute("data-batch-named")?n.batchnamed=!0:n.batchnamed=!1,e.push(n)}else o=o??-1,n.docid=o;break;case h.INPUTIMAGEMASK:if(P.needimage=!0,window.config.promptMode===h.PROMPTMODE_BATCH)throw new Error(`"${n.title}":\u6279\u91CF\u751F\u56FE\u4E0D\u652F\u6301\u56FE\u7247\u8499\u677F\u6761\u4EF6\u3002`);if(window.config.promptMode===h.PROMPTMODE_LIVE)throw new Error(`"${n.title}":\u5B9E\u65F6\u751F\u56FE\u4E0D\u652F\u6301\u56FE\u7247\u8499\u677F\u6761\u4EF6\u3002`);o=o??-1,n.docid=o;break;case h.INPUTMASK:if(P.needimage=!0,window.config.promptMode===h.PROMPTMODE_BATCH)throw new Error(`"${n.title}":\u6279\u91CF\u751F\u56FE\u4E0D\u652F\u6301\u8499\u677F\u6761\u4EF6\u3002`);if(window.config.promptMode===h.PROMPTMODE_LIVE)throw new Error(`"${n.title}":\u5B9E\u65F6\u751F\u56FE\u4E0D\u652F\u6301\u56FE\u7247\u8499\u677F\u6761\u4EF6\u3002`);o=o??-1,n.docid=o;break;case h.INPUTREGION:if(P.needimage=!0,window.config.promptMode===h.PROMPTMODE_BATCH)throw new Error(`"${n.title}":\u6279\u91CF\u751F\u56FE\u4E0D\u652F\u6301\u9009\u533A\u56FE\u7247`);if(window.config.promptMode===h.PROMPTMODE_LIVE)throw new Error(`"${n.title}":\u6279\u91CF\u751F\u56FE\u4E0D\u652F\u6301\u9009\u533A\u56FE\u7247`);o=o??-1,n.docid=o;break;case h.INPUTREGIONMASK:if(P.needimage=!0,window.config.promptMode===h.PROMPTMODE_BATCH)throw new Error(`"${n.title}":\u6279\u91CF\u751F\u56FE\u4E0D\u652F\u6301\u9009\u533A\u8499\u677F`);if(window.config.promptMode===h.PROMPTMODE_LIVE)throw new Error(`"${n.title}":\u6279\u91CF\u751F\u56FE\u4E0D\u652F\u6301\u9009\u533A\u8499\u677F`);o=o??-1,n.docid=o;break;default:o=o??n.value,n.value=o}}if(window.config.promptMode===h.PROMPTMODE_BATCH){if(e.length===0)throw new Error("\u6CA1\u6709\u627E\u5230\u201C\u83B7\u53D6\u56FE\u7247\u201D\u6761\u4EF6");if(e.length>3)throw new Error("\u6682\u4E0D\u652F\u63013\u4E2A\u4EE5\u4E0A\u7684\u201C\u83B7\u53D6\u56FE\u7247\u201D\u6761\u4EF6");let o=Qe.querySelector("[data-output-batchfolder]").value;if(!o)throw new Error("\u6CA1\u6709\u6307\u5B9A\u8F93\u51FA\u56FE\u50CF\u7684\u76EE\u5F55");if(t.has(o))throw new Error('"\u8F93\u51FA\u56FE\u50CF":\u5176\u5B83\u6761\u4EF6\u5DF2\u7ECF\u6307\u5B9A\u4E86\u8BE5\u76EE\u5F55');return t.add(o),P.output.folderbatch=o,e}}async function Vi(){try{if(!j){alert("\u8BF7\u9009\u62E9\u4E00\u4E2A\u5DE5\u4F5C\u6D41");return}if(!P){alert("\u672A\u6B63\u786E\u52A0\u8F7D\u5DE5\u4F5C\u6D41");return}if(window.config.promptMode===h.PROMPTMODE_BATCH){let e=await Ct(),t;try{t=await ji.getFolderWithCreate(P.output.folderbatch)}catch(n){throw new Error(`"\u8F93\u51FA\u56FE\u50CF":${n.message}`)}if(await Pe.hasBatchTask(P.output.folderbatch)){if(await Pe.checkBatchTask(j,P,Ee,e),!await confirm('"\u8F93\u51FA\u56FE\u50CF":\u8BE5\u76EE\u5F55\u5DF2\u5B58\u5728\u6279\u91CF\u4EFB\u52A1\uFF0C\u5C06\u81EA\u52A8\u8DF3\u8FC7\u5DF2\u5904\u7406\u7684\u56FE\u7247\uFF0C\u8981\u7EE7\u7EED\u751F\u56FE\u5417\uFF1F'))return}else await Pe.createBatchTask(j,P,Ee,e);Pe.promptBatch(j,P,Ee,e)}else window.config.promptMode===h.PROMPTMODE_LIVE?(await Ct(),Fe.promptLive(j,P,Ee)):(await Ct(),to.prompt(j,P,Ee))}catch(e){throw console.error(e),alert(e),e}}async function Qn(){try{no.clearLog(),window.showSingle(document.getElementById("logContainer"));let e=localStorage.getItem("lastWorkflow"),t=-1,n=await ve.get_workflows();for(let o=0;o<n.length;o++)if(n[o].wfname===e){t=o;break}t<0&&n.length>0&&(t=0),Le.innerHTML="",Qe.innerHTML="",n.forEach(o=>{let r=document.createElement("sp-action-button");r.setAttribute("wfname",o.wfname),r.setAttribute("quiet",!0),r.setAttribute("variant","secondary"),r.size="s",r.style.border="4px solid #0056b3",r.textContent=o.wfname.slice(0,window.config.wfNameLength),t>=0&&o.wfname===n[t].wfname&&(r.setAttribute("variant","overBackground"),r.removeAttribute("quiet")),r.addEventListener("click",Ki),r.className="dynamic-button",Le.appendChild(r)}),t>=0?(await io(n[t].wfname),n[t].selected=!0):Ze(),oo.textContent=O.getPromptModeLabel(),document.getElementById("btnWfBatchPromptHelp").style.display=window.config.promptMode===h.PROMPTMODE_BATCH||window.config.promptMode===h.PROMPTMODE_LIVE?"flex":"none"}catch(e){throw Re(!0),Ze(),e}}async function Gi(){try{Re(!0),await co(null);let[e,t]=await ve.test_comfyui_jinn(window.config.comfyuiURL);if(e===!0){ao(t),await Qn();return}let n=new CustomEvent("comfyuiConnectEvent",{detail:{data:{},callback:Qn}});document.dispatchEvent(n)}catch(e){throw Ze(),console.error(e),alert(`\u52A0\u8F7D\u5DE5\u4F5C\u6D41\u5217\u8868\u65F6\u51FA\u9519:${e}`),e}}async function eo(){try{let e=document.getElementById("userInfoDialog"),n=document.getElementById("tfUserInfoPhone").value.trim();if(n.length<7||!/^\d+$/.test(n)){alert("\u8F93\u5165\u4E0D\u6B63\u786E");return}await ve.registry_user(n),e.close()}catch(e){alert(e)}}function Yi(){let e=document.getElementById("userInfoDialog");if(e)return;e=document.createElement("dialog"),e.id="userInfoDialog",e.style.cssText="width:300px; padding:20px; display:flex; flex-direction:column; align-items:center; text-align:center;";let t=document.createElement("sp-body");t.id="tfUserInfoMessage",t.textContent="\u8BF7\u8F93\u5165\u4F60\u7684\u624B\u673A\u53F7\u7801\uFF1A",t.style.marginBottom="15px";let n=document.createElement("sp-textfield");n.id="tfUserInfoPhone",n.setAttribute("maxlength","20"),n.setAttribute("placeholder","\u8BF7\u8F93\u5165\u624B\u673A\u53F7"),n.style.width="100%",n.style.margin="0 auto";let o=document.createElement("sp-action-button");o.id="btnUserInfoSubmit",o.textContent="\u63D0\u4EA4",o.style.marginTop="15px",e.appendChild(t),e.appendChild(n),e.appendChild(o),document.body.appendChild(e)}function Xi(e){try{let{error:t}=e.detail;if(t.needinfo){Yi();let n=document.getElementById("userInfoDialog"),o=document.getElementById("btnUserInfoSubmit"),r=document.getElementById("tfUserInfoMessage");r.textContent=t.message,n.showModal(),o.removeEventListener("click",eo),o.addEventListener("click",eo,{once:!0})}else alert(t.message)}catch(t){alert(t)}}function Ji(){Mt.addEventListener("click",t=>{try{Jn.style.display="flex",Xn.style.display="none",Gn.showNew()}catch(n){throw console.error(n),alert(n),n}}),St.addEventListener("click",t=>{try{let n=so();if(!n)return;Jn.style.display="flex",Xn.style.display="none",Gn.showEdit(n)}catch(n){throw console.error(n),alert(n),n}}),oo.addEventListener("click",Vi),zi.addEventListener("click",async()=>{window.config.promptMode===h.PROMPTMODE_LIVE?Fe.interruptPrompt():window.config.promptMode===h.PROMPTMODE_BATCH?Pe.interruptPrompt():to.interruptPrompt()}),document.getElementById("btnWfBatchPromptHelp").addEventListener("click",async()=>{window.config.promptMode===h.PROMPTMODE_LIVE?Fe.showHelp():Pe.showHelp()}),At.addEventListener("click",async()=>{document.dispatchEvent(new CustomEvent("wfRefreshWorkflowEvent",{detail:{}}))}),document.addEventListener("wfRefreshWorkflowEvent",Gi),document.dispatchEvent(new CustomEvent("wfRefreshWorkflowEvent",{detail:{}})),document.addEventListener("verifyUserEvent",Xi)}function so(){return j}var j,P,Ee,Tt="";async function co(e){j=e,j!==null?(Tt==="ADMIN"&&(St.style.display="flex"),P=await ve.get_wf_params(j),Ee=await ve.get_wf_api(j)):(P=null,Ee=null,St.style.display="none")}lo.exports={initPanel:Ji,getWfname:so}});var go=A((oc,po)=>{"use strict";var Zi=X(),fo=ee(),tt=$(),x={comfyuiURL:"http://127.0.0.1:8188",setAILayer:tt.SETAILAYERCLOSE,wfDisplayType:"button",wfNameLength:12,pszoomMinsize:"512",pszoomMaxsize:"1024",outputZoom:tt.OUTPUT_ZOOM,showDetailLog:!1,outputPreview:!1,transEnable:!1,transBaiduAppID:"",transBaiduAppKey:"",promptMode:tt.PROMPTMODE_COMMON,livePromptSensitivity:2,batchPromptPause:2,batchPromptPreview:!0};window.config=x;var mo="pluginConfig.json";async function Qi(){try{let n=await(await(await fo.getDataFolder()).getEntry(mo)).read(),o=JSON.parse(n);Object.assign(x,o)}catch{console.log("\u4F7F\u7528\u9ED8\u8BA4\u53C2\u6570")}}async function Q(){try{await(await(await fo.getDataFolder()).createEntry(mo,{overwrite:!0})).write(JSON.stringify(x,null,2))}catch(e){console.error("Error saving config:",e)}}window.saveConfig=Q;function et(e,t){e.forEach(n=>{n.getAttribute("data-value")===t?n.removeAttribute("quiet"):n.setAttribute("quiet","")})}async function es(){let e=document.getElementById("btnSetDisplayTypePicker"),t=document.getElementById("btnSetDisplayTypeButton"),n=document.getElementById("btnSetAILayerClose"),o=document.getElementById("btnSetAILayerDel"),r=document.getElementById("btnSetAILayerOmit");document.getElementById("btnSetComfyuiURL").addEventListener("click",f=>{let m=L=>{window.showSingle(document.getElementById("settingsContainer"))},_=new CustomEvent("comfyuiConnectEvent",{detail:{data:{},callback:m}});document.dispatchEvent(_)});let a=[n,o,r];a.forEach(f=>{f.addEventListener("click",m=>{let _=m.currentTarget.getAttribute("data-value");_!==x.setAILayer&&(x.setAILayer=_,Q(),et([n,o,r],x.setAILayer),x.setAILayer===tt.SETAILAYERDEL&&alert("\u542F\u7528\u8BE5\u53C2\u6570\u65F6\uFF0CAI\u751F\u56FE\u540E\u4F1A\u5220\u9664\u5176\u5B83\u7531AI\u751F\u6210\u7684\u56FE\u5C42\uFF0C\u8BF7\u8C28\u614E\u64CD\u4F5C\uFF01"))})}),et(a,x.setAILayer);let i=document.getElementById("spSetMaxSize"),s=document.getElementById("spSetMinSize");i.querySelectorAll("sp-menu-item").forEach(f=>{f.value===x.pszoomMaxsize&&f.setAttribute("selected",!0)}),s.querySelectorAll("sp-menu-item").forEach(f=>{f.value===x.pszoomMinsize&&f.setAttribute("selected",!0)}),i.addEventListener("change",f=>{let m=f.currentTarget.value;x.pszoomMaxsize=m,Q()}),s.addEventListener("change",f=>{let m=f.currentTarget.value;x.pszoomMinsize=m,Q()});let c=document.getElementById("spSetOutputZoom");c.querySelectorAll("sp-menu-item").forEach(f=>{f.value===x.outputZoom&&f.setAttribute("selected",!0)}),c.addEventListener("change",f=>{let m=f.currentTarget.value;x.outputZoom=m,Q()});let l=document.getElementById("cbSetOutputPriview");l.checked=x.outputPreview,l.addEventListener("change",async f=>{try{let m=document.getElementById("cbSetOutputPriview").checked;await Zi.setOutputPreview(m),x.outputPreview=m,Q()}catch(m){throw console.error(m),alert(m),m}});let u=document.getElementById("cbSetTransEnable");u.checked=x.transEnable,u.addEventListener("change",async f=>{try{let m=document.getElementById("cbSetTransEnable").checked;x.transEnable=m,Q()}catch(m){throw console.error(m),alert(m),m}});let d=document.getElementById("cbSetTransBaiduAppID");d.value=x.transBaiduAppID,d.addEventListener("change",async f=>{try{let m=document.getElementById("cbSetTransBaiduAppID").value;x.transBaiduAppID=m,Q()}catch(m){throw console.error(m),alert(m),m}});let p=document.getElementById("cbSetTransBaiduAppKey");p.value=x.transBaiduAppKey,p.addEventListener("change",async f=>{try{let m=document.getElementById("cbSetTransBaiduAppKey").value;x.transBaiduAppKey=m,Q()}catch(m){throw console.error(m),alert(m),m}}),document.getElementById("btnSetTransBaiduHelp").addEventListener("click",f=>{document.getElementById("cbSetTransHelpBaiduDialog").showModal()});let g=document.getElementById("btnSetPromptCommon"),w=document.getElementById("btnSetPromptBatch"),E=document.getElementById("btnSetPromptLive"),y=[g,w,E];y.forEach(f=>{f.addEventListener("click",m=>{let _=m.currentTarget.getAttribute("data-value");_!==x.promptMode&&(x.promptMode=_,Q(),et(y,x.promptMode),document.dispatchEvent(new CustomEvent("wfRefreshWorkflowEvent",{detail:{}})))})}),et(y,x.promptMode)}po.exports={loadConfig:Qi,initPanel:es}});var vo=A((rc,Eo)=>{"use strict";var wo=X(),ts=$();function je(e,t=!0){let n=document.getElementById("divTestInfo");n.innerHTML=`${e}`,t?n.style.color="#ff5555":n.style.color="lightgreen"}async function ns(e,t){let n=document.getElementById("btnConnect"),o=document.getElementById("tfComfyuiURL"),r=o.value.trim();try{r=r.match(/^https?:\/\//)?r:`http://${r}`,r=r.replace(/\/+$/,""),new URL(r)}catch(s){je(`URL\u4E0D\u5408\u6CD5:${r}`),console.log(s);return}je(`\u5C1D\u8BD5\u8FDE\u63A5\u5230:${r}`),n.disabled=!0;try{await wo.test_comfyui(r)}catch(s){je("\u8FDE\u63A5COMFYUI\u5931\u8D25<br>\u8BF7\u590D\u5236\u4E0A\u9762\u7684\u5730\u5740\u5230\u6D4F\u89C8\u5668\uFF0C\u4EE5\u68C0\u67E5COMFYUI\u662F\u5426\u542F\u52A8"),console.log(s),n.disabled=!1;return}let[a,i]=await wo.test_comfyui_jinn(r);if(a!==!0){je("COMFYUI\u5DF2\u8FDE\u63A5,\u4F46\u662F\u6CA1\u6709\u5B89\u88C5comfyui_jinn\u63D2\u4EF6<br>\u8BF7\u5C06\u5B89\u88C5\u5305\u4E2D\u7684comfyui_jinn_ps\u76EE\u5F55\u590D\u5236\u5230COMFYUI\u4E0B\u7684custom_nodes\u76EE\u5F55\uFF0C\u91CD\u542FCOMFYUI\u670D\u52A1\u518D\u8BD5"),n.disabled=!1;return}window.config.comfyuiURL=r,window.saveConfig(),o.value=window.config.comfyuiURL,je("\u8FDE\u63A5COMFYUI\u6210\u529F!",!1),n.disabled=!1;try{await e(t)}catch(s){throw console.error(s),alert(s),s}}var ho=null,yo=null;function os(e,t){let n=document.getElementById("connContainer");window.showSingle(n);let o=document.getElementById("divTestInfo");o.innerHTML="";let r=document.getElementById("tfComfyuiURL");r.value=config.comfyuiURL,ho=e,yo=t}document.addEventListener("comfyuiConnectEvent",e=>{let{data:t,callback:n}=e.detail;os(n,t)});async function rs(){document.getElementById("connContainer").innerHTML.trim()===""&&await window.loadHtml("connContainer","html/connect.html");let t=document.getElementById("btnResetComfyuiURL"),n=document.getElementById("btnConnect");t.addEventListener("click",()=>{tfComfyuiURL.value=ts.DEFAULT_COMFYUI_URL}),n.addEventListener("click",async o=>{await ns(ho,yo)})}Eo.exports={initPanel:rs}});var _o=A(()=>{var{entrypoints:as}=B("uxp");typeof window.alert!="function"&&(window.alert=async function(e=""){let t=document.getElementById("alertDialog");t||(t=document.createElement("dialog"),t.innerHTML=`
      <sp-body>${e}</sp-body>
      <div style="width:100%;display: flex; justify-content:center;">
        <sp-action-button id="alertDialogOK" >\u786E\u5B9A</sp-action-button>
      </div>
      `,document.body.appendChild(t),t.querySelector("#alertDialogOK").addEventListener("click",()=>{t.close(),resolve(!0)})),t.querySelector("sp-body").textContent=e,t.style.width="350px",t.id="alertDialog",t.showModal()});typeof window.confirm!="function"&&(window.confirm=async function(e="\u786E\u5B9A\u8981\u7EE7\u7EED\u5417\uFF1F"){let t=document.getElementById("confirmDialog");return t||(t=document.createElement("dialog"),t.innerHTML=`
          <sp-body  style="width=100%;">${e}</sp-body>
          <div style="width:100%;display: flex; justify-content:center;">
            <sp-action-button id="confirmDialogCancel">\u53D6\u6D88</sp-action-button>
            <sp-action-button id="confirmDialogOK" >\u786E\u5B9A</sp-action-button>
          </div>
      `,t.id="confirmDialog",t.style.width="350px",document.body.appendChild(t)),t.querySelector("sp-body").textContent=e,new Promise(n=>{t.querySelector("#confirmDialogOK").addEventListener("click",()=>{t.close(),n(!0)}),t.querySelector("#confirmDialogCancel").addEventListener("click",()=>{t.close(),n(!1)}),t.showModal()})});as.setup({panels:{"jinn_ps_ai.panel_main":{show(e){},create(){},hide(){},destroy(){},menuItems:[],invokeMenu(e){}}}});window.loadHtml=async function(t,n){try{let r=await(await fetch(n)).text();document.getElementById(t).innerHTML=r}catch(o){throw console.log(`\u52A0\u8F7D${n}\u5931\u8D25`,o),o}};window.loadCSS=function(t){var n=document.createElement("link");n.rel="stylesheet",n.type="text/css",n.href=t,document.head.appendChild(n)};window.showSingle=function(e){Array.from(ds.children).forEach(t=>{t===e?t.style.display="flex":t.style.display="none"})};async function is(){Pt.children.length===0&&(await window.loadHtml("settingsContainer","html/settings.html"),await bo.initPanel()),Pt.style.display!=="none"?window.showSingle(fs):window.showSingle(Pt)}document.body.innerHTML=`
  <div id="wfPromptContainer">
    <div id="wfMainToolbar" style="display: flex; align-items: center;  justify-content:flex-end; ">
      <div style="display: flex; align-items: center;  justify-content: flex-end;">
        <sp-action-button id="btnWfBatchPromptHelp" title="\u5E2E\u52A9" style="display: none;" quiet><sp-icon name="ui:HelpSmall" size="s" slot="icon"></sp-icon></sp-action-button>

        <sp-action-button id="btnEditWorkflow" title="\u4FEE\u6539\u5DE5\u4F5C\u6D41" style="display: none;" size="s" quiet>
          <div slot="icon" style="fill: currentColor"><svg viewBox="0 0 36 36" style="width: 18px; height: 18px;"><path d="M32 9l-6-6-21 21-3 9 9-3L32 9z" /></svg></div>
        </sp-action-button>
        <sp-action-button id="btnAddWorkflow" title="\u6DFB\u52A0\u5DE5\u4F5C\u6D41" size="s" style="display: none;" quiet>
          <div slot="icon" style="fill: currentColor"><svg viewBox="0 0 36 36" style="width: 18px; height: 18px;"><path d="M16 2v14H2v4h14v14h4V20h14v-4H20V2h-4z" fill="currentColor" /></svg></div>
        </sp-action-button>
        <sp-action-button id="btnWfRefresh" title="\u5237\u65B0" size="s" style="display: none;" quiet>
          <div slot="icon" style="fill: currentColor">
            <svg viewBox="0 0 36 36" style="width: 18px; height: 18px;"><path d="M18 4a14 14 0 1 0 13.86 16h-3.02a11 11 0 1 1-2.68-9.29l-3.46 3.47H32V4l-3.92 3.92A13.95 13.95 0 0 0 18 4z" fill="currentColor"/></svg>
          </div>
        </sp-action-button>
      </div>
    </div>
    
    <sp-divider size="medium" style="margin-top: 0px; margin-top: 5px;"></sp-divider>
    <div id="wfButtonContainer" style="display: flex;flex-wrap: wrap; overflow-y: auto;"></div>
    <sp-divider size="medium" style="margin-top: 2px; margin-bottom: 0px;"></sp-divider>

    <div id="wfParamContainer" class="wfParamContainer">
    </div>
    
    <div id="buttonContainer" style="display: flex;flex-direction: row;  justify-content: space-between; align-items: center; width: 100%;margin-top: 5px;">
      <div style="width: 30%; display: flex; justify-content:flex-start;">
        <sp-action-button id="btnInterrupt" title="\u4E2D\u65AD"  size="xxs" style="display: none; justify-content: flex-end;margin-right: 0px;" variant="warning" quiet>\u2715</sp-action-button>
      </div>
      
      <sp-button id="btnPrompt" style="width: 30%;  position: absolute;left: 50%;transform: translateX(-50%);">\u751F\u6210</sp-button>
      

      <div style="width: 30%;height:100%; display: flex; justify-content:flex-end;">
        <sp-label id="lSimpleLog" style="display: none; justify-content: flex-end;"></sp-label>
        <sp-action-button id="btnSettings" title="\u8BBE\u7F6E" style=" justify-content: flex-end; margin-top: auto" quiet>
          <div slot="icon" style="fill: currentColor">
            <svg viewBox="8 8 16 16" style="width: 18px; height: 18px;"><path fill-rule="evenodd" clip-rule="evenodd" d="M21.6809 16.2095C21.6809 16.5068 21.8334 16.772 22.0878 16.9206C23.1918 17.5625 23.5706 18.9877 22.9343 20.0987C22.6239 20.6386 22.1235 21.0244 21.5246 21.1855C20.9294 21.3427 20.307 21.2618 19.7725 20.9513C19.5197 20.8036 19.2186 20.8036 18.9657 20.9497C18.709 21.0968 18.5558 21.3637 18.5558 21.6616C18.5558 22.9446 17.5179 23.9894 16.242 23.9894C14.9653 23.9894 13.9275 22.9446 13.9275 21.6616C13.9275 21.3628 13.7742 21.0968 13.5176 20.949C13.2647 20.8036 12.9636 20.8036 12.7123 20.9513C12.1771 21.2618 11.5539 21.3442 10.9572 21.1847C10.3589 21.0237 9.85945 20.6379 9.54981 20.0987C8.91342 18.9877 9.29308 17.5617 10.3963 16.9199C10.6507 16.7728 10.8024 16.5068 10.8024 16.2095C10.8024 15.9123 10.6507 15.6463 10.3963 15.4985C9.29308 14.8582 8.91342 13.4329 9.54981 12.3212C9.85945 11.7812 10.3589 11.3954 10.958 11.2343C11.5554 11.074 12.1771 11.1581 12.7123 11.4685C12.9643 11.6163 13.2655 11.6148 13.5176 11.4701C13.7742 11.3222 13.9275 11.0561 13.9275 10.7574C13.9275 9.47452 14.9653 8.42969 16.242 8.42969C17.5179 8.42969 18.5558 9.47452 18.5558 10.7574C18.5558 11.0554 18.709 11.3222 18.9657 11.4692C19.2193 11.6163 19.5205 11.6163 19.7725 11.4685C20.3063 11.1581 20.9285 11.0756 21.5246 11.2335C22.1235 11.3946 22.6239 11.7805 22.9343 12.3204C23.5706 13.4321 23.1918 14.8574 22.0885 15.4992C21.8334 15.647 21.6809 15.9123 21.6809 16.2095ZM16.2419 18.5434C14.955 18.5434 13.9079 17.4962 13.9079 16.2094C13.9079 14.9226 14.955 13.8755 16.2419 13.8755C17.5287 13.8755 18.5758 14.9226 18.5758 16.2094C18.5758 17.4962 17.5287 18.5434 16.2419 18.5434Z"fill="#7D7D7D"></path> </svg>
          </div>
        </sp-action-button>
      </div>
      

    </div>

    <div id='singleContainer' style="margin-top: 15px;">
      <div id="logContainer" style="display: flex;flex-direction: column;width: 100%;"></div>
      <div id="settingsContainer" style="display: none;flex-direction: column; overflow-y: auto;"></div>
      <div id="connContainer" style="display: none;"></div>
    </div>
    <div style="display: none; flex-direction: column; height: 200px; overflow: hidden;">
      <img id="wfPreviewImage" src="" alt="Preview" style="width: auto; height: auto; max-width: 100%; max-height: 100%; object-fit: contain;" >
    </div>
  </div>
  
  
  <div id="wfManageContainer" style="display: none;"></div>

`;var ss=uo(),cs=vt(),ls=V(),bo=go(),us=vo(),ds=document.getElementById("singleContainer"),fs=document.getElementById("logContainer"),Pt=document.getElementById("settingsContainer");document.getElementById("btnSettings").addEventListener("click",is);document.addEventListener("DOMContentLoaded",async()=>{try{await bo.loadConfig(),await window.loadHtml("logContainer","html/logger.html"),ls.initPanel(),us.initPanel(),ss.initPanel(),cs.initPanel()}catch(e){throw console.log(e),e}})});_o();})();
